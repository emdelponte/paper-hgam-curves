<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Emerson M. Del Ponte">

<title>Curve-based + traditional analysis of Bipolaris epidemics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap-0e8d46d49afdcf27eef7cf8bb79e73b3.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="header-section-number">1</span> Overview</a></li>
  <li><a href="#data-and-design" id="toc-data-and-design" class="nav-link" data-scroll-target="#data-and-design"><span class="header-section-number">2</span> Data and design</a></li>
  <li><a href="#methods-equations" id="toc-methods-equations" class="nav-link" data-scroll-target="#methods-equations"><span class="header-section-number">3</span> Methods (equations)</a>
  <ul class="collapse">
  <li><a href="#response-scale-and-beta-regression-constraints" id="toc-response-scale-and-beta-regression-constraints" class="nav-link" data-scroll-target="#response-scale-and-beta-regression-constraints"><span class="header-section-number">3.1</span> Response scale and beta regression constraints</a></li>
  <li><a href="#audpc" id="toc-audpc" class="nav-link" data-scroll-target="#audpc"><span class="header-section-number">3.2</span> AUDPC</a></li>
  <li><a href="#t_50" id="toc-t_50" class="nav-link" data-scroll-target="#t_50"><span class="header-section-number">3.3</span> <span class="math inline">\(T_{50}\)</span></a></li>
  <li><a href="#logistic-rate-optional-scalar" id="toc-logistic-rate-optional-scalar" class="nav-link" data-scroll-target="#logistic-rate-optional-scalar"><span class="header-section-number">3.4</span> Logistic rate (optional scalar)</a></li>
  <li><a href="#functional-distance-between-curves" id="toc-functional-distance-between-curves" class="nav-link" data-scroll-target="#functional-distance-between-curves"><span class="header-section-number">3.5</span> Functional distance between curves</a></li>
  </ul></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup"><span class="header-section-number">4</span> Setup</a>
  <ul class="collapse">
  <li><a href="#packages" id="toc-packages" class="nav-link" data-scroll-target="#packages"><span class="header-section-number">4.1</span> Packages</a></li>
  <li><a href="#user-settings" id="toc-user-settings" class="nav-link" data-scroll-target="#user-settings"><span class="header-section-number">4.2</span> User settings</a></li>
  </ul></li>
  <li><a href="#read-and-prepare-data" id="toc-read-and-prepare-data" class="nav-link" data-scroll-target="#read-and-prepare-data"><span class="header-section-number">5</span> Read and prepare data</a>
  <ul class="collapse">
  <li><a href="#optional-join-hybrid-resistance-class" id="toc-optional-join-hybrid-resistance-class" class="nav-link" data-scroll-target="#optional-join-hybrid-resistance-class"><span class="header-section-number">5.1</span> Optional: join hybrid resistance class</a></li>
  </ul></li>
  <li><a href="#helper-functions-scalars" id="toc-helper-functions-scalars" class="nav-link" data-scroll-target="#helper-functions-scalars"><span class="header-section-number">6</span> Helper functions (scalars)</a></li>
  <li><a href="#per-curve-scalar-metrics-audpc-final-t50-r_norm" id="toc-per-curve-scalar-metrics-audpc-final-t50-r_norm" class="nav-link" data-scroll-target="#per-curve-scalar-metrics-audpc-final-t50-r_norm"><span class="header-section-number">7</span> Per-curve scalar metrics (AUDPC, final, T50, r_norm)</a></li>
  <li><a href="#hierarchical-beta-gam-hgam-for-smoothing-and-adjustment" id="toc-hierarchical-beta-gam-hgam-for-smoothing-and-adjustment" class="nav-link" data-scroll-target="#hierarchical-beta-gam-hgam-for-smoothing-and-adjustment"><span class="header-section-number">8</span> Hierarchical beta-GAM (HGAM) for smoothing and adjustment</a>
  <ul class="collapse">
  <li><a href="#diagnostics-observed-vs-fitted-and-residuals" id="toc-diagnostics-observed-vs-fitted-and-residuals" class="nav-link" data-scroll-target="#diagnostics-observed-vs-fitted-and-residuals"><span class="header-section-number">8.1</span> Diagnostics (observed vs fitted and residuals)</a></li>
  </ul></li>
  <li><a href="#environment-adjusted-hybrid-mean-curves" id="toc-environment-adjusted-hybrid-mean-curves" class="nav-link" data-scroll-target="#environment-adjusted-hybrid-mean-curves"><span class="header-section-number">9</span> Environment-adjusted hybrid mean curves</a></li>
  <li><a href="#functional-distance-among-hybrids-clustering" id="toc-functional-distance-among-hybrids-clustering" class="nav-link" data-scroll-target="#functional-distance-among-hybrids-clustering"><span class="header-section-number">10</span> Functional distance among hybrids + clustering</a>
  <ul class="collapse">
  <li><a href="#utility-shorten-hybrid-labels" id="toc-utility-shorten-hybrid-labels" class="nav-link" data-scroll-target="#utility-shorten-hybrid-labels"><span class="header-section-number">10.1</span> Utility: shorten hybrid labels</a></li>
  <li><a href="#build-distance-matrix-and-cluster" id="toc-build-distance-matrix-and-cluster" class="nav-link" data-scroll-target="#build-distance-matrix-and-cluster"><span class="header-section-number">10.2</span> Build distance matrix and cluster</a></li>
  <li><a href="#figure-mean-curves-by-phenotype-dendrogram" id="toc-figure-mean-curves-by-phenotype-dendrogram" class="nav-link" data-scroll-target="#figure-mean-curves-by-phenotype-dendrogram"><span class="header-section-number">10.3</span> Figure: mean curves by phenotype + dendrogram</a></li>
  </ul></li>
  <li><a href="#scalar-equivalent-but-trajectory-distinct-curves" id="toc-scalar-equivalent-but-trajectory-distinct-curves" class="nav-link" data-scroll-target="#scalar-equivalent-but-trajectory-distinct-curves"><span class="header-section-number">11</span> Scalar-equivalent but trajectory-distinct curves</a>
  <ul class="collapse">
  <li><a href="#select-candidate-pairs-scalar-nearest-and-maximize-functional-distance" id="toc-select-candidate-pairs-scalar-nearest-and-maximize-functional-distance" class="nav-link" data-scroll-target="#select-candidate-pairs-scalar-nearest-and-maximize-functional-distance"><span class="header-section-number">11.1</span> Select candidate pairs (scalar-nearest) and maximize functional distance</a></li>
  <li><a href="#plot-the-two-raw-curves" id="toc-plot-the-two-raw-curves" class="nav-link" data-scroll-target="#plot-the-two-raw-curves"><span class="header-section-number">11.2</span> Plot the two raw curves</a></li>
  <li><a href="#difference-function-deltat-and-its-integral-contribution" id="toc-difference-function-deltat-and-its-integral-contribution" class="nav-link" data-scroll-target="#difference-function-deltat-and-its-integral-contribution"><span class="header-section-number">11.3</span> Difference function <span class="math inline">\(\Delta(t)\)</span> and its integral contribution</a></li>
  </ul></li>
  <li><a href="#traditional-audpc-analysis-mixed-model-tukey" id="toc-traditional-audpc-analysis-mixed-model-tukey" class="nav-link" data-scroll-target="#traditional-audpc-analysis-mixed-model-tukey"><span class="header-section-number">12</span> Traditional AUDPC analysis (mixed model + Tukey)</a>
  <ul class="collapse">
  <li><a href="#compute-audpc-and-fit-model" id="toc-compute-audpc-and-fit-model" class="nav-link" data-scroll-target="#compute-audpc-and-fit-model"><span class="header-section-number">12.1</span> Compute AUDPC and fit model</a></li>
  <li><a href="#model-checks-dharma" id="toc-model-checks-dharma" class="nav-link" data-scroll-target="#model-checks-dharma"><span class="header-section-number">12.2</span> Model checks (DHARMa)</a></li>
  <li><a href="#hybrid-means-tukey-letters" id="toc-hybrid-means-tukey-letters" class="nav-link" data-scroll-target="#hybrid-means-tukey-letters"><span class="header-section-number">12.3</span> Hybrid means + Tukey letters</a></li>
  <li><a href="#merge-tukey-groups-with-functional-clusters" id="toc-merge-tukey-groups-with-functional-clusters" class="nav-link" data-scroll-target="#merge-tukey-groups-with-functional-clusters"><span class="header-section-number">12.4</span> Merge Tukey groups with functional clusters</a></li>
  <li><a href="#plot-audpc-means-ci-tukey-letters-colored-by-functional-phenotype" id="toc-plot-audpc-means-ci-tukey-letters-colored-by-functional-phenotype" class="nav-link" data-scroll-target="#plot-audpc-means-ci-tukey-letters-colored-by-functional-phenotype"><span class="header-section-number">12.5</span> Plot: AUDPC means, CI, Tukey letters (colored by functional phenotype)</a></li>
  </ul></li>
  <li><a href="#optional-run-compare_curves-from-r4pde" id="toc-optional-run-compare_curves-from-r4pde" class="nav-link" data-scroll-target="#optional-run-compare_curves-from-r4pde"><span class="header-section-number">13</span> Optional: run <code>compare_curves()</code> from <code>{r4pde}</code></a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info"><span class="header-section-number">14</span> Session info</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Curve-based + traditional analysis of Bipolaris epidemics</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
<p class="subtitle lead">Functional (beta-GAM/HGAM) smoothing, functional distances, and AUDPC mixed-model comparison</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Emerson M. Del Ponte </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="overview" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="overview"><span class="header-section-number">1</span> Overview</h2>
<p>This document implements two complementary analyses for Bipolaris leaf spot epidemics assessed in maize hybrids:</p>
<p><strong>A. Functional (curve-based) analysis</strong></p>
<ol type="1">
<li><strong>Beta-GAM (HGAM)</strong> to smooth severity trajectories and adjust for environment.</li>
<li><strong>Environment-adjusted hybrid mean curves</strong>.</li>
<li><strong>Functional distance</strong> among hybrids and <strong>hierarchical clustering</strong> (dendrogram + curve panel).</li>
<li><em>“Killer pair” figure:</em> two curves that are <strong>scalar-equivalent</strong> (AUDPC + final severity) but <strong>trajectory-distinct</strong>, with the difference function <span class="math inline">\(\Delta(t)\)</span> and its contribution to the <span class="math inline">\(L^2\)</span> distance.</li>
</ol>
<p><strong>B. Traditional (scalar) analysis</strong></p>
<ol type="1">
<li><strong>AUDPC</strong> per hybrid within environment (as available in the dataset design).</li>
<li>Mixed-model ANOVA and <strong>Tukey</strong> letter groups (via <code>emmeans::cld()</code>).</li>
<li>Merge <strong>Tukey groups</strong> with <strong>functional clusters</strong> for side-by-side comparison.</li>
</ol>
<hr>
</section>
<section id="data-and-design" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="data-and-design"><span class="header-section-number">2</span> Data and design</h2>
<ul>
<li><strong>Input file:</strong> <code>maize_bipolaris.csv</code></li>
<li><strong>Response:</strong> Bipolaris severity (%) converted to proportion</li>
<li><strong>Time scale:</strong> DAE (days after emergence)</li>
<li><strong>Design columns:</strong> <code>Ambiente</code> (environment), <code>Hibrido</code> (hybrid), <code>Parcela</code> (plot/block)</li>
</ul>
<hr>
</section>
<section id="methods-equations" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="methods-equations"><span class="header-section-number">3</span> Methods (equations)</h2>
<section id="response-scale-and-beta-regression-constraints" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="response-scale-and-beta-regression-constraints"><span class="header-section-number">3.1</span> Response scale and beta regression constraints</h3>
<p>The raw severity in percent is converted to a proportion:</p>
<p><span class="math display">\[
y = \frac{\text{severity (\%)}}{100}.
\]</span></p>
<p>Beta regression requires <span class="math inline">\(0 &lt; y &lt; 1\)</span>, so we apply a small boundary adjustment:</p>
<p><span class="math display">\[
y^* = \min\left(\max(y, \varepsilon), 1-\varepsilon\right).
\]</span></p>
</section>
<section id="audpc" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="audpc"><span class="header-section-number">3.2</span> AUDPC</h3>
<p>AUDPC is approximated using the trapezoidal rule for a curve <span class="math inline">\(y(t)\)</span> observed at times <span class="math inline">\(t_1 &lt; \dots &lt; t_m\)</span>:</p>
<p><span class="math display">\[
\mathrm{AUDPC} \approx \sum_{i=1}^{m-1} \frac{(y_i + y_{i+1})}{2}\,(t_{i+1}-t_i).
\]</span></p>
</section>
<section id="t_50" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="t_50"><span class="header-section-number">3.3</span> <span class="math inline">\(T_{50}\)</span></h3>
<p><span class="math inline">\(T_{50}\)</span> is computed as the time when the curve reaches half its observed maximum:</p>
<p><span class="math display">\[
T_{50}=\min\{t:\; y(t)\ge 0.5\,y_{\max}\},
\]</span></p>
<p>estimated by linear interpolation between adjacent observation times.</p>
</section>
<section id="logistic-rate-optional-scalar" class="level3" data-number="3.4">
<h3 data-number="3.4" class="anchored" data-anchor-id="logistic-rate-optional-scalar"><span class="header-section-number">3.4</span> Logistic rate (optional scalar)</h3>
<p>We fit a logistic curve to each epidemic trajectory:</p>
<p><span class="math display">\[
y(t)=\frac{K}{1 + \exp\{-r(t-t_0)\}},
\]</span></p>
<p>and report a duration-normalized rate:</p>
<p><span class="math display">\[
r_{\mathrm{norm}} = r\,(t_{\max}-t_{\min}).
\]</span></p>
</section>
<section id="functional-distance-between-curves" class="level3" data-number="3.5">
<h3 data-number="3.5" class="anchored" data-anchor-id="functional-distance-between-curves"><span class="header-section-number">3.5</span> Functional distance between curves</h3>
<p>For two smooth mean curves <span class="math inline">\(\mu_a(t)\)</span> and <span class="math inline">\(\mu_b(t)\)</span>, the <span class="math inline">\(L^2\)</span> distance is:</p>
<p><span class="math display">\[
d_F(a,b) = \left(\int \big[\mu_a(t)-\mu_b(t)\big]^2\,dt\right)^{1/2}.
\]</span></p>
<p>On an evenly spaced grid with step <span class="math inline">\(\Delta t\)</span>, we approximate:</p>
<p><span class="math display">\[
d_F(a,b)\approx \left(\sum_{j} [\mu_a(t_j)-\mu_b(t_j)]^2\,\Delta t\right)^{1/2}.
\]</span></p>
<hr>
</section>
</section>
<section id="setup" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="setup"><span class="header-section-number">4</span> Setup</h2>
<section id="packages" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="packages"><span class="header-section-number">4.1</span> Packages</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"readr"</span>,<span class="st">"dplyr"</span>,<span class="st">"tidyr"</span>,<span class="st">"tibble"</span>,<span class="st">"purrr"</span>,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ggplot2"</span>,<span class="st">"mgcv"</span>,<span class="st">"pracma"</span>,<span class="st">"pheatmap"</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"lme4"</span>,<span class="st">"lmerTest"</span>,<span class="st">"emmeans"</span>,<span class="st">"multcompView"</span>,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"cowplot"</span>,<span class="st">"ggrepel"</span>,<span class="st">"ggdendro"</span>,<span class="st">"patchwork"</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"DHARMa"</span>,<span class="st">"stringr"</span>,<span class="st">"glue"</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>to_install <span class="ot">&lt;-</span> pkgs[<span class="sc">!</span>pkgs <span class="sc">%in%</span> <span class="fu">rownames</span>(<span class="fu">installed.packages</span>())]</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(to_install) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">install.packages</span>(to_install, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pracma)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pheatmap)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmerTest)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emmeans)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(multcompView)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggrepel)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggdendro)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DHARMa)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_classic</span>(<span class="at">base_size =</span> <span class="dv">14</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="user-settings" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="user-settings"><span class="header-section-number">4.2</span> User settings</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>file_path  <span class="ot">&lt;-</span> <span class="st">"maize_bipolaris.csv"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Data window (as in your script)</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>dae_min <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>dae_max <span class="ot">&lt;-</span> <span class="dv">116</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Minimum number of assessments per curve_id to retain</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: your header comment said 8, but the code used 5. Keep as a parameter here.</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>min_assess <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Beta boundary adjustment</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>eps <span class="ot">&lt;-</span> <span class="fl">1e-4</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Functional clustering</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>k_clusters <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Time grid for functional distances / plots</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>grid_n <span class="ot">&lt;-</span> <span class="dv">140</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Reference environment used for "environment-adjusted" mean curves</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co"># (your original code used the first level; keep that default)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
</section>
<section id="read-and-prepare-data" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="read-and-prepare-data"><span class="header-section-number">5</span> Read and prepare data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>dat0 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>dat0 <span class="ot">&lt;-</span> dat0 <span class="sc">|&gt;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(DAE <span class="sc">&lt;</span> dae_max, DAE <span class="sc">&gt;</span> dae_min)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Expected columns: Ambiente, Hibrido, Parcela, DAE, Bipolaris</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat0 <span class="sc">%&gt;%</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ambiente  =</span> <span class="fu">factor</span>(Ambiente),</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">Hibrido   =</span> <span class="fu">factor</span>(Hibrido),</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">DAE       =</span> <span class="fu">as.numeric</span>(DAE),</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">bipolaris =</span> <span class="fu">as.numeric</span>(Bipolaris) <span class="sc">/</span> <span class="dv">100</span>  <span class="co"># % -&gt; proportion</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Ambiente), <span class="sc">!</span><span class="fu">is.na</span>(Hibrido), </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span><span class="fu">is.na</span>(DAE), <span class="sc">!</span><span class="fu">is.na</span>(bipolaris)) <span class="sc">%&gt;%</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">curve_id =</span> <span class="fu">interaction</span>(Ambiente, Hibrido), <span class="at">drop =</span> <span class="cn">TRUE</span>, <span class="at">sep =</span> <span class="st">"|"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(curve_id, DAE)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Retain curves with at least min_assess time points</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>curve_n <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">count</span>(curve_id, <span class="at">name =</span> <span class="st">"n_assess"</span>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(curve_n, <span class="at">by =</span> <span class="st">"curve_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_assess <span class="sc">&gt;=</span> min_assess) <span class="sc">%&gt;%</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>n_assess)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Beta regression requires 0 &lt; y &lt; 1</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(bipolaris, eps), <span class="dv">1</span> <span class="sc">-</span> eps))</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Rows: "</span>, <span class="fu">nrow</span>(dat),</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">" | curves: "</span>, <span class="fu">n_distinct</span>(dat<span class="sc">$</span>curve_id),</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">" | hybrids: "</span>, <span class="fu">n_distinct</span>(dat<span class="sc">$</span>Hibrido),</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">" | envs: "</span>, <span class="fu">n_distinct</span>(dat<span class="sc">$</span>Ambiente))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="optional-join-hybrid-resistance-class" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="optional-join-hybrid-resistance-class"><span class="header-section-number">5.1</span> Optional: join hybrid resistance class</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>bipolaris_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Hibrido =</span> <span class="fu">c</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AG 8701 PRO4"</span>,<span class="st">"AG 8707 PRO4"</span>,<span class="st">"AG 9021 PRO3"</span>,<span class="st">"AS 1757 PRO4"</span>,<span class="st">"AS 1868 PRO4"</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AS 1955 PRO4"</span>,<span class="st">"B 2801 PWU"</span>,<span class="st">"CRWX03"</span>,<span class="st">"DKB 230 PRO3"</span>,<span class="st">"DKB 242 PRO4"</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MG 616 PWU"</span>,<span class="st">"P 3016 VYHR"</span>,<span class="st">"T 1503 PWU"</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">resistance =</span> <span class="fu">c</span>(<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"R"</span>,<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"R"</span>,<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"R"</span>,<span class="st">"MR"</span>),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(bipolaris_df, <span class="at">by =</span> <span class="st">"Hibrido"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y          =</span> <span class="fu">as.numeric</span>(y),</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">DAE        =</span> <span class="fu">as.numeric</span>(DAE),</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ambiente   =</span> <span class="fu">factor</span>(Ambiente),</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">Hibrido    =</span> <span class="fu">factor</span>(Hibrido),</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">curve_id   =</span> <span class="fu">factor</span>(curve_id),</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">resistance =</span> <span class="fu">factor</span>(resistance)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   885 obs. of  6 variables:
 $ y         : num  0.0001 0.03 0.035 0.035 0.065 0.15 0.2 0.25 0.25 0.25 ...
 $ DAE       : num  49 54 62 68 78 84 90 97 103 109 ...
 $ Ambiente  : Factor w/ 6 levels "2024_Arapoti_Cedo",..: 1 1 1 1 1 1 1 1 1 1 ...
 $ Hibrido   : Factor w/ 13 levels "AG 8701 PRO4",..: 1 1 1 1 1 1 1 1 1 1 ...
 $ curve_id  : Factor w/ 74 levels "2024_Arapoti_Cedo.AG 8701 PRO4",..: 1 1 1 1 1 1 1 1 1 1 ...
 $ resistance: Factor w/ 2 levels "MR","R": 1 1 1 1 1 1 1 1 1 1 ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ambiente) <span class="sc">|&gt;</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(DAE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 71 × 3
# Groups:   Ambiente [6]
   Ambiente            DAE     n
   &lt;fct&gt;             &lt;dbl&gt; &lt;int&gt;
 1 2024_Arapoti_Cedo    49    11
 2 2024_Arapoti_Cedo    54    11
 3 2024_Arapoti_Cedo    62    11
 4 2024_Arapoti_Cedo    68    11
 5 2024_Arapoti_Cedo    78    11
 6 2024_Arapoti_Cedo    84    11
 7 2024_Arapoti_Cedo    90    11
 8 2024_Arapoti_Cedo    97    11
 9 2024_Arapoti_Cedo   103    11
10 2024_Arapoti_Cedo   109    11
# ℹ 61 more rows</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="helper-functions-scalars" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="helper-functions-scalars"><span class="header-section-number">6</span> Helper functions (scalars)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># T50: time when y reaches 0.5*ymax (linear interpolation)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>t50_interp <span class="ot">&lt;-</span> <span class="cf">function</span>(time, y){</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  o <span class="ot">&lt;-</span> <span class="fu">order</span>(time)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> time[o]; y <span class="ot">&lt;-</span> y[o]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  ymax <span class="ot">&lt;-</span> <span class="fu">max</span>(y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  thr  <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> ymax</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">all</span>(y <span class="sc">&lt;</span> thr, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="fu">return</span>(<span class="cn">NA_real_</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> <span class="fu">which</span>(y <span class="sc">&gt;=</span> thr)[<span class="dv">1</span>]</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(k <span class="sc">==</span> <span class="dv">1</span>) <span class="fu">return</span>(time[<span class="dv">1</span>])</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  t1 <span class="ot">&lt;-</span> time[k<span class="dv">-1</span>]; t2 <span class="ot">&lt;-</span> time[k]</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> y[k<span class="dv">-1</span>];    y2 <span class="ot">&lt;-</span> y[k]</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">isTRUE</span>(<span class="fu">all.equal</span>(y2, y1))) <span class="fu">return</span>(t2)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  t1 <span class="sc">+</span> (thr <span class="sc">-</span> y1) <span class="sc">*</span> (t2 <span class="sc">-</span> t1) <span class="sc">/</span> (y2 <span class="sc">-</span> y1)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Logistic fit: y(t)=K/(1+exp(-r(t-t0))) and r_norm = r*(tmax-tmin)</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>logistic_fit_rate <span class="ot">&lt;-</span> <span class="cf">function</span>(time, y){</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  o <span class="ot">&lt;-</span> <span class="fu">order</span>(time)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> time[o]; y <span class="ot">&lt;-</span> y[o]</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(y, <span class="fl">1e-4</span>), <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1e-4</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  K0  <span class="ot">&lt;-</span> <span class="fu">max</span>(y)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  d   <span class="ot">&lt;-</span> <span class="fu">diff</span>(y)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  t00 <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="fu">length</span>(d) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">any</span>(<span class="fu">is.finite</span>(d))) time[<span class="fu">which.max</span>(d) <span class="sc">+</span> <span class="dv">1</span>] <span class="cf">else</span> <span class="fu">median</span>(time)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.na</span>(t00)) t00 <span class="ot">&lt;-</span> <span class="fu">median</span>(time)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  r0  <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nls</span>(</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>      y <span class="sc">~</span> K <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>r <span class="sc">*</span> (time <span class="sc">-</span> t0))),</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">start =</span> <span class="fu">list</span>(<span class="at">K =</span> K0, <span class="at">r =</span> r0, <span class="at">t0 =</span> t00),</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">control =</span> <span class="fu">nls.control</span>(<span class="at">maxiter =</span> <span class="dv">200</span>, <span class="at">warnOnly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(f)) <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">r =</span> <span class="cn">NA_real_</span>, <span class="at">K =</span> <span class="cn">NA_real_</span>, <span class="at">t0 =</span> <span class="cn">NA_real_</span>, <span class="at">r_norm =</span> <span class="cn">NA_real_</span>))</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>  co  <span class="ot">&lt;-</span> <span class="fu">coef</span>(f)</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>  r   <span class="ot">&lt;-</span> <span class="fu">unname</span>(co[<span class="st">"r"</span>])</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>  K   <span class="ot">&lt;-</span> <span class="fu">unname</span>(co[<span class="st">"K"</span>])</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>  t0  <span class="ot">&lt;-</span> <span class="fu">unname</span>(co[<span class="st">"t0"</span>])</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>  dur <span class="ot">&lt;-</span> <span class="fu">max</span>(time) <span class="sc">-</span> <span class="fu">min</span>(time)</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">r =</span> r, <span class="at">K =</span> K, <span class="at">t0 =</span> t0, <span class="at">r_norm =</span> r <span class="sc">*</span> dur)</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="per-curve-scalar-metrics-audpc-final-t50-r_norm" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="per-curve-scalar-metrics-audpc-final-t50-r_norm"><span class="header-section-number">7</span> Per-curve scalar metrics (AUDPC, final, T50, r_norm)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>curve_stats <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(curve_id, Ambiente, Hibrido) <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">AUDPC     =</span> pracma<span class="sc">::</span><span class="fu">trapz</span>(DAE, y),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_sev =</span> y[<span class="fu">which.max</span>(DAE)],</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">T50       =</span> <span class="fu">t50_interp</span>(DAE, y),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups   =</span> <span class="st">"drop"</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>rate_df <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(<span class="fu">unique</span>(curve_stats<span class="sc">$</span>curve_id), <span class="cf">function</span>(cid){</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">filter</span>(curve_id <span class="sc">==</span> cid)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logistic_fit_rate</span>(df<span class="sc">$</span>DAE, df<span class="sc">$</span>y) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">curve_id =</span> <span class="fu">as.character</span>(cid))</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>curve_stats <span class="ot">&lt;-</span> curve_stats <span class="sc">%&gt;%</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">curve_id =</span> <span class="fu">as.character</span>(curve_id)) <span class="sc">%&gt;%</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(rate_df, <span class="at">by =</span> <span class="st">"curve_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(T50), <span class="fu">is.finite</span>(r_norm))</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Curves with all scalar metrics: "</span>, <span class="fu">nrow</span>(curve_stats))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="hierarchical-beta-gam-hgam-for-smoothing-and-adjustment" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="hierarchical-beta-gam-hgam-for-smoothing-and-adjustment"><span class="header-section-number">8</span> Hierarchical beta-GAM (HGAM) for smoothing and adjustment</h2>
<p>Model specification (as in your script):</p>
<ul>
<li><span class="math inline">\(s(\mathrm{DAE})\)</span> global mean epidemic shape<br>
</li>
<li><span class="math inline">\(s(\mathrm{DAE}, \mathrm{Ambiente}, \mathrm{bs}=\mathrm{fs})\)</span> environment-specific deviation (random smooth)<br>
</li>
<li><span class="math inline">\(s(\mathrm{DAE}, \mathrm{Hibrido}, \mathrm{bs}=\mathrm{fs})\)</span> hybrid-specific deviation (random smooth)<br>
</li>
<li><span class="math inline">\(s(\mathrm{curve\_id}, \mathrm{bs}=\mathrm{re})\)</span> curve-level random intercept</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>m_gam <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">bam</span>(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="fu">s</span>(DAE, <span class="at">k =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">s</span>(DAE, Ambiente, <span class="at">bs =</span> <span class="st">"fs"</span>, <span class="at">k =</span> <span class="dv">4</span>, <span class="at">m =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">s</span>(DAE, Hibrido,  <span class="at">bs =</span> <span class="st">"fs"</span>, <span class="at">k =</span> <span class="dv">4</span>, <span class="at">m =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">s</span>(curve_id, <span class="at">bs =</span> <span class="st">"re"</span>),</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">family   =</span> mgcv<span class="sc">::</span><span class="fu">betar</span>(<span class="at">link =</span> <span class="st">"logit"</span>),</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">data     =</span> dat,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">method   =</span> <span class="st">"fREML"</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">discrete =</span> <span class="cn">TRUE</span>,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">gamma    =</span> <span class="fl">1.4</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">select   =</span> <span class="cn">TRUE</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>mgcv<span class="sc">::</span><span class="fu">gam.check</span>(m_gam)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/gam-fit-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Method: fREML   Optimizer: perf chol
$grad
[1] 0.016081435 0.003210994 0.030423438 0.010187219 0.078692914 0.022287793
[7] 0.082631448

$hess
            [,1]         [,2]        [,3]         [,4]        [,5]         [,6]
[1,]  1.77529854  0.098828686  0.07600351 -0.026788931 -0.03057700 -0.017292515
[2,]  0.09882869  0.451087893 -0.02484861 -0.007170195  0.00848747 -0.004382001
[3,]  0.07600351 -0.024848613  5.47833549 -0.194357458 -0.03010905 -0.010764192
[4,] -0.02678893 -0.007170195 -0.19435746  2.262016363 -0.01662864 -0.049631277
[5,] -0.03057700  0.008487470 -0.03010905 -0.016628635  8.94699448 -0.040648829
[6,] -0.01729251 -0.004382001 -0.01076419 -0.049631277 -0.04064883  4.432210980
[7,] -0.01131773 -0.002160372 -0.06791368  0.104652002 -0.10163246  0.532111905
             [,7]
[1,] -0.011317732
[2,] -0.002160372
[3,] -0.067913683
[4,]  0.104652002
[5,] -0.101632464
[6,]  0.532111905
[7,] 22.373931183

Model rank =  160 / 160 

Basis dimension (k) checking results. Low p-value (k-index&lt;1) may
indicate that k is too low, especially if edf is close to k'.

                   k'   edf k-index p-value
s(DAE)           9.00  5.92    1.08    0.99
s(DAE,Ambiente) 24.00 17.46    1.08    0.98
s(DAE,Hibrido)  52.00 33.61    1.08    0.99
s(curve_id)     74.00 51.10      NA      NA</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(m_gam)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -4425.56</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_gam)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: Beta regression(84.608) 
Link function: logit 

Formula:
y ~ s(DAE, k = 10) + s(DAE, Ambiente, bs = "fs", k = 4, m = 1) + 
    s(DAE, Hibrido, bs = "fs", k = 4, m = 1) + s(curve_id, bs = "re")

Parametric coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  -2.7527     0.2068  -13.31   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
                   edf Ref.df      F p-value    
s(DAE)           5.924      9  43.99  &lt;2e-16 ***
s(DAE,Ambiente) 17.457     23 267.46   0.981    
s(DAE,Hibrido)  33.614     52 816.51   0.998    
s(curve_id)     51.097     73  16.33  &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

R-sq.(adj) =  0.948   Deviance explained = 97.7%
fREML = -865.48  Scale est. = 1         n = 885</code></pre>
</div>
</div>
<section id="diagnostics-observed-vs-fitted-and-residuals" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="diagnostics-observed-vs-fitted-and-residuals"><span class="header-section-number">8.1</span> Diagnostics (observed vs fitted and residuals)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>mu_hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(m_gam, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(mu_hat, y)) <span class="sc">+</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Fitted"</span>, <span class="at">y =</span> <span class="st">"Observed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/gam-diagnostics-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">residuals</span>(m_gam, <span class="at">type =</span> <span class="st">"pearson"</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dat<span class="sc">$</span>DAE, res)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/gam-diagnostics-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="environment-adjusted-hybrid-mean-curves" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="environment-adjusted-hybrid-mean-curves"><span class="header-section-number">9</span> Environment-adjusted hybrid mean curves</h2>
<p>We obtain hybrid mean curves on a regular grid <strong>excluding</strong>:</p>
<ul>
<li>the environment random smooth term <code>s(DAE,Ambiente)</code></li>
<li>the curve random intercept <code>s(curve_id)</code></li>
</ul>
<p>so each hybrid is represented at a chosen reference environment level.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>t_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(dat<span class="sc">$</span>DAE), <span class="fu">max</span>(dat<span class="sc">$</span>DAE), <span class="at">length.out =</span> grid_n)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>env_ref <span class="ot">&lt;-</span> <span class="fu">levels</span>(dat<span class="sc">$</span>Ambiente)[<span class="dv">1</span>]</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>cultivars <span class="ot">&lt;-</span> <span class="fu">levels</span>(dat<span class="sc">$</span>Hibrido)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>pred_cult <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(cultivars, <span class="cf">function</span>(cv){</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  newd <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">DAE      =</span> t_grid,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ambiente =</span> <span class="fu">factor</span>(env_ref, <span class="at">levels =</span> <span class="fu">levels</span>(dat<span class="sc">$</span>Ambiente)),</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Hibrido  =</span> <span class="fu">factor</span>(cv, <span class="at">levels =</span> <span class="fu">levels</span>(dat<span class="sc">$</span>Hibrido)),</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">curve_id =</span> dat<span class="sc">$</span>curve_id[<span class="dv">1</span>]  <span class="co"># dummy; excluded below</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    m_gam, <span class="at">newdata =</span> newd, <span class="at">type =</span> <span class="st">"response"</span>,</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">exclude =</span> <span class="fu">c</span>(<span class="st">"s(DAE,Ambiente)"</span>, <span class="st">"s(curve_id)"</span>)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">Hibrido =</span> cv, <span class="at">DAE =</span> t_grid, <span class="at">mu =</span> <span class="fu">as.numeric</span>(mu))</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>cult_score <span class="ot">&lt;-</span> pred_cult <span class="sc">%&gt;%</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Hibrido) <span class="sc">%&gt;%</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_mu =</span> <span class="fu">mean</span>(mu), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(mean_mu)</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>cult_score</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 2
   Hibrido      mean_mu
   &lt;chr&gt;          &lt;dbl&gt;
 1 P 3016 VYHR   0.0923
 2 CRWX03        0.0933
 3 MG 616 PWU    0.114 
 4 AS 1868 PRO4  0.115 
 5 T 1503 PWU    0.118 
 6 AG 8701 PRO4  0.124 
 7 B 2801 PWU    0.128 
 8 AG 9021 PRO3  0.133 
 9 DKB 230 PRO3  0.146 
10 DKB 242 PRO4  0.154 
11 AS 1955 PRO4  0.162 
12 AS 1757 PRO4  0.188 
13 AG 8707 PRO4  0.192 </code></pre>
</div>
</div>
<hr>
</section>
<section id="functional-distance-among-hybrids-clustering" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="functional-distance-among-hybrids-clustering"><span class="header-section-number">10</span> Functional distance among hybrids + clustering</h2>
<section id="utility-shorten-hybrid-labels" class="level3" data-number="10.1">
<h3 data-number="10.1" class="anchored" data-anchor-id="utility-shorten-hybrid-labels"><span class="header-section-number">10.1</span> Utility: shorten hybrid labels</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>shorten_hybrid <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" PRO[0-9]+| PWU| VYHR"</span>, <span class="st">""</span>, x)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">""</span>, x)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  x</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="build-distance-matrix-and-cluster" class="level3" data-number="10.2">
<h3 data-number="10.2" class="anchored" data-anchor-id="build-distance-matrix-and-cluster"><span class="header-section-number">10.2</span> Build distance matrix and cluster</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Wide matrix: rows = time, cols = hybrid</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> pred_cult <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(DAE, Hibrido, mu) <span class="sc">%&gt;%</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> Hibrido, <span class="at">values_from =</span> mu) <span class="sc">%&gt;%</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(DAE)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>dt_grid <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">diff</span>(mat<span class="sc">$</span>DAE))</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>matX <span class="ot">&lt;-</span> mat <span class="sc">%&gt;%</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>DAE) <span class="sc">%&gt;%</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Functional L2 distance (grid approximation)</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>D_cult <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(<span class="fu">t</span>(matX), <span class="at">method =</span> <span class="st">"euclidean"</span>)) <span class="sc">*</span> <span class="fu">sqrt</span>(dt_grid)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>hc <span class="ot">&lt;-</span> <span class="fu">hclust</span>(<span class="fu">as.dist</span>(D_cult), <span class="at">method =</span> <span class="st">"ward.D2"</span>)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>cl_raw <span class="ot">&lt;-</span> <span class="fu">cutree</span>(hc, <span class="at">k =</span> k_clusters)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Order clusters by mean severity (from cult_score)</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>cluster_rank_map <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">Hibrido =</span> <span class="fu">names</span>(cl_raw),</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>                           <span class="at">cluster_raw =</span> <span class="fu">as.integer</span>(cl_raw)) <span class="sc">%&gt;%</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(cult_score <span class="sc">%&gt;%</span> <span class="fu">select</span>(Hibrido, mean_mu), <span class="at">by =</span> <span class="st">"Hibrido"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster_raw) <span class="sc">%&gt;%</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">cluster_mean =</span> <span class="fu">mean</span>(mean_mu, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(cluster_mean) <span class="sc">%&gt;%</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cluster =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(cluster_raw, cluster)</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>cluster_table2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">Hibrido =</span> <span class="fu">names</span>(cl_raw),</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cluster_raw =</span> <span class="fu">as.integer</span>(cl_raw)) <span class="sc">%&gt;%</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(cluster_rank_map, <span class="at">by =</span> <span class="st">"cluster_raw"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(cult_score <span class="sc">%&gt;%</span> <span class="fu">select</span>(Hibrido, mean_mu), <span class="at">by =</span> <span class="st">"Hibrido"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">phenotype =</span> <span class="fu">factor</span>(cluster,</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>                       <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span>k_clusters,</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> <span class="fu">paste0</span>(<span class="st">"P"</span>, <span class="dv">1</span><span class="sc">:</span>k_clusters))</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>cluster_table2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 5
   Hibrido      cluster_raw cluster mean_mu phenotype
   &lt;chr&gt;              &lt;int&gt;   &lt;int&gt;   &lt;dbl&gt; &lt;fct&gt;    
 1 AG 8701 PRO4           1       2  0.124  P2       
 2 AG 8707 PRO4           2       4  0.192  P4       
 3 AG 9021 PRO3           1       2  0.133  P2       
 4 AS 1757 PRO4           2       4  0.188  P4       
 5 AS 1868 PRO4           1       2  0.115  P2       
 6 AS 1955 PRO4           3       3  0.162  P3       
 7 B 2801 PWU             1       2  0.128  P2       
 8 CRWX03                 4       1  0.0933 P1       
 9 DKB 230 PRO3           1       2  0.146  P2       
10 DKB 242 PRO4           3       3  0.154  P3       
11 MG 616 PWU             1       2  0.114  P2       
12 P 3016 VYHR            4       1  0.0923 P1       
13 T 1503 PWU             1       2  0.118  P2       </code></pre>
</div>
</div>
</section>
<section id="figure-mean-curves-by-phenotype-dendrogram" class="level3" data-number="10.3">
<h3 data-number="10.3" class="anchored" data-anchor-id="figure-mean-curves-by-phenotype-dendrogram"><span class="header-section-number">10.3</span> Figure: mean curves by phenotype + dendrogram</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#D55E00"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#009E73"</span>, <span class="st">"#CC79A7"</span>)[<span class="dv">1</span><span class="sc">:</span>k_clusters]</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>phen_cols <span class="ot">&lt;-</span> <span class="fu">setNames</span>(cols, <span class="fu">levels</span>(cluster_table2<span class="sc">$</span>phenotype))</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>pred_cult2 <span class="ot">&lt;-</span> pred_cult <span class="sc">%&gt;%</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(cluster_table2 <span class="sc">%&gt;%</span> <span class="fu">select</span>(Hibrido, phenotype), <span class="at">by =</span> <span class="st">"Hibrido"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hybrid_short =</span> <span class="fu">shorten_hybrid</span>(Hibrido))</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>pred_cult2 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(pred_cult2, bipolaris_df)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>label_df <span class="ot">&lt;-</span> pred_cult2 <span class="sc">%&gt;%</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Hibrido) <span class="sc">%&gt;%</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(DAE <span class="sc">==</span> <span class="fu">max</span>(DAE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>p_hibridos <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pred_cult2,</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">aes</span>(<span class="at">x =</span> DAE, <span class="at">y =</span> mu, <span class="at">group =</span> Hibrido, <span class="at">linetype  =</span> resistance, <span class="at">color =</span> phenotype)) <span class="sc">+</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.1</span>, <span class="at">alpha =</span> <span class="fl">0.95</span>) <span class="sc">+</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  ggrepel<span class="sc">::</span><span class="fu">geom_text_repel</span>(</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> label_df,</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">label =</span> hybrid_short),</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">direction =</span> <span class="st">"y"</span>,</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_x =</span> <span class="dv">2</span>,</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">2.8</span>,</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.size =</span> <span class="fl">0.2</span>,</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.alpha =</span> <span class="fl">0.6</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_limits</span>(<span class="at">x =</span> <span class="fu">max</span>(pred_cult2<span class="sc">$</span>DAE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> <span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> phen_cols, <span class="at">drop =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Days after emergence (DAE)"</span>,</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Environment-adjusted mean severity"</span>,</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Phenotype"</span>, <span class="at">linetype =</span> <span class="st">"Resistance"</span>) <span class="sc">+</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>ddata <span class="ot">&lt;-</span> ggdendro<span class="sc">::</span><span class="fu">dendro_data</span>(<span class="fu">as.dendrogram</span>(hc), <span class="at">type =</span> <span class="st">"rectangle"</span>)</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>lab_map <span class="ot">&lt;-</span> cluster_table2 <span class="sc">%&gt;%</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> Hibrido,</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>         <span class="at">label_short =</span> <span class="fu">shorten_hybrid</span>(Hibrido),</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>         <span class="at">lab_col =</span> phen_cols[<span class="fu">as.character</span>(phenotype)]) <span class="sc">%&gt;%</span></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(label, label_short, lab_col)</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>lab_df <span class="ot">&lt;-</span> ddata<span class="sc">$</span>labels <span class="sc">%&gt;%</span></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(lab_map, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"label"</span> <span class="ot">=</span> <span class="st">"label"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label_short =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(label_short), <span class="fu">shorten_hybrid</span>(label), label_short))</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>p_dend <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> ddata<span class="sc">$</span>segments,</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend),</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>               <span class="at">linewidth =</span> <span class="fl">0.45</span>) <span class="sc">+</span></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> lab_df,</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y <span class="sc">-</span> <span class="fl">0.02</span> <span class="sc">*</span> <span class="fu">max</span>(ddata<span class="sc">$</span>segments<span class="sc">$</span>y),</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>                <span class="at">label =</span> label_short, <span class="at">color =</span> <span class="fu">I</span>(lab_col)),</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>            <span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Functional distance"</span>) <span class="sc">+</span></span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.line.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x  =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">clip =</span> <span class="st">"off"</span>) <span class="sc">+</span></span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="fl">5.5</span>, <span class="at">r =</span> <span class="fl">5.5</span>, <span class="at">b =</span> <span class="dv">18</span>, <span class="at">l =</span> <span class="fl">5.5</span>))</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>h_cut <span class="ot">&lt;-</span> hc<span class="sc">$</span>height[<span class="fu">length</span>(hc<span class="sc">$</span>height) <span class="sc">-</span> (k_clusters <span class="sc">-</span> <span class="dv">1</span>)]</span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>p_dend <span class="ot">&lt;-</span> p_dend <span class="sc">+</span></span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> h_cut, <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>             <span class="at">linewidth =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"grey30"</span>)</span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>fig_final <span class="ot">&lt;-</span> (p_hibridos <span class="sc">|</span> p_dend) <span class="sc">+</span> <span class="fu">plot_annotation</span>(<span class="at">tag_levels =</span> <span class="st">"A"</span>)</span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a>fig_final</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/figure-functional-panels-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("Figure2_functional_phenotypes.png", fig_final, width = 12, height = 5.5, dpi = 300)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
</section>
<section id="scalar-equivalent-but-trajectory-distinct-curves" class="level2" data-number="11">
<h2 data-number="11" class="anchored" data-anchor-id="scalar-equivalent-but-trajectory-distinct-curves"><span class="header-section-number">11</span> Scalar-equivalent but trajectory-distinct curves</h2>
<p>We select two <strong>individual curves</strong> (by <code>curve_id</code>) that are close in scalar space (AUDPC + final severity) but have large functional distance on a common grid.</p>
<section id="select-candidate-pairs-scalar-nearest-and-maximize-functional-distance" class="level3" data-number="11.1">
<h3 data-number="11.1" class="anchored" data-anchor-id="select-candidate-pairs-scalar-nearest-and-maximize-functional-distance"><span class="header-section-number">11.1</span> Select candidate pairs (scalar-nearest) and maximize functional distance</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>dfS <span class="ot">&lt;-</span> curve_stats <span class="sc">%&gt;%</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">curve_id  =</span> <span class="fu">as.character</span>(curve_id),</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">AUDPC     =</span> <span class="fu">as.numeric</span>(AUDPC),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_sev =</span> <span class="fu">as.numeric</span>(final_sev)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(AUDPC), <span class="fu">is.finite</span>(final_sev)) <span class="sc">%&gt;%</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(curve_id, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">AUDPC_z =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(AUDPC)),</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_z =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(final_sev))</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>pairs_scalar <span class="ot">&lt;-</span> <span class="fu">crossing</span>(</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  dfS <span class="sc">%&gt;%</span> <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">paste0</span>(.x, <span class="st">".x"</span>), <span class="sc">-</span>curve_id) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">curve_id.x =</span> curve_id),</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  dfS <span class="sc">%&gt;%</span> <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">paste0</span>(.x, <span class="st">".y"</span>), <span class="sc">-</span>curve_id) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">curve_id.y =</span> curve_id)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(curve_id.x <span class="sc">&lt;</span> curve_id.y) <span class="sc">%&gt;%</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">scalar_dist =</span> <span class="fu">sqrt</span>((AUDPC_z.x <span class="sc">-</span> AUDPC_z.y)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>                         (final_z.x <span class="sc">-</span> final_z.y)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(scalar_dist)</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>thr  <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pairs_scalar<span class="sc">$</span>scalar_dist, <span class="fl">0.03</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>cand <span class="ot">&lt;-</span> pairs_scalar <span class="sc">%&gt;%</span> <span class="fu">filter</span>(scalar_dist <span class="sc">&lt;=</span> thr)</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>interp_curve <span class="ot">&lt;-</span> <span class="cf">function</span>(id){</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">as.character</span>(curve_id) <span class="sc">==</span> id) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(DAE)</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">approx</span>(df<span class="sc">$</span>DAE, df<span class="sc">$</span>y, <span class="at">xout =</span> t_grid, <span class="at">rule =</span> <span class="dv">2</span>)<span class="sc">$</span>y</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">diff</span>(t_grid))</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>cand2 <span class="ot">&lt;-</span> cand <span class="sc">%&gt;%</span></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">func_dist =</span> {</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>      y1 <span class="ot">&lt;-</span> <span class="fu">interp_curve</span>(curve_id.x)</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>      y2 <span class="ot">&lt;-</span> <span class="fu">interp_curve</span>(curve_id.y)</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sqrt</span>(<span class="fu">sum</span>((y1 <span class="sc">-</span> y2)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> dt)</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>best <span class="ot">&lt;-</span> cand2 <span class="sc">%&gt;%</span></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(func_dist), scalar_dist) <span class="sc">%&gt;%</span></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>id1 <span class="ot">&lt;-</span> best<span class="sc">$</span>curve_id.x</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>id2 <span class="ot">&lt;-</span> best<span class="sc">$</span>curve_id.y</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>best</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 12
  curve_id.x          AUDPC.x final_sev.x AUDPC_z.x final_z.x curve_id.y AUDPC.y
  &lt;chr&gt;                 &lt;dbl&gt;       &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;        &lt;dbl&gt;
1 2024_Arapoti_Prefe…    14.9        0.35     0.439   -0.0673 2024_Cast…    15.6
# ℹ 5 more variables: final_sev.y &lt;dbl&gt;, AUDPC_z.y &lt;dbl&gt;, final_z.y &lt;dbl&gt;,
#   scalar_dist &lt;dbl&gt;, func_dist &lt;dbl&gt;</code></pre>
</div>
</div>
</section>
<section id="plot-the-two-raw-curves" class="level3" data-number="11.2">
<h3 data-number="11.2" class="anchored" data-anchor-id="plot-the-two-raw-curves"><span class="header-section-number">11.2</span> Plot the two raw curves</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>plot_pair <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">as.character</span>(curve_id) <span class="sc">%in%</span> <span class="fu">c</span>(id1, id2)) <span class="sc">%&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">curve =</span> <span class="fu">if_else</span>(<span class="fu">as.character</span>(curve_id) <span class="sc">==</span> id1, <span class="st">"A"</span>, <span class="st">"B"</span>))</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>s1 <span class="ot">&lt;-</span> dfS <span class="sc">%&gt;%</span> <span class="fu">filter</span>(curve_id <span class="sc">==</span> id1)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>s2 <span class="ot">&lt;-</span> dfS <span class="sc">%&gt;%</span> <span class="fu">filter</span>(curve_id <span class="sc">==</span> id2)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>ann <span class="ot">&lt;-</span> <span class="fu">glue</span>(</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"AUDPC  A={round(s1$AUDPC,2)}  B={round(s2$AUDPC,2)}</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Final   A={round(s1$final_sev,2)}  B={round(s2$final_sev,2)}</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"d_S={signif(best$scalar_dist,3)}   d_F={signif(best$func_dist,3)}"</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>y_top <span class="ot">&lt;-</span> <span class="fu">max</span>(plot_pair<span class="sc">$</span>y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="fl">1.15</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>p_main <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_pair, <span class="fu">aes</span>(DAE, y, <span class="at">color =</span> curve)) <span class="sc">+</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_grey</span>() <span class="sc">+</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"label"</span>,</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> <span class="fu">min</span>(plot_pair<span class="sc">$</span>DAE) <span class="sc">+</span> <span class="dv">2</span>,</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> y_top <span class="sc">-</span> <span class="fl">0.02</span>,</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> ann,</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>           <span class="at">hjust =</span> <span class="dv">0</span>,</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>           <span class="at">size =</span> <span class="dv">4</span>,</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>           <span class="at">fill =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Days after emergence (DAE)"</span>,</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Disease severity (proportion)"</span>,</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Curve"</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, y_top))</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>p_main</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/killer-plot-raw-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="difference-function-deltat-and-its-integral-contribution" class="level3" data-number="11.3">
<h3 data-number="11.3" class="anchored" data-anchor-id="difference-function-deltat-and-its-integral-contribution"><span class="header-section-number">11.3</span> Difference function <span class="math inline">\(\Delta(t)\)</span> and its integral contribution</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>yA <span class="ot">&lt;-</span> <span class="fu">interp_curve</span>(id1)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>yB <span class="ot">&lt;-</span> <span class="fu">interp_curve</span>(id2)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>df_diff <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">DAE  =</span> t_grid,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">diff =</span> yA <span class="sc">-</span> yB,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">sq   =</span> (yA <span class="sc">-</span> yB)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">diff</span>(t_grid))</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>L2_sq <span class="ot">&lt;-</span> <span class="fu">sum</span>(df_diff<span class="sc">$</span>sq) <span class="sc">*</span> dt</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>L2    <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(L2_sq)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>p_diff <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_diff, <span class="fu">aes</span>(DAE, diff)) <span class="sc">+</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linewidth =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Days after emergence (DAE)"</span>,</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">Delta</span>(t) <span class="sc">==</span> y[A](t) <span class="sc">-</span> y[B](t)),</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"L2 distance = "</span>, <span class="fu">signif</span>(L2, <span class="dv">3</span>),</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"  ( ∫Δ(t)^2 dt = "</span>, <span class="fu">signif</span>(L2_sq, <span class="dv">3</span>), <span class="st">" )"</span>)</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>p_sq <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_diff, <span class="fu">aes</span>(DAE, sq)) <span class="sc">+</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Days after emergence (DAE)"</span>,</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">Delta</span>(t)<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Integral of Δ(t)^2 over time drives the L2 distance"</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>p_diff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/killer-delta-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>p_sq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/killer-delta-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="traditional-audpc-analysis-mixed-model-tukey" class="level2" data-number="12">
<h2 data-number="12" class="anchored" data-anchor-id="traditional-audpc-analysis-mixed-model-tukey"><span class="header-section-number">12</span> Traditional AUDPC analysis (mixed model + Tukey)</h2>
<p><strong>Important design note.</strong> Your script uses one AUDPC per <code>Hibrido × Ambiente</code>:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>audpc_df <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Ambiente, Hibrido) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">AUDPC =</span> ..., <span class="at">.groups=</span><span class="st">"drop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is appropriate if (a) <code>Parcela</code> is not a true replication factor, or (b) you intentionally aggregate within environment. If you do have plot-level replication and want plot-level inference, compute AUDPC by <code>Ambiente × Hibrido × Parcela</code> and fit a corresponding mixed model.</p>
<section id="compute-audpc-and-fit-model" class="level3" data-number="12.1">
<h3 data-number="12.1" class="anchored" data-anchor-id="compute-audpc-and-fit-model"><span class="header-section-number">12.1</span> Compute AUDPC and fit model</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>audpc_df <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ambiente, Hibrido) <span class="sc">%&gt;%</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">AUDPC =</span> pracma<span class="sc">::</span><span class="fu">trapz</span>(DAE, y), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>audpc_df2 <span class="ot">&lt;-</span> audpc_df <span class="sc">%&gt;%</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ambiente =</span> <span class="fu">factor</span>(Ambiente),</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Hibrido  =</span> <span class="fu">factor</span>(Hibrido),</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">AUDPC    =</span> <span class="fu">as.numeric</span>(AUDPC)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(AUDPC))</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Mixed model: random intercept for Ambiente (as in your earlier block)</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>m_audpc <span class="ot">&lt;-</span> <span class="fu">lmer</span>(AUDPC <span class="sc">~</span> Hibrido <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> Ambiente), <span class="at">data =</span> audpc_df2)</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(m_audpc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Type III Analysis of Variance Table with Satterthwaite's method
        Sum Sq Mean Sq NumDF  DenDF F value    Pr(&gt;F)    
Hibrido 684.75  57.063    12 55.991  5.5711 3.681e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
</section>
<section id="model-checks-dharma" class="level3" data-number="12.2">
<h3 data-number="12.2" class="anchored" data-anchor-id="model-checks-dharma"><span class="header-section-number">12.2</span> Model checks (DHARMa)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>res_a <span class="ot">&lt;-</span> <span class="fu">simulateResiduals</span>(m_audpc, <span class="at">n =</span> <span class="dv">2000</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(res_a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/audpc-diagnostics-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">testUniformity</span>(res_a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/audpc-diagnostics-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Asymptotic one-sample Kolmogorov-Smirnov test

data:  simulationOutput$scaledResiduals
D = 0.067351, p-value = 0.8904
alternative hypothesis: two-sided</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">testDispersion</span>(res_a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/audpc-diagnostics-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    DHARMa nonparametric dispersion test via sd of residuals fitted vs.
    simulated

data:  simulationOutput
dispersion = 0.90491, p-value = 0.962
alternative hypothesis: two.sided</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">testOutliers</span>(res_a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/audpc-diagnostics-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    DHARMa outlier test based on exact binomial test with approximate
    expectations

data:  res_a
outliers at both margin(s) = 0, observations = 74, p-value = 1
alternative hypothesis: true probability of success is not equal to 0.0009995002
95 percent confidence interval:
 0.00000000 0.04862762
sample estimates:
frequency of outliers (expected: 0.000999500249875062 ) 
                                                      0 </code></pre>
</div>
</div>
</section>
<section id="hybrid-means-tukey-letters" class="level3" data-number="12.3">
<h3 data-number="12.3" class="anchored" data-anchor-id="hybrid-means-tukey-letters"><span class="header-section-number">12.3</span> Hybrid means + Tukey letters</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>emm_h <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(m_audpc, <span class="sc">~</span> Hibrido)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>cld_res <span class="ot">&lt;-</span> multcomp<span class="sc">::</span><span class="fu">cld</span>(</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  emm_h,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Letters =</span> letters,</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">adjust  =</span> <span class="st">"tukey"</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>audpc_groups <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(cld_res) <span class="sc">%&gt;%</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    Hibrido,</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    emmean,</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    SE,</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    df,</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    lower.CL,</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    upper.CL,</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">.group =</span> stringr<span class="sc">::</span><span class="fu">str_squish</span>(.group)</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(emmean)</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>audpc_groups</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Hibrido    emmean       SE       df   lower.CL upper.CL .group
1   P 3016 VYHR  8.078767 2.001389 13.00413  1.0806978 15.07684      a
2        CRWX03  8.124162 2.221715 18.63419  0.8172663 15.43106     ab
3    MG 616 PWU  9.714700 2.001389 13.00413  2.7166311 16.71277     ab
4    T 1503 PWU  9.967308 2.001389 13.00413  2.9692394 16.96538     ab
5  AS 1868 PRO4 10.275675 2.001389 13.00413  3.2776061 17.27374     ab
6    B 2801 PWU 11.039174 2.221715 18.63419  3.7322788 18.34607   abcd
7  AG 8701 PRO4 11.048208 2.001389 13.00413  4.0501394 18.04628    abc
8  AG 9021 PRO3 12.287733 2.001389 13.00413  5.2896644 19.28580   abcd
9  DKB 230 PRO3 13.911767 2.001389 13.00413  6.9136978 20.90984   abcd
10 DKB 242 PRO4 14.184983 2.001389 13.00413  7.1869144 21.18305   abcd
11 AS 1955 PRO4 15.084983 2.001389 13.00413  8.0869144 22.08305    bcd
12 AS 1757 PRO4 17.016708 2.001389 13.00413 10.0186394 24.01478     cd
13 AG 8707 PRO4 17.799042 2.001389 13.00413 10.8009728 24.79711      d</code></pre>
</div>
</div>
</section>
<section id="merge-tukey-groups-with-functional-clusters" class="level3" data-number="12.4">
<h3 data-number="12.4" class="anchored" data-anchor-id="merge-tukey-groups-with-functional-clusters"><span class="header-section-number">12.4</span> Merge Tukey groups with functional clusters</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>final_compare <span class="ot">&lt;-</span> audpc_groups <span class="sc">%&gt;%</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    cluster_table2 <span class="sc">%&gt;%</span> <span class="fu">select</span>(Hibrido, cluster, phenotype),</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"Hibrido"</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(emmean)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>final_compare</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Hibrido    emmean       SE       df   lower.CL upper.CL .group cluster
1   P 3016 VYHR  8.078767 2.001389 13.00413  1.0806978 15.07684      a       1
2        CRWX03  8.124162 2.221715 18.63419  0.8172663 15.43106     ab       1
3    MG 616 PWU  9.714700 2.001389 13.00413  2.7166311 16.71277     ab       2
4    T 1503 PWU  9.967308 2.001389 13.00413  2.9692394 16.96538     ab       2
5  AS 1868 PRO4 10.275675 2.001389 13.00413  3.2776061 17.27374     ab       2
6    B 2801 PWU 11.039174 2.221715 18.63419  3.7322788 18.34607   abcd       2
7  AG 8701 PRO4 11.048208 2.001389 13.00413  4.0501394 18.04628    abc       2
8  AG 9021 PRO3 12.287733 2.001389 13.00413  5.2896644 19.28580   abcd       2
9  DKB 230 PRO3 13.911767 2.001389 13.00413  6.9136978 20.90984   abcd       2
10 DKB 242 PRO4 14.184983 2.001389 13.00413  7.1869144 21.18305   abcd       3
11 AS 1955 PRO4 15.084983 2.001389 13.00413  8.0869144 22.08305    bcd       3
12 AS 1757 PRO4 17.016708 2.001389 13.00413 10.0186394 24.01478     cd       4
13 AG 8707 PRO4 17.799042 2.001389 13.00413 10.8009728 24.79711      d       4
   phenotype
1         P1
2         P1
3         P2
4         P2
5         P2
6         P2
7         P2
8         P2
9         P2
10        P3
11        P3
12        P4
13        P4</code></pre>
</div>
</div>
</section>
<section id="plot-audpc-means-ci-tukey-letters-colored-by-functional-phenotype" class="level3" data-number="12.5">
<h3 data-number="12.5" class="anchored" data-anchor-id="plot-audpc-means-ci-tukey-letters-colored-by-functional-phenotype"><span class="header-section-number">12.5</span> Plot: AUDPC means, CI, Tukey letters (colored by functional phenotype)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> final_compare <span class="sc">%&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">hybrid_short =</span> <span class="fu">shorten_hybrid</span>(Hibrido),</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">cluster =</span> <span class="fu">factor</span>(cluster)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#D55E00"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#009E73"</span>, <span class="st">"#CC79A7"</span>)[<span class="dv">1</span><span class="sc">:</span>k_clusters]</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_df,</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">reorder</span>(hybrid_short, emmean),</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> emmean,</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> cluster)) <span class="sc">+</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> cols) <span class="sc">+</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> lower.CL, <span class="at">xmax =</span> upper.CL), <span class="at">height =</span> <span class="fl">0.12</span>) <span class="sc">+</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> .group), <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"AUDPC"</span>,</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Hybrid"</span>,</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Functional phenotype"</span>,</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="cn">NULL</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="fu">min</span>(plot_df<span class="sc">$</span>lower.CL), <span class="fu">max</span>(plot_df<span class="sc">$</span>upper.CL) <span class="sc">*</span> <span class="fl">1.10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/audpc-plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="optional-run-compare_curves-from-r4pde" class="level2" data-number="13">
<h2 data-number="13" class="anchored" data-anchor-id="optional-run-compare_curves-from-r4pde"><span class="header-section-number">13</span> Optional: run <code>compare_curves()</code> from <code>{r4pde}</code></h2>
<p>This section reproduces your final call, assuming <code>{r4pde}</code> is installed and your <code>dat</code> object matches the required schema.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">#pak::pkg_install("emdelponte/r4pde")</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(r4pde)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">compare_curves</span>(</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat,</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">time =</span> <span class="st">"DAE"</span>,</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">response =</span> <span class="st">"y"</span>,</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment =</span> <span class="st">"Hibrido"</span>,</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">environment =</span> <span class="st">"Ambiente"</span>,</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">test_factor =</span> <span class="st">"resistance"</span>,</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">perm_unit =</span> <span class="st">"Hibrido"</span>,</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">perm_strata =</span> <span class="st">"Ambiente"</span>,</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">test_mode =</span> <span class="st">"global"</span>,</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">bootstrap =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">boot_B =</span> <span class="dv">399</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>m1</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m1)</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_curves</span>(m1)</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_dendrogram</span>(m1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="session-info" class="level2" data-number="14">
<h2 data-number="14" class="anchored" data-anchor-id="session-info"><span class="header-section-number">14</span> Session info</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.4.0 (2024-04-24)
Platform: aarch64-apple-darwin20
Running under: macOS 15.6.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Sao_Paulo
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] glue_1.8.0          stringr_1.5.1       DHARMa_0.4.7       
 [4] patchwork_1.3.0     ggdendro_0.2.0      ggrepel_0.9.6      
 [7] cowplot_1.1.3       multcompView_0.1-10 emmeans_2.0.0      
[10] lmerTest_3.1-3      lme4_1.1-37         Matrix_1.7-1       
[13] pheatmap_1.0.13     pracma_2.4.4        mgcv_1.9-1         
[16] nlme_3.1-166        ggplot2_3.5.2       purrr_1.0.4        
[19] tibble_3.3.0        tidyr_1.3.1         dplyr_1.1.4        
[22] readr_2.1.5        

loaded via a namespace (and not attached):
 [1] tidyselect_1.2.1    farver_2.1.2        fastmap_1.2.0      
 [4] TH.data_1.1-2       promises_1.3.2      digest_0.6.37      
 [7] mime_0.13           estimability_1.5.1  lifecycle_1.0.4    
[10] survival_3.7-0      magrittr_2.0.3      compiler_4.4.0     
[13] rlang_1.1.6         tools_4.4.0         utf8_1.2.6         
[16] yaml_2.3.10         knitr_1.49          labeling_0.4.3     
[19] htmlwidgets_1.6.4   bit_4.6.0           plyr_1.8.9         
[22] RColorBrewer_1.1-3  gap.datasets_0.0.6  multcomp_1.4-26    
[25] withr_3.0.2         numDeriv_2016.8-1.1 grid_4.4.0         
[28] xtable_1.8-4        iterators_1.0.14    scales_1.4.0       
[31] MASS_7.3-61         dichromat_2.0-0.1   cli_3.6.5          
[34] mvtnorm_1.3-2       rmarkdown_2.29      crayon_1.5.3       
[37] reformulas_0.4.1    generics_0.1.4      rstudioapi_0.17.1  
[40] tzdb_0.5.0          minqa_1.2.8         splines_4.4.0      
[43] parallel_4.4.0      vctrs_0.6.5         boot_1.3-31        
[46] sandwich_3.1-1      jsonlite_2.0.0      hms_1.1.3          
[49] pbkrtest_0.5.4      bit64_4.6.0-1       qgam_1.3.4         
[52] foreach_1.5.2       gap_1.6             nloptr_2.2.1       
[55] codetools_0.2-20    stringi_1.8.7       gtable_0.3.6       
[58] later_1.4.1         pillar_1.10.2       htmltools_0.5.8.1  
[61] R6_2.6.1            Rdpack_2.6.4        doParallel_1.0.17  
[64] shiny_1.10.0        vroom_1.6.5         evaluate_1.0.1     
[67] lattice_0.22-6      backports_1.5.0     rbibutils_2.3      
[70] broom_1.0.8         httpuv_1.6.15       Rcpp_1.0.14        
[73] coda_0.19-4.1       xfun_0.49           zoo_1.8-12         
[76] pkgconfig_2.0.3    </code></pre>
</div>
</div>
<!-- -->

</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb48" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Curve-based + traditional analysis of Bipolaris epidemics"</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Functional (beta-GAM/HGAM) smoothing, functional distances, and AUDPC mixed-model comparison"</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Emerson M. Del Ponte"</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="an">theme:</span><span class="co"> flatly</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>This document implements two complementary analyses for Bipolaris leaf spot epidemics assessed in maize hybrids:</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>**A. Functional (curve-based) analysis**</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Beta-GAM (HGAM)** to smooth severity trajectories and adjust for environment.</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Environment-adjusted hybrid mean curves**.</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Functional distance** among hybrids and **hierarchical clustering** (dendrogram + curve panel).</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>*“Killer pair” figure:* two curves that are **scalar-equivalent** (AUDPC + final severity) but **trajectory-distinct**, with the difference function $\Delta(t)$ and its contribution to the $L^2$ distance.</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>**B. Traditional (scalar) analysis**</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**AUDPC** per hybrid within environment (as available in the dataset design).</span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Mixed-model ANOVA and **Tukey** letter groups (via <span class="in">`emmeans::cld()`</span>).</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Merge **Tukey groups** with **functional clusters** for side-by-side comparison.</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data and design</span></span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Input file:** <span class="in">`maize_bipolaris.csv`</span></span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Response:** Bipolaris severity (%) converted to proportion</span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Time scale:** DAE (days after emergence)</span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Design columns:** <span class="in">`Ambiente`</span> (environment), <span class="in">`Hibrido`</span> (hybrid), <span class="in">`Parcela`</span> (plot/block)</span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a><span class="fu">## Methods (equations)</span></span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a><span class="fu">### Response scale and beta regression constraints</span></span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true" tabindex="-1"></a>The raw severity in percent is converted to a proportion:</span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-56"><a href="#cb48-56" aria-hidden="true" tabindex="-1"></a>y = \frac{\text{severity (\%)}}{100}.</span>
<span id="cb48-57"><a href="#cb48-57" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-58"><a href="#cb48-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-59"><a href="#cb48-59" aria-hidden="true" tabindex="-1"></a>Beta regression requires $0 &lt; y &lt; 1$, so we apply a small boundary adjustment:</span>
<span id="cb48-60"><a href="#cb48-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-61"><a href="#cb48-61" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-62"><a href="#cb48-62" aria-hidden="true" tabindex="-1"></a>y^* = \min\left(\max(y, \varepsilon), 1-\varepsilon\right).</span>
<span id="cb48-63"><a href="#cb48-63" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-64"><a href="#cb48-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-65"><a href="#cb48-65" aria-hidden="true" tabindex="-1"></a><span class="fu">### AUDPC</span></span>
<span id="cb48-66"><a href="#cb48-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-67"><a href="#cb48-67" aria-hidden="true" tabindex="-1"></a>AUDPC is approximated using the trapezoidal rule for a curve $y(t)$ observed at times $t_1 &lt; \dots &lt; t_m$:</span>
<span id="cb48-68"><a href="#cb48-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-69"><a href="#cb48-69" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-70"><a href="#cb48-70" aria-hidden="true" tabindex="-1"></a>\mathrm{AUDPC} \approx \sum_{i=1}^{m-1} \frac{(y_i + y_{i+1})}{2}\,(t_{i+1}-t_i).</span>
<span id="cb48-71"><a href="#cb48-71" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-72"><a href="#cb48-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-73"><a href="#cb48-73" aria-hidden="true" tabindex="-1"></a><span class="fu">### $T_{50}$</span></span>
<span id="cb48-74"><a href="#cb48-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-75"><a href="#cb48-75" aria-hidden="true" tabindex="-1"></a>$T_{50}$ is computed as the time when the curve reaches half its observed maximum:</span>
<span id="cb48-76"><a href="#cb48-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-77"><a href="#cb48-77" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-78"><a href="#cb48-78" aria-hidden="true" tabindex="-1"></a>T_{50}=\min<span class="sc">\{</span>t:\; y(t)\ge 0.5\,y_{\max}<span class="sc">\}</span>,</span>
<span id="cb48-79"><a href="#cb48-79" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-80"><a href="#cb48-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-81"><a href="#cb48-81" aria-hidden="true" tabindex="-1"></a>estimated by linear interpolation between adjacent observation times.</span>
<span id="cb48-82"><a href="#cb48-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-83"><a href="#cb48-83" aria-hidden="true" tabindex="-1"></a><span class="fu">### Logistic rate (optional scalar)</span></span>
<span id="cb48-84"><a href="#cb48-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-85"><a href="#cb48-85" aria-hidden="true" tabindex="-1"></a>We fit a logistic curve to each epidemic trajectory:</span>
<span id="cb48-86"><a href="#cb48-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-87"><a href="#cb48-87" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-88"><a href="#cb48-88" aria-hidden="true" tabindex="-1"></a>y(t)=\frac{K}{1 + \exp<span class="sc">\{</span>-r(t-t_0)<span class="sc">\}</span>},</span>
<span id="cb48-89"><a href="#cb48-89" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-90"><a href="#cb48-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-91"><a href="#cb48-91" aria-hidden="true" tabindex="-1"></a>and report a duration-normalized rate:</span>
<span id="cb48-92"><a href="#cb48-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-93"><a href="#cb48-93" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-94"><a href="#cb48-94" aria-hidden="true" tabindex="-1"></a>r_{\mathrm{norm}} = r\,(t_{\max}-t_{\min}).</span>
<span id="cb48-95"><a href="#cb48-95" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-96"><a href="#cb48-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-97"><a href="#cb48-97" aria-hidden="true" tabindex="-1"></a><span class="fu">### Functional distance between curves</span></span>
<span id="cb48-98"><a href="#cb48-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-99"><a href="#cb48-99" aria-hidden="true" tabindex="-1"></a>For two smooth mean curves $\mu_a(t)$ and $\mu_b(t)$, the $L^2$ distance is:</span>
<span id="cb48-100"><a href="#cb48-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-101"><a href="#cb48-101" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-102"><a href="#cb48-102" aria-hidden="true" tabindex="-1"></a>d_F(a,b) = \left(\int \big<span class="co">[</span><span class="ot">\mu_a(t)-\mu_b(t)\big</span><span class="co">]</span>^2\,dt\right)^{1/2}.</span>
<span id="cb48-103"><a href="#cb48-103" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-104"><a href="#cb48-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-105"><a href="#cb48-105" aria-hidden="true" tabindex="-1"></a>On an evenly spaced grid with step $\Delta t$, we approximate:</span>
<span id="cb48-106"><a href="#cb48-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-107"><a href="#cb48-107" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-108"><a href="#cb48-108" aria-hidden="true" tabindex="-1"></a>d_F(a,b)\approx \left(\sum_{j} <span class="co">[</span><span class="ot">\mu_a(t_j)-\mu_b(t_j)</span><span class="co">]</span>^2\,\Delta t\right)^{1/2}.</span>
<span id="cb48-109"><a href="#cb48-109" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-110"><a href="#cb48-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-111"><a href="#cb48-111" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb48-112"><a href="#cb48-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-113"><a href="#cb48-113" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setup</span></span>
<span id="cb48-114"><a href="#cb48-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-115"><a href="#cb48-115" aria-hidden="true" tabindex="-1"></a><span class="fu">### Packages</span></span>
<span id="cb48-116"><a href="#cb48-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-119"><a href="#cb48-119" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-120"><a href="#cb48-120" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup-packages</span></span>
<span id="cb48-121"><a href="#cb48-121" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb48-122"><a href="#cb48-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-123"><a href="#cb48-123" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb48-124"><a href="#cb48-124" aria-hidden="true" tabindex="-1"></a>  <span class="st">"readr"</span>,<span class="st">"dplyr"</span>,<span class="st">"tidyr"</span>,<span class="st">"tibble"</span>,<span class="st">"purrr"</span>,</span>
<span id="cb48-125"><a href="#cb48-125" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ggplot2"</span>,<span class="st">"mgcv"</span>,<span class="st">"pracma"</span>,<span class="st">"pheatmap"</span>,</span>
<span id="cb48-126"><a href="#cb48-126" aria-hidden="true" tabindex="-1"></a>  <span class="st">"lme4"</span>,<span class="st">"lmerTest"</span>,<span class="st">"emmeans"</span>,<span class="st">"multcompView"</span>,</span>
<span id="cb48-127"><a href="#cb48-127" aria-hidden="true" tabindex="-1"></a>  <span class="st">"cowplot"</span>,<span class="st">"ggrepel"</span>,<span class="st">"ggdendro"</span>,<span class="st">"patchwork"</span>,</span>
<span id="cb48-128"><a href="#cb48-128" aria-hidden="true" tabindex="-1"></a>  <span class="st">"DHARMa"</span>,<span class="st">"stringr"</span>,<span class="st">"glue"</span></span>
<span id="cb48-129"><a href="#cb48-129" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-130"><a href="#cb48-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-131"><a href="#cb48-131" aria-hidden="true" tabindex="-1"></a>to_install <span class="ot">&lt;-</span> pkgs[<span class="sc">!</span>pkgs <span class="sc">%in%</span> <span class="fu">rownames</span>(<span class="fu">installed.packages</span>())]</span>
<span id="cb48-132"><a href="#cb48-132" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(to_install) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">install.packages</span>(to_install, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-133"><a href="#cb48-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-134"><a href="#cb48-134" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb48-135"><a href="#cb48-135" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb48-136"><a href="#cb48-136" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb48-137"><a href="#cb48-137" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb48-138"><a href="#cb48-138" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb48-139"><a href="#cb48-139" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb48-140"><a href="#cb48-140" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb48-141"><a href="#cb48-141" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pracma)</span>
<span id="cb48-142"><a href="#cb48-142" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pheatmap)</span>
<span id="cb48-143"><a href="#cb48-143" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb48-144"><a href="#cb48-144" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmerTest)</span>
<span id="cb48-145"><a href="#cb48-145" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emmeans)</span>
<span id="cb48-146"><a href="#cb48-146" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(multcompView)</span>
<span id="cb48-147"><a href="#cb48-147" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb48-148"><a href="#cb48-148" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggrepel)</span>
<span id="cb48-149"><a href="#cb48-149" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggdendro)</span>
<span id="cb48-150"><a href="#cb48-150" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb48-151"><a href="#cb48-151" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DHARMa)</span>
<span id="cb48-152"><a href="#cb48-152" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb48-153"><a href="#cb48-153" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb48-154"><a href="#cb48-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-155"><a href="#cb48-155" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_classic</span>(<span class="at">base_size =</span> <span class="dv">14</span>))</span>
<span id="cb48-156"><a href="#cb48-156" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-157"><a href="#cb48-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-158"><a href="#cb48-158" aria-hidden="true" tabindex="-1"></a><span class="fu">### User settings</span></span>
<span id="cb48-159"><a href="#cb48-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-162"><a href="#cb48-162" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-163"><a href="#cb48-163" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup-settings</span></span>
<span id="cb48-164"><a href="#cb48-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-165"><a href="#cb48-165" aria-hidden="true" tabindex="-1"></a>file_path  <span class="ot">&lt;-</span> <span class="st">"maize_bipolaris.csv"</span></span>
<span id="cb48-166"><a href="#cb48-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-167"><a href="#cb48-167" aria-hidden="true" tabindex="-1"></a><span class="co"># Data window (as in your script)</span></span>
<span id="cb48-168"><a href="#cb48-168" aria-hidden="true" tabindex="-1"></a>dae_min <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb48-169"><a href="#cb48-169" aria-hidden="true" tabindex="-1"></a>dae_max <span class="ot">&lt;-</span> <span class="dv">116</span></span>
<span id="cb48-170"><a href="#cb48-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-171"><a href="#cb48-171" aria-hidden="true" tabindex="-1"></a><span class="co"># Minimum number of assessments per curve_id to retain</span></span>
<span id="cb48-172"><a href="#cb48-172" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: your header comment said 8, but the code used 5. Keep as a parameter here.</span></span>
<span id="cb48-173"><a href="#cb48-173" aria-hidden="true" tabindex="-1"></a>min_assess <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb48-174"><a href="#cb48-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-175"><a href="#cb48-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Beta boundary adjustment</span></span>
<span id="cb48-176"><a href="#cb48-176" aria-hidden="true" tabindex="-1"></a>eps <span class="ot">&lt;-</span> <span class="fl">1e-4</span></span>
<span id="cb48-177"><a href="#cb48-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-178"><a href="#cb48-178" aria-hidden="true" tabindex="-1"></a><span class="co"># Functional clustering</span></span>
<span id="cb48-179"><a href="#cb48-179" aria-hidden="true" tabindex="-1"></a>k_clusters <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb48-180"><a href="#cb48-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-181"><a href="#cb48-181" aria-hidden="true" tabindex="-1"></a><span class="co"># Time grid for functional distances / plots</span></span>
<span id="cb48-182"><a href="#cb48-182" aria-hidden="true" tabindex="-1"></a>grid_n <span class="ot">&lt;-</span> <span class="dv">140</span></span>
<span id="cb48-183"><a href="#cb48-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-184"><a href="#cb48-184" aria-hidden="true" tabindex="-1"></a><span class="co"># Reference environment used for "environment-adjusted" mean curves</span></span>
<span id="cb48-185"><a href="#cb48-185" aria-hidden="true" tabindex="-1"></a><span class="co"># (your original code used the first level; keep that default)</span></span>
<span id="cb48-186"><a href="#cb48-186" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-187"><a href="#cb48-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-188"><a href="#cb48-188" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb48-189"><a href="#cb48-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-190"><a href="#cb48-190" aria-hidden="true" tabindex="-1"></a><span class="fu">## Read and prepare data</span></span>
<span id="cb48-191"><a href="#cb48-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-194"><a href="#cb48-194" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-195"><a href="#cb48-195" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: data-read</span></span>
<span id="cb48-196"><a href="#cb48-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-197"><a href="#cb48-197" aria-hidden="true" tabindex="-1"></a>dat0 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb48-198"><a href="#cb48-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-199"><a href="#cb48-199" aria-hidden="true" tabindex="-1"></a>dat0 <span class="ot">&lt;-</span> dat0 <span class="sc">|&gt;</span></span>
<span id="cb48-200"><a href="#cb48-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(DAE <span class="sc">&lt;</span> dae_max, DAE <span class="sc">&gt;</span> dae_min)</span>
<span id="cb48-201"><a href="#cb48-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-202"><a href="#cb48-202" aria-hidden="true" tabindex="-1"></a><span class="co"># Expected columns: Ambiente, Hibrido, Parcela, DAE, Bipolaris</span></span>
<span id="cb48-203"><a href="#cb48-203" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat0 <span class="sc">%&gt;%</span></span>
<span id="cb48-204"><a href="#cb48-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb48-205"><a href="#cb48-205" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ambiente  =</span> <span class="fu">factor</span>(Ambiente),</span>
<span id="cb48-206"><a href="#cb48-206" aria-hidden="true" tabindex="-1"></a>    <span class="at">Hibrido   =</span> <span class="fu">factor</span>(Hibrido),</span>
<span id="cb48-207"><a href="#cb48-207" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-208"><a href="#cb48-208" aria-hidden="true" tabindex="-1"></a>    <span class="at">DAE       =</span> <span class="fu">as.numeric</span>(DAE),</span>
<span id="cb48-209"><a href="#cb48-209" aria-hidden="true" tabindex="-1"></a>    <span class="at">bipolaris =</span> <span class="fu">as.numeric</span>(Bipolaris) <span class="sc">/</span> <span class="dv">100</span>  <span class="co"># % -&gt; proportion</span></span>
<span id="cb48-210"><a href="#cb48-210" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb48-211"><a href="#cb48-211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Ambiente), <span class="sc">!</span><span class="fu">is.na</span>(Hibrido), </span>
<span id="cb48-212"><a href="#cb48-212" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span><span class="fu">is.na</span>(DAE), <span class="sc">!</span><span class="fu">is.na</span>(bipolaris)) <span class="sc">%&gt;%</span></span>
<span id="cb48-213"><a href="#cb48-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-214"><a href="#cb48-214" aria-hidden="true" tabindex="-1"></a>    <span class="at">curve_id =</span> <span class="fu">interaction</span>(Ambiente, Hibrido), <span class="at">drop =</span> <span class="cn">TRUE</span>, <span class="at">sep =</span> <span class="st">"|"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb48-215"><a href="#cb48-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(curve_id, DAE)</span>
<span id="cb48-216"><a href="#cb48-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-217"><a href="#cb48-217" aria-hidden="true" tabindex="-1"></a><span class="co"># Retain curves with at least min_assess time points</span></span>
<span id="cb48-218"><a href="#cb48-218" aria-hidden="true" tabindex="-1"></a>curve_n <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">count</span>(curve_id, <span class="at">name =</span> <span class="st">"n_assess"</span>)</span>
<span id="cb48-219"><a href="#cb48-219" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb48-220"><a href="#cb48-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(curve_n, <span class="at">by =</span> <span class="st">"curve_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb48-221"><a href="#cb48-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_assess <span class="sc">&gt;=</span> min_assess) <span class="sc">%&gt;%</span></span>
<span id="cb48-222"><a href="#cb48-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>n_assess)</span>
<span id="cb48-223"><a href="#cb48-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-224"><a href="#cb48-224" aria-hidden="true" tabindex="-1"></a><span class="co"># Beta regression requires 0 &lt; y &lt; 1</span></span>
<span id="cb48-225"><a href="#cb48-225" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb48-226"><a href="#cb48-226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(bipolaris, eps), <span class="dv">1</span> <span class="sc">-</span> eps))</span>
<span id="cb48-227"><a href="#cb48-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-228"><a href="#cb48-228" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Rows: "</span>, <span class="fu">nrow</span>(dat),</span>
<span id="cb48-229"><a href="#cb48-229" aria-hidden="true" tabindex="-1"></a>        <span class="st">" | curves: "</span>, <span class="fu">n_distinct</span>(dat<span class="sc">$</span>curve_id),</span>
<span id="cb48-230"><a href="#cb48-230" aria-hidden="true" tabindex="-1"></a>        <span class="st">" | hybrids: "</span>, <span class="fu">n_distinct</span>(dat<span class="sc">$</span>Hibrido),</span>
<span id="cb48-231"><a href="#cb48-231" aria-hidden="true" tabindex="-1"></a>        <span class="st">" | envs: "</span>, <span class="fu">n_distinct</span>(dat<span class="sc">$</span>Ambiente))</span>
<span id="cb48-232"><a href="#cb48-232" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-233"><a href="#cb48-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-234"><a href="#cb48-234" aria-hidden="true" tabindex="-1"></a><span class="fu">### Optional: join hybrid resistance class</span></span>
<span id="cb48-235"><a href="#cb48-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-238"><a href="#cb48-238" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-239"><a href="#cb48-239" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: data-resistance</span></span>
<span id="cb48-240"><a href="#cb48-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-241"><a href="#cb48-241" aria-hidden="true" tabindex="-1"></a>bipolaris_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb48-242"><a href="#cb48-242" aria-hidden="true" tabindex="-1"></a>  <span class="at">Hibrido =</span> <span class="fu">c</span>(</span>
<span id="cb48-243"><a href="#cb48-243" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AG 8701 PRO4"</span>,<span class="st">"AG 8707 PRO4"</span>,<span class="st">"AG 9021 PRO3"</span>,<span class="st">"AS 1757 PRO4"</span>,<span class="st">"AS 1868 PRO4"</span>,</span>
<span id="cb48-244"><a href="#cb48-244" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AS 1955 PRO4"</span>,<span class="st">"B 2801 PWU"</span>,<span class="st">"CRWX03"</span>,<span class="st">"DKB 230 PRO3"</span>,<span class="st">"DKB 242 PRO4"</span>,</span>
<span id="cb48-245"><a href="#cb48-245" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MG 616 PWU"</span>,<span class="st">"P 3016 VYHR"</span>,<span class="st">"T 1503 PWU"</span></span>
<span id="cb48-246"><a href="#cb48-246" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb48-247"><a href="#cb48-247" aria-hidden="true" tabindex="-1"></a>  <span class="at">resistance =</span> <span class="fu">c</span>(<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"R"</span>,<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"R"</span>,<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"R"</span>,<span class="st">"MR"</span>),</span>
<span id="cb48-248"><a href="#cb48-248" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb48-249"><a href="#cb48-249" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-250"><a href="#cb48-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-251"><a href="#cb48-251" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb48-252"><a href="#cb48-252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(bipolaris_df, <span class="at">by =</span> <span class="st">"Hibrido"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb48-253"><a href="#cb48-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb48-254"><a href="#cb48-254" aria-hidden="true" tabindex="-1"></a>    <span class="at">y          =</span> <span class="fu">as.numeric</span>(y),</span>
<span id="cb48-255"><a href="#cb48-255" aria-hidden="true" tabindex="-1"></a>    <span class="at">DAE        =</span> <span class="fu">as.numeric</span>(DAE),</span>
<span id="cb48-256"><a href="#cb48-256" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ambiente   =</span> <span class="fu">factor</span>(Ambiente),</span>
<span id="cb48-257"><a href="#cb48-257" aria-hidden="true" tabindex="-1"></a>    <span class="at">Hibrido    =</span> <span class="fu">factor</span>(Hibrido),</span>
<span id="cb48-258"><a href="#cb48-258" aria-hidden="true" tabindex="-1"></a>    <span class="at">curve_id   =</span> <span class="fu">factor</span>(curve_id),</span>
<span id="cb48-259"><a href="#cb48-259" aria-hidden="true" tabindex="-1"></a>    <span class="at">resistance =</span> <span class="fu">factor</span>(resistance)</span>
<span id="cb48-260"><a href="#cb48-260" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb48-261"><a href="#cb48-261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb48-262"><a href="#cb48-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-263"><a href="#cb48-263" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(dat)</span>
<span id="cb48-264"><a href="#cb48-264" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> </span>
<span id="cb48-265"><a href="#cb48-265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ambiente) <span class="sc">|&gt;</span> </span>
<span id="cb48-266"><a href="#cb48-266" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(DAE)</span>
<span id="cb48-267"><a href="#cb48-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-268"><a href="#cb48-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-269"><a href="#cb48-269" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-270"><a href="#cb48-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-271"><a href="#cb48-271" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb48-272"><a href="#cb48-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-273"><a href="#cb48-273" aria-hidden="true" tabindex="-1"></a><span class="fu">## Helper functions (scalars)</span></span>
<span id="cb48-274"><a href="#cb48-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-277"><a href="#cb48-277" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-278"><a href="#cb48-278" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: helpers-scalars</span></span>
<span id="cb48-279"><a href="#cb48-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-280"><a href="#cb48-280" aria-hidden="true" tabindex="-1"></a><span class="co"># T50: time when y reaches 0.5*ymax (linear interpolation)</span></span>
<span id="cb48-281"><a href="#cb48-281" aria-hidden="true" tabindex="-1"></a>t50_interp <span class="ot">&lt;-</span> <span class="cf">function</span>(time, y){</span>
<span id="cb48-282"><a href="#cb48-282" aria-hidden="true" tabindex="-1"></a>  o <span class="ot">&lt;-</span> <span class="fu">order</span>(time)</span>
<span id="cb48-283"><a href="#cb48-283" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> time[o]; y <span class="ot">&lt;-</span> y[o]</span>
<span id="cb48-284"><a href="#cb48-284" aria-hidden="true" tabindex="-1"></a>  ymax <span class="ot">&lt;-</span> <span class="fu">max</span>(y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-285"><a href="#cb48-285" aria-hidden="true" tabindex="-1"></a>  thr  <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> ymax</span>
<span id="cb48-286"><a href="#cb48-286" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">all</span>(y <span class="sc">&lt;</span> thr, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="fu">return</span>(<span class="cn">NA_real_</span>)</span>
<span id="cb48-287"><a href="#cb48-287" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> <span class="fu">which</span>(y <span class="sc">&gt;=</span> thr)[<span class="dv">1</span>]</span>
<span id="cb48-288"><a href="#cb48-288" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(k <span class="sc">==</span> <span class="dv">1</span>) <span class="fu">return</span>(time[<span class="dv">1</span>])</span>
<span id="cb48-289"><a href="#cb48-289" aria-hidden="true" tabindex="-1"></a>  t1 <span class="ot">&lt;-</span> time[k<span class="dv">-1</span>]; t2 <span class="ot">&lt;-</span> time[k]</span>
<span id="cb48-290"><a href="#cb48-290" aria-hidden="true" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> y[k<span class="dv">-1</span>];    y2 <span class="ot">&lt;-</span> y[k]</span>
<span id="cb48-291"><a href="#cb48-291" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">isTRUE</span>(<span class="fu">all.equal</span>(y2, y1))) <span class="fu">return</span>(t2)</span>
<span id="cb48-292"><a href="#cb48-292" aria-hidden="true" tabindex="-1"></a>  t1 <span class="sc">+</span> (thr <span class="sc">-</span> y1) <span class="sc">*</span> (t2 <span class="sc">-</span> t1) <span class="sc">/</span> (y2 <span class="sc">-</span> y1)</span>
<span id="cb48-293"><a href="#cb48-293" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-294"><a href="#cb48-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-295"><a href="#cb48-295" aria-hidden="true" tabindex="-1"></a><span class="co"># Logistic fit: y(t)=K/(1+exp(-r(t-t0))) and r_norm = r*(tmax-tmin)</span></span>
<span id="cb48-296"><a href="#cb48-296" aria-hidden="true" tabindex="-1"></a>logistic_fit_rate <span class="ot">&lt;-</span> <span class="cf">function</span>(time, y){</span>
<span id="cb48-297"><a href="#cb48-297" aria-hidden="true" tabindex="-1"></a>  o <span class="ot">&lt;-</span> <span class="fu">order</span>(time)</span>
<span id="cb48-298"><a href="#cb48-298" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> time[o]; y <span class="ot">&lt;-</span> y[o]</span>
<span id="cb48-299"><a href="#cb48-299" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(y, <span class="fl">1e-4</span>), <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1e-4</span>)</span>
<span id="cb48-300"><a href="#cb48-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-301"><a href="#cb48-301" aria-hidden="true" tabindex="-1"></a>  K0  <span class="ot">&lt;-</span> <span class="fu">max</span>(y)</span>
<span id="cb48-302"><a href="#cb48-302" aria-hidden="true" tabindex="-1"></a>  d   <span class="ot">&lt;-</span> <span class="fu">diff</span>(y)</span>
<span id="cb48-303"><a href="#cb48-303" aria-hidden="true" tabindex="-1"></a>  t00 <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="fu">length</span>(d) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">any</span>(<span class="fu">is.finite</span>(d))) time[<span class="fu">which.max</span>(d) <span class="sc">+</span> <span class="dv">1</span>] <span class="cf">else</span> <span class="fu">median</span>(time)</span>
<span id="cb48-304"><a href="#cb48-304" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.na</span>(t00)) t00 <span class="ot">&lt;-</span> <span class="fu">median</span>(time)</span>
<span id="cb48-305"><a href="#cb48-305" aria-hidden="true" tabindex="-1"></a>  r0  <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb48-306"><a href="#cb48-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-307"><a href="#cb48-307" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb48-308"><a href="#cb48-308" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nls</span>(</span>
<span id="cb48-309"><a href="#cb48-309" aria-hidden="true" tabindex="-1"></a>      y <span class="sc">~</span> K <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>r <span class="sc">*</span> (time <span class="sc">-</span> t0))),</span>
<span id="cb48-310"><a href="#cb48-310" aria-hidden="true" tabindex="-1"></a>      <span class="at">start =</span> <span class="fu">list</span>(<span class="at">K =</span> K0, <span class="at">r =</span> r0, <span class="at">t0 =</span> t00),</span>
<span id="cb48-311"><a href="#cb48-311" aria-hidden="true" tabindex="-1"></a>      <span class="at">control =</span> <span class="fu">nls.control</span>(<span class="at">maxiter =</span> <span class="dv">200</span>, <span class="at">warnOnly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-312"><a href="#cb48-312" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb48-313"><a href="#cb48-313" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb48-314"><a href="#cb48-314" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-315"><a href="#cb48-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-316"><a href="#cb48-316" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(f)) <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">r =</span> <span class="cn">NA_real_</span>, <span class="at">K =</span> <span class="cn">NA_real_</span>, <span class="at">t0 =</span> <span class="cn">NA_real_</span>, <span class="at">r_norm =</span> <span class="cn">NA_real_</span>))</span>
<span id="cb48-317"><a href="#cb48-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-318"><a href="#cb48-318" aria-hidden="true" tabindex="-1"></a>  co  <span class="ot">&lt;-</span> <span class="fu">coef</span>(f)</span>
<span id="cb48-319"><a href="#cb48-319" aria-hidden="true" tabindex="-1"></a>  r   <span class="ot">&lt;-</span> <span class="fu">unname</span>(co[<span class="st">"r"</span>])</span>
<span id="cb48-320"><a href="#cb48-320" aria-hidden="true" tabindex="-1"></a>  K   <span class="ot">&lt;-</span> <span class="fu">unname</span>(co[<span class="st">"K"</span>])</span>
<span id="cb48-321"><a href="#cb48-321" aria-hidden="true" tabindex="-1"></a>  t0  <span class="ot">&lt;-</span> <span class="fu">unname</span>(co[<span class="st">"t0"</span>])</span>
<span id="cb48-322"><a href="#cb48-322" aria-hidden="true" tabindex="-1"></a>  dur <span class="ot">&lt;-</span> <span class="fu">max</span>(time) <span class="sc">-</span> <span class="fu">min</span>(time)</span>
<span id="cb48-323"><a href="#cb48-323" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">r =</span> r, <span class="at">K =</span> K, <span class="at">t0 =</span> t0, <span class="at">r_norm =</span> r <span class="sc">*</span> dur)</span>
<span id="cb48-324"><a href="#cb48-324" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-325"><a href="#cb48-325" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-326"><a href="#cb48-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-327"><a href="#cb48-327" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb48-328"><a href="#cb48-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-329"><a href="#cb48-329" aria-hidden="true" tabindex="-1"></a><span class="fu">## Per-curve scalar metrics (AUDPC, final, T50, r_norm)</span></span>
<span id="cb48-330"><a href="#cb48-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-333"><a href="#cb48-333" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-334"><a href="#cb48-334" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: scalars-per-curve</span></span>
<span id="cb48-335"><a href="#cb48-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-336"><a href="#cb48-336" aria-hidden="true" tabindex="-1"></a>curve_stats <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb48-337"><a href="#cb48-337" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(curve_id, Ambiente, Hibrido) <span class="sc">%&gt;%</span></span>
<span id="cb48-338"><a href="#cb48-338" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb48-339"><a href="#cb48-339" aria-hidden="true" tabindex="-1"></a>    <span class="at">AUDPC     =</span> pracma<span class="sc">::</span><span class="fu">trapz</span>(DAE, y),</span>
<span id="cb48-340"><a href="#cb48-340" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_sev =</span> y[<span class="fu">which.max</span>(DAE)],</span>
<span id="cb48-341"><a href="#cb48-341" aria-hidden="true" tabindex="-1"></a>    <span class="at">T50       =</span> <span class="fu">t50_interp</span>(DAE, y),</span>
<span id="cb48-342"><a href="#cb48-342" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups   =</span> <span class="st">"drop"</span></span>
<span id="cb48-343"><a href="#cb48-343" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-344"><a href="#cb48-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-345"><a href="#cb48-345" aria-hidden="true" tabindex="-1"></a>rate_df <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(<span class="fu">unique</span>(curve_stats<span class="sc">$</span>curve_id), <span class="cf">function</span>(cid){</span>
<span id="cb48-346"><a href="#cb48-346" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">filter</span>(curve_id <span class="sc">==</span> cid)</span>
<span id="cb48-347"><a href="#cb48-347" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logistic_fit_rate</span>(df<span class="sc">$</span>DAE, df<span class="sc">$</span>y) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">curve_id =</span> <span class="fu">as.character</span>(cid))</span>
<span id="cb48-348"><a href="#cb48-348" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb48-349"><a href="#cb48-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-350"><a href="#cb48-350" aria-hidden="true" tabindex="-1"></a>curve_stats <span class="ot">&lt;-</span> curve_stats <span class="sc">%&gt;%</span></span>
<span id="cb48-351"><a href="#cb48-351" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">curve_id =</span> <span class="fu">as.character</span>(curve_id)) <span class="sc">%&gt;%</span></span>
<span id="cb48-352"><a href="#cb48-352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(rate_df, <span class="at">by =</span> <span class="st">"curve_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb48-353"><a href="#cb48-353" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(T50), <span class="fu">is.finite</span>(r_norm))</span>
<span id="cb48-354"><a href="#cb48-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-355"><a href="#cb48-355" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Curves with all scalar metrics: "</span>, <span class="fu">nrow</span>(curve_stats))</span>
<span id="cb48-356"><a href="#cb48-356" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-357"><a href="#cb48-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-358"><a href="#cb48-358" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb48-359"><a href="#cb48-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-360"><a href="#cb48-360" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hierarchical beta-GAM (HGAM) for smoothing and adjustment</span></span>
<span id="cb48-361"><a href="#cb48-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-362"><a href="#cb48-362" aria-hidden="true" tabindex="-1"></a>Model specification (as in your script):</span>
<span id="cb48-363"><a href="#cb48-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-364"><a href="#cb48-364" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>$s(\mathrm{DAE})$ global mean epidemic shape\</span>
<span id="cb48-365"><a href="#cb48-365" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>$s(\mathrm{DAE}, \mathrm{Ambiente}, \mathrm{bs}=\mathrm{fs})$ environment-specific deviation (random smooth)\</span>
<span id="cb48-366"><a href="#cb48-366" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>$s(\mathrm{DAE}, \mathrm{Hibrido}, \mathrm{bs}=\mathrm{fs})$ hybrid-specific deviation (random smooth)\</span>
<span id="cb48-367"><a href="#cb48-367" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>$s(\mathrm{curve<span class="sc">\_</span>id}, \mathrm{bs}=\mathrm{re})$ curve-level random intercept</span>
<span id="cb48-368"><a href="#cb48-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-371"><a href="#cb48-371" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-372"><a href="#cb48-372" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: gam-fit</span></span>
<span id="cb48-373"><a href="#cb48-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-374"><a href="#cb48-374" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb48-375"><a href="#cb48-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-376"><a href="#cb48-376" aria-hidden="true" tabindex="-1"></a>m_gam <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">bam</span>(</span>
<span id="cb48-377"><a href="#cb48-377" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="fu">s</span>(DAE, <span class="at">k =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb48-378"><a href="#cb48-378" aria-hidden="true" tabindex="-1"></a>    <span class="fu">s</span>(DAE, Ambiente, <span class="at">bs =</span> <span class="st">"fs"</span>, <span class="at">k =</span> <span class="dv">4</span>, <span class="at">m =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb48-379"><a href="#cb48-379" aria-hidden="true" tabindex="-1"></a>    <span class="fu">s</span>(DAE, Hibrido,  <span class="at">bs =</span> <span class="st">"fs"</span>, <span class="at">k =</span> <span class="dv">4</span>, <span class="at">m =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb48-380"><a href="#cb48-380" aria-hidden="true" tabindex="-1"></a>    <span class="fu">s</span>(curve_id, <span class="at">bs =</span> <span class="st">"re"</span>),</span>
<span id="cb48-381"><a href="#cb48-381" aria-hidden="true" tabindex="-1"></a>  <span class="at">family   =</span> mgcv<span class="sc">::</span><span class="fu">betar</span>(<span class="at">link =</span> <span class="st">"logit"</span>),</span>
<span id="cb48-382"><a href="#cb48-382" aria-hidden="true" tabindex="-1"></a>  <span class="at">data     =</span> dat,</span>
<span id="cb48-383"><a href="#cb48-383" aria-hidden="true" tabindex="-1"></a>  <span class="at">method   =</span> <span class="st">"fREML"</span>,</span>
<span id="cb48-384"><a href="#cb48-384" aria-hidden="true" tabindex="-1"></a>  <span class="at">discrete =</span> <span class="cn">TRUE</span>,</span>
<span id="cb48-385"><a href="#cb48-385" aria-hidden="true" tabindex="-1"></a>  <span class="at">gamma    =</span> <span class="fl">1.4</span>,</span>
<span id="cb48-386"><a href="#cb48-386" aria-hidden="true" tabindex="-1"></a>  <span class="at">select   =</span> <span class="cn">TRUE</span></span>
<span id="cb48-387"><a href="#cb48-387" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-388"><a href="#cb48-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-389"><a href="#cb48-389" aria-hidden="true" tabindex="-1"></a>mgcv<span class="sc">::</span><span class="fu">gam.check</span>(m_gam)</span>
<span id="cb48-390"><a href="#cb48-390" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(m_gam)</span>
<span id="cb48-391"><a href="#cb48-391" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_gam)</span>
<span id="cb48-392"><a href="#cb48-392" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-393"><a href="#cb48-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-394"><a href="#cb48-394" aria-hidden="true" tabindex="-1"></a><span class="fu">### Diagnostics (observed vs fitted and residuals)</span></span>
<span id="cb48-395"><a href="#cb48-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-398"><a href="#cb48-398" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-399"><a href="#cb48-399" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: gam-diagnostics</span></span>
<span id="cb48-400"><a href="#cb48-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-401"><a href="#cb48-401" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>mu_hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(m_gam, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb48-402"><a href="#cb48-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-403"><a href="#cb48-403" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(mu_hat, y)) <span class="sc">+</span></span>
<span id="cb48-404"><a href="#cb48-404" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb48-405"><a href="#cb48-405" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb48-406"><a href="#cb48-406" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Fitted"</span>, <span class="at">y =</span> <span class="st">"Observed"</span>)</span>
<span id="cb48-407"><a href="#cb48-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-408"><a href="#cb48-408" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">residuals</span>(m_gam, <span class="at">type =</span> <span class="st">"pearson"</span>)</span>
<span id="cb48-409"><a href="#cb48-409" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dat<span class="sc">$</span>DAE, res)</span>
<span id="cb48-410"><a href="#cb48-410" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb48-411"><a href="#cb48-411" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-412"><a href="#cb48-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-413"><a href="#cb48-413" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb48-414"><a href="#cb48-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-415"><a href="#cb48-415" aria-hidden="true" tabindex="-1"></a><span class="fu">## Environment-adjusted hybrid mean curves</span></span>
<span id="cb48-416"><a href="#cb48-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-417"><a href="#cb48-417" aria-hidden="true" tabindex="-1"></a>We obtain hybrid mean curves on a regular grid **excluding**:</span>
<span id="cb48-418"><a href="#cb48-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-419"><a href="#cb48-419" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>the environment random smooth term <span class="in">`s(DAE,Ambiente)`</span></span>
<span id="cb48-420"><a href="#cb48-420" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>the curve random intercept <span class="in">`s(curve_id)`</span></span>
<span id="cb48-421"><a href="#cb48-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-422"><a href="#cb48-422" aria-hidden="true" tabindex="-1"></a>so each hybrid is represented at a chosen reference environment level.</span>
<span id="cb48-423"><a href="#cb48-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-426"><a href="#cb48-426" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-427"><a href="#cb48-427" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: pred-hybrid-curves</span></span>
<span id="cb48-428"><a href="#cb48-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-429"><a href="#cb48-429" aria-hidden="true" tabindex="-1"></a>t_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(dat<span class="sc">$</span>DAE), <span class="fu">max</span>(dat<span class="sc">$</span>DAE), <span class="at">length.out =</span> grid_n)</span>
<span id="cb48-430"><a href="#cb48-430" aria-hidden="true" tabindex="-1"></a>env_ref <span class="ot">&lt;-</span> <span class="fu">levels</span>(dat<span class="sc">$</span>Ambiente)[<span class="dv">1</span>]</span>
<span id="cb48-431"><a href="#cb48-431" aria-hidden="true" tabindex="-1"></a>cultivars <span class="ot">&lt;-</span> <span class="fu">levels</span>(dat<span class="sc">$</span>Hibrido)</span>
<span id="cb48-432"><a href="#cb48-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-433"><a href="#cb48-433" aria-hidden="true" tabindex="-1"></a>pred_cult <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(cultivars, <span class="cf">function</span>(cv){</span>
<span id="cb48-434"><a href="#cb48-434" aria-hidden="true" tabindex="-1"></a>  newd <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb48-435"><a href="#cb48-435" aria-hidden="true" tabindex="-1"></a>    <span class="at">DAE      =</span> t_grid,</span>
<span id="cb48-436"><a href="#cb48-436" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ambiente =</span> <span class="fu">factor</span>(env_ref, <span class="at">levels =</span> <span class="fu">levels</span>(dat<span class="sc">$</span>Ambiente)),</span>
<span id="cb48-437"><a href="#cb48-437" aria-hidden="true" tabindex="-1"></a>    <span class="at">Hibrido  =</span> <span class="fu">factor</span>(cv, <span class="at">levels =</span> <span class="fu">levels</span>(dat<span class="sc">$</span>Hibrido)),</span>
<span id="cb48-438"><a href="#cb48-438" aria-hidden="true" tabindex="-1"></a>    <span class="at">curve_id =</span> dat<span class="sc">$</span>curve_id[<span class="dv">1</span>]  <span class="co"># dummy; excluded below</span></span>
<span id="cb48-439"><a href="#cb48-439" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-440"><a href="#cb48-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-441"><a href="#cb48-441" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb48-442"><a href="#cb48-442" aria-hidden="true" tabindex="-1"></a>    m_gam, <span class="at">newdata =</span> newd, <span class="at">type =</span> <span class="st">"response"</span>,</span>
<span id="cb48-443"><a href="#cb48-443" aria-hidden="true" tabindex="-1"></a>    <span class="at">exclude =</span> <span class="fu">c</span>(<span class="st">"s(DAE,Ambiente)"</span>, <span class="st">"s(curve_id)"</span>)</span>
<span id="cb48-444"><a href="#cb48-444" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-445"><a href="#cb48-445" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">Hibrido =</span> cv, <span class="at">DAE =</span> t_grid, <span class="at">mu =</span> <span class="fu">as.numeric</span>(mu))</span>
<span id="cb48-446"><a href="#cb48-446" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb48-447"><a href="#cb48-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-448"><a href="#cb48-448" aria-hidden="true" tabindex="-1"></a>cult_score <span class="ot">&lt;-</span> pred_cult <span class="sc">%&gt;%</span></span>
<span id="cb48-449"><a href="#cb48-449" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Hibrido) <span class="sc">%&gt;%</span></span>
<span id="cb48-450"><a href="#cb48-450" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_mu =</span> <span class="fu">mean</span>(mu), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb48-451"><a href="#cb48-451" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(mean_mu)</span>
<span id="cb48-452"><a href="#cb48-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-453"><a href="#cb48-453" aria-hidden="true" tabindex="-1"></a>cult_score</span>
<span id="cb48-454"><a href="#cb48-454" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-455"><a href="#cb48-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-456"><a href="#cb48-456" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb48-457"><a href="#cb48-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-458"><a href="#cb48-458" aria-hidden="true" tabindex="-1"></a><span class="fu">## Functional distance among hybrids + clustering</span></span>
<span id="cb48-459"><a href="#cb48-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-460"><a href="#cb48-460" aria-hidden="true" tabindex="-1"></a><span class="fu">### Utility: shorten hybrid labels</span></span>
<span id="cb48-461"><a href="#cb48-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-464"><a href="#cb48-464" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-465"><a href="#cb48-465" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: utils-short-label</span></span>
<span id="cb48-466"><a href="#cb48-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-467"><a href="#cb48-467" aria-hidden="true" tabindex="-1"></a>shorten_hybrid <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb48-468"><a href="#cb48-468" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" PRO[0-9]+| PWU| VYHR"</span>, <span class="st">""</span>, x)</span>
<span id="cb48-469"><a href="#cb48-469" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">""</span>, x)</span>
<span id="cb48-470"><a href="#cb48-470" aria-hidden="true" tabindex="-1"></a>  x</span>
<span id="cb48-471"><a href="#cb48-471" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-472"><a href="#cb48-472" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-473"><a href="#cb48-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-474"><a href="#cb48-474" aria-hidden="true" tabindex="-1"></a><span class="fu">### Build distance matrix and cluster</span></span>
<span id="cb48-475"><a href="#cb48-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-478"><a href="#cb48-478" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-479"><a href="#cb48-479" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: functional-distance</span></span>
<span id="cb48-480"><a href="#cb48-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-481"><a href="#cb48-481" aria-hidden="true" tabindex="-1"></a><span class="co"># Wide matrix: rows = time, cols = hybrid</span></span>
<span id="cb48-482"><a href="#cb48-482" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> pred_cult <span class="sc">%&gt;%</span></span>
<span id="cb48-483"><a href="#cb48-483" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(DAE, Hibrido, mu) <span class="sc">%&gt;%</span></span>
<span id="cb48-484"><a href="#cb48-484" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> Hibrido, <span class="at">values_from =</span> mu) <span class="sc">%&gt;%</span></span>
<span id="cb48-485"><a href="#cb48-485" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(DAE)</span>
<span id="cb48-486"><a href="#cb48-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-487"><a href="#cb48-487" aria-hidden="true" tabindex="-1"></a>dt_grid <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">diff</span>(mat<span class="sc">$</span>DAE))</span>
<span id="cb48-488"><a href="#cb48-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-489"><a href="#cb48-489" aria-hidden="true" tabindex="-1"></a>matX <span class="ot">&lt;-</span> mat <span class="sc">%&gt;%</span></span>
<span id="cb48-490"><a href="#cb48-490" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>DAE) <span class="sc">%&gt;%</span></span>
<span id="cb48-491"><a href="#cb48-491" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb48-492"><a href="#cb48-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-493"><a href="#cb48-493" aria-hidden="true" tabindex="-1"></a><span class="co"># Functional L2 distance (grid approximation)</span></span>
<span id="cb48-494"><a href="#cb48-494" aria-hidden="true" tabindex="-1"></a>D_cult <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(<span class="fu">t</span>(matX), <span class="at">method =</span> <span class="st">"euclidean"</span>)) <span class="sc">*</span> <span class="fu">sqrt</span>(dt_grid)</span>
<span id="cb48-495"><a href="#cb48-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-496"><a href="#cb48-496" aria-hidden="true" tabindex="-1"></a>hc <span class="ot">&lt;-</span> <span class="fu">hclust</span>(<span class="fu">as.dist</span>(D_cult), <span class="at">method =</span> <span class="st">"ward.D2"</span>)</span>
<span id="cb48-497"><a href="#cb48-497" aria-hidden="true" tabindex="-1"></a>cl_raw <span class="ot">&lt;-</span> <span class="fu">cutree</span>(hc, <span class="at">k =</span> k_clusters)</span>
<span id="cb48-498"><a href="#cb48-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-499"><a href="#cb48-499" aria-hidden="true" tabindex="-1"></a><span class="co"># Order clusters by mean severity (from cult_score)</span></span>
<span id="cb48-500"><a href="#cb48-500" aria-hidden="true" tabindex="-1"></a>cluster_rank_map <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">Hibrido =</span> <span class="fu">names</span>(cl_raw),</span>
<span id="cb48-501"><a href="#cb48-501" aria-hidden="true" tabindex="-1"></a>                           <span class="at">cluster_raw =</span> <span class="fu">as.integer</span>(cl_raw)) <span class="sc">%&gt;%</span></span>
<span id="cb48-502"><a href="#cb48-502" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(cult_score <span class="sc">%&gt;%</span> <span class="fu">select</span>(Hibrido, mean_mu), <span class="at">by =</span> <span class="st">"Hibrido"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb48-503"><a href="#cb48-503" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster_raw) <span class="sc">%&gt;%</span></span>
<span id="cb48-504"><a href="#cb48-504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">cluster_mean =</span> <span class="fu">mean</span>(mean_mu, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb48-505"><a href="#cb48-505" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(cluster_mean) <span class="sc">%&gt;%</span></span>
<span id="cb48-506"><a href="#cb48-506" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cluster =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb48-507"><a href="#cb48-507" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(cluster_raw, cluster)</span>
<span id="cb48-508"><a href="#cb48-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-509"><a href="#cb48-509" aria-hidden="true" tabindex="-1"></a>cluster_table2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">Hibrido =</span> <span class="fu">names</span>(cl_raw),</span>
<span id="cb48-510"><a href="#cb48-510" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cluster_raw =</span> <span class="fu">as.integer</span>(cl_raw)) <span class="sc">%&gt;%</span></span>
<span id="cb48-511"><a href="#cb48-511" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(cluster_rank_map, <span class="at">by =</span> <span class="st">"cluster_raw"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb48-512"><a href="#cb48-512" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(cult_score <span class="sc">%&gt;%</span> <span class="fu">select</span>(Hibrido, mean_mu), <span class="at">by =</span> <span class="st">"Hibrido"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb48-513"><a href="#cb48-513" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-514"><a href="#cb48-514" aria-hidden="true" tabindex="-1"></a>    <span class="at">phenotype =</span> <span class="fu">factor</span>(cluster,</span>
<span id="cb48-515"><a href="#cb48-515" aria-hidden="true" tabindex="-1"></a>                       <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span>k_clusters,</span>
<span id="cb48-516"><a href="#cb48-516" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> <span class="fu">paste0</span>(<span class="st">"P"</span>, <span class="dv">1</span><span class="sc">:</span>k_clusters))</span>
<span id="cb48-517"><a href="#cb48-517" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-518"><a href="#cb48-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-519"><a href="#cb48-519" aria-hidden="true" tabindex="-1"></a>cluster_table2</span>
<span id="cb48-520"><a href="#cb48-520" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-521"><a href="#cb48-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-522"><a href="#cb48-522" aria-hidden="true" tabindex="-1"></a><span class="fu">### Figure: mean curves by phenotype + dendrogram</span></span>
<span id="cb48-523"><a href="#cb48-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-526"><a href="#cb48-526" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-527"><a href="#cb48-527" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: figure-functional-panels</span></span>
<span id="cb48-528"><a href="#cb48-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-529"><a href="#cb48-529" aria-hidden="true" tabindex="-1"></a>cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#D55E00"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#009E73"</span>, <span class="st">"#CC79A7"</span>)[<span class="dv">1</span><span class="sc">:</span>k_clusters]</span>
<span id="cb48-530"><a href="#cb48-530" aria-hidden="true" tabindex="-1"></a>phen_cols <span class="ot">&lt;-</span> <span class="fu">setNames</span>(cols, <span class="fu">levels</span>(cluster_table2<span class="sc">$</span>phenotype))</span>
<span id="cb48-531"><a href="#cb48-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-532"><a href="#cb48-532" aria-hidden="true" tabindex="-1"></a>pred_cult2 <span class="ot">&lt;-</span> pred_cult <span class="sc">%&gt;%</span></span>
<span id="cb48-533"><a href="#cb48-533" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(cluster_table2 <span class="sc">%&gt;%</span> <span class="fu">select</span>(Hibrido, phenotype), <span class="at">by =</span> <span class="st">"Hibrido"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb48-534"><a href="#cb48-534" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hybrid_short =</span> <span class="fu">shorten_hybrid</span>(Hibrido))</span>
<span id="cb48-535"><a href="#cb48-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-536"><a href="#cb48-536" aria-hidden="true" tabindex="-1"></a>pred_cult2 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(pred_cult2, bipolaris_df)</span>
<span id="cb48-537"><a href="#cb48-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-538"><a href="#cb48-538" aria-hidden="true" tabindex="-1"></a>label_df <span class="ot">&lt;-</span> pred_cult2 <span class="sc">%&gt;%</span></span>
<span id="cb48-539"><a href="#cb48-539" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Hibrido) <span class="sc">%&gt;%</span></span>
<span id="cb48-540"><a href="#cb48-540" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(DAE <span class="sc">==</span> <span class="fu">max</span>(DAE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb48-541"><a href="#cb48-541" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb48-542"><a href="#cb48-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-543"><a href="#cb48-543" aria-hidden="true" tabindex="-1"></a>p_hibridos <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pred_cult2,</span>
<span id="cb48-544"><a href="#cb48-544" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">aes</span>(<span class="at">x =</span> DAE, <span class="at">y =</span> mu, <span class="at">group =</span> Hibrido, <span class="at">linetype  =</span> resistance, <span class="at">color =</span> phenotype)) <span class="sc">+</span></span>
<span id="cb48-545"><a href="#cb48-545" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.1</span>, <span class="at">alpha =</span> <span class="fl">0.95</span>) <span class="sc">+</span></span>
<span id="cb48-546"><a href="#cb48-546" aria-hidden="true" tabindex="-1"></a>  ggrepel<span class="sc">::</span><span class="fu">geom_text_repel</span>(</span>
<span id="cb48-547"><a href="#cb48-547" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> label_df,</span>
<span id="cb48-548"><a href="#cb48-548" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">label =</span> hybrid_short),</span>
<span id="cb48-549"><a href="#cb48-549" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">direction =</span> <span class="st">"y"</span>,</span>
<span id="cb48-550"><a href="#cb48-550" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_x =</span> <span class="dv">2</span>,</span>
<span id="cb48-551"><a href="#cb48-551" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">2.8</span>,</span>
<span id="cb48-552"><a href="#cb48-552" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb48-553"><a href="#cb48-553" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.size =</span> <span class="fl">0.2</span>,</span>
<span id="cb48-554"><a href="#cb48-554" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.alpha =</span> <span class="fl">0.6</span></span>
<span id="cb48-555"><a href="#cb48-555" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb48-556"><a href="#cb48-556" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_limits</span>(<span class="at">x =</span> <span class="fu">max</span>(pred_cult2<span class="sc">$</span>DAE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> <span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb48-557"><a href="#cb48-557" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> phen_cols, <span class="at">drop =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb48-558"><a href="#cb48-558" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Days after emergence (DAE)"</span>,</span>
<span id="cb48-559"><a href="#cb48-559" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Environment-adjusted mean severity"</span>,</span>
<span id="cb48-560"><a href="#cb48-560" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Phenotype"</span>, <span class="at">linetype =</span> <span class="st">"Resistance"</span>) <span class="sc">+</span></span>
<span id="cb48-561"><a href="#cb48-561" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb48-562"><a href="#cb48-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-563"><a href="#cb48-563" aria-hidden="true" tabindex="-1"></a>ddata <span class="ot">&lt;-</span> ggdendro<span class="sc">::</span><span class="fu">dendro_data</span>(<span class="fu">as.dendrogram</span>(hc), <span class="at">type =</span> <span class="st">"rectangle"</span>)</span>
<span id="cb48-564"><a href="#cb48-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-565"><a href="#cb48-565" aria-hidden="true" tabindex="-1"></a>lab_map <span class="ot">&lt;-</span> cluster_table2 <span class="sc">%&gt;%</span></span>
<span id="cb48-566"><a href="#cb48-566" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> Hibrido,</span>
<span id="cb48-567"><a href="#cb48-567" aria-hidden="true" tabindex="-1"></a>         <span class="at">label_short =</span> <span class="fu">shorten_hybrid</span>(Hibrido),</span>
<span id="cb48-568"><a href="#cb48-568" aria-hidden="true" tabindex="-1"></a>         <span class="at">lab_col =</span> phen_cols[<span class="fu">as.character</span>(phenotype)]) <span class="sc">%&gt;%</span></span>
<span id="cb48-569"><a href="#cb48-569" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(label, label_short, lab_col)</span>
<span id="cb48-570"><a href="#cb48-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-571"><a href="#cb48-571" aria-hidden="true" tabindex="-1"></a>lab_df <span class="ot">&lt;-</span> ddata<span class="sc">$</span>labels <span class="sc">%&gt;%</span></span>
<span id="cb48-572"><a href="#cb48-572" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(lab_map, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"label"</span> <span class="ot">=</span> <span class="st">"label"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb48-573"><a href="#cb48-573" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label_short =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(label_short), <span class="fu">shorten_hybrid</span>(label), label_short))</span>
<span id="cb48-574"><a href="#cb48-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-575"><a href="#cb48-575" aria-hidden="true" tabindex="-1"></a>p_dend <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb48-576"><a href="#cb48-576" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> ddata<span class="sc">$</span>segments,</span>
<span id="cb48-577"><a href="#cb48-577" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend),</span>
<span id="cb48-578"><a href="#cb48-578" aria-hidden="true" tabindex="-1"></a>               <span class="at">linewidth =</span> <span class="fl">0.45</span>) <span class="sc">+</span></span>
<span id="cb48-579"><a href="#cb48-579" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> lab_df,</span>
<span id="cb48-580"><a href="#cb48-580" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y <span class="sc">-</span> <span class="fl">0.02</span> <span class="sc">*</span> <span class="fu">max</span>(ddata<span class="sc">$</span>segments<span class="sc">$</span>y),</span>
<span id="cb48-581"><a href="#cb48-581" aria-hidden="true" tabindex="-1"></a>                <span class="at">label =</span> label_short, <span class="at">color =</span> <span class="fu">I</span>(lab_col)),</span>
<span id="cb48-582"><a href="#cb48-582" aria-hidden="true" tabindex="-1"></a>            <span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb48-583"><a href="#cb48-583" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Functional distance"</span>) <span class="sc">+</span></span>
<span id="cb48-584"><a href="#cb48-584" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb48-585"><a href="#cb48-585" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.line.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb48-586"><a href="#cb48-586" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb48-587"><a href="#cb48-587" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x  =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb48-588"><a href="#cb48-588" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">clip =</span> <span class="st">"off"</span>) <span class="sc">+</span></span>
<span id="cb48-589"><a href="#cb48-589" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="fl">5.5</span>, <span class="at">r =</span> <span class="fl">5.5</span>, <span class="at">b =</span> <span class="dv">18</span>, <span class="at">l =</span> <span class="fl">5.5</span>))</span>
<span id="cb48-590"><a href="#cb48-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-591"><a href="#cb48-591" aria-hidden="true" tabindex="-1"></a>h_cut <span class="ot">&lt;-</span> hc<span class="sc">$</span>height[<span class="fu">length</span>(hc<span class="sc">$</span>height) <span class="sc">-</span> (k_clusters <span class="sc">-</span> <span class="dv">1</span>)]</span>
<span id="cb48-592"><a href="#cb48-592" aria-hidden="true" tabindex="-1"></a>p_dend <span class="ot">&lt;-</span> p_dend <span class="sc">+</span></span>
<span id="cb48-593"><a href="#cb48-593" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> h_cut, <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb48-594"><a href="#cb48-594" aria-hidden="true" tabindex="-1"></a>             <span class="at">linewidth =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"grey30"</span>)</span>
<span id="cb48-595"><a href="#cb48-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-596"><a href="#cb48-596" aria-hidden="true" tabindex="-1"></a>fig_final <span class="ot">&lt;-</span> (p_hibridos <span class="sc">|</span> p_dend) <span class="sc">+</span> <span class="fu">plot_annotation</span>(<span class="at">tag_levels =</span> <span class="st">"A"</span>)</span>
<span id="cb48-597"><a href="#cb48-597" aria-hidden="true" tabindex="-1"></a>fig_final</span>
<span id="cb48-598"><a href="#cb48-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-599"><a href="#cb48-599" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("Figure2_functional_phenotypes.png", fig_final, width = 12, height = 5.5, dpi = 300)</span></span>
<span id="cb48-600"><a href="#cb48-600" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-601"><a href="#cb48-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-602"><a href="#cb48-602" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb48-603"><a href="#cb48-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-604"><a href="#cb48-604" aria-hidden="true" tabindex="-1"></a><span class="fu">## Scalar-equivalent but trajectory-distinct curves</span></span>
<span id="cb48-605"><a href="#cb48-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-606"><a href="#cb48-606" aria-hidden="true" tabindex="-1"></a>We select two **individual curves** (by <span class="in">`curve_id`</span>) that are close in scalar space (AUDPC + final severity) but have large functional distance on a common grid.</span>
<span id="cb48-607"><a href="#cb48-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-608"><a href="#cb48-608" aria-hidden="true" tabindex="-1"></a><span class="fu">### Select candidate pairs (scalar-nearest) and maximize functional distance</span></span>
<span id="cb48-609"><a href="#cb48-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-612"><a href="#cb48-612" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-613"><a href="#cb48-613" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: killer-select-pair</span></span>
<span id="cb48-614"><a href="#cb48-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-615"><a href="#cb48-615" aria-hidden="true" tabindex="-1"></a>dfS <span class="ot">&lt;-</span> curve_stats <span class="sc">%&gt;%</span></span>
<span id="cb48-616"><a href="#cb48-616" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb48-617"><a href="#cb48-617" aria-hidden="true" tabindex="-1"></a>    <span class="at">curve_id  =</span> <span class="fu">as.character</span>(curve_id),</span>
<span id="cb48-618"><a href="#cb48-618" aria-hidden="true" tabindex="-1"></a>    <span class="at">AUDPC     =</span> <span class="fu">as.numeric</span>(AUDPC),</span>
<span id="cb48-619"><a href="#cb48-619" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_sev =</span> <span class="fu">as.numeric</span>(final_sev)</span>
<span id="cb48-620"><a href="#cb48-620" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb48-621"><a href="#cb48-621" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(AUDPC), <span class="fu">is.finite</span>(final_sev)) <span class="sc">%&gt;%</span></span>
<span id="cb48-622"><a href="#cb48-622" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(curve_id, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb48-623"><a href="#cb48-623" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-624"><a href="#cb48-624" aria-hidden="true" tabindex="-1"></a>    <span class="at">AUDPC_z =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(AUDPC)),</span>
<span id="cb48-625"><a href="#cb48-625" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_z =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(final_sev))</span>
<span id="cb48-626"><a href="#cb48-626" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-627"><a href="#cb48-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-628"><a href="#cb48-628" aria-hidden="true" tabindex="-1"></a>pairs_scalar <span class="ot">&lt;-</span> <span class="fu">crossing</span>(</span>
<span id="cb48-629"><a href="#cb48-629" aria-hidden="true" tabindex="-1"></a>  dfS <span class="sc">%&gt;%</span> <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">paste0</span>(.x, <span class="st">".x"</span>), <span class="sc">-</span>curve_id) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">curve_id.x =</span> curve_id),</span>
<span id="cb48-630"><a href="#cb48-630" aria-hidden="true" tabindex="-1"></a>  dfS <span class="sc">%&gt;%</span> <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">paste0</span>(.x, <span class="st">".y"</span>), <span class="sc">-</span>curve_id) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">curve_id.y =</span> curve_id)</span>
<span id="cb48-631"><a href="#cb48-631" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb48-632"><a href="#cb48-632" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(curve_id.x <span class="sc">&lt;</span> curve_id.y) <span class="sc">%&gt;%</span></span>
<span id="cb48-633"><a href="#cb48-633" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-634"><a href="#cb48-634" aria-hidden="true" tabindex="-1"></a>    <span class="at">scalar_dist =</span> <span class="fu">sqrt</span>((AUDPC_z.x <span class="sc">-</span> AUDPC_z.y)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb48-635"><a href="#cb48-635" aria-hidden="true" tabindex="-1"></a>                         (final_z.x <span class="sc">-</span> final_z.y)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb48-636"><a href="#cb48-636" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb48-637"><a href="#cb48-637" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(scalar_dist)</span>
<span id="cb48-638"><a href="#cb48-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-639"><a href="#cb48-639" aria-hidden="true" tabindex="-1"></a>thr  <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pairs_scalar<span class="sc">$</span>scalar_dist, <span class="fl">0.03</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-640"><a href="#cb48-640" aria-hidden="true" tabindex="-1"></a>cand <span class="ot">&lt;-</span> pairs_scalar <span class="sc">%&gt;%</span> <span class="fu">filter</span>(scalar_dist <span class="sc">&lt;=</span> thr)</span>
<span id="cb48-641"><a href="#cb48-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-642"><a href="#cb48-642" aria-hidden="true" tabindex="-1"></a>interp_curve <span class="ot">&lt;-</span> <span class="cf">function</span>(id){</span>
<span id="cb48-643"><a href="#cb48-643" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">as.character</span>(curve_id) <span class="sc">==</span> id) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(DAE)</span>
<span id="cb48-644"><a href="#cb48-644" aria-hidden="true" tabindex="-1"></a>  <span class="fu">approx</span>(df<span class="sc">$</span>DAE, df<span class="sc">$</span>y, <span class="at">xout =</span> t_grid, <span class="at">rule =</span> <span class="dv">2</span>)<span class="sc">$</span>y</span>
<span id="cb48-645"><a href="#cb48-645" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-646"><a href="#cb48-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-647"><a href="#cb48-647" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">diff</span>(t_grid))</span>
<span id="cb48-648"><a href="#cb48-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-649"><a href="#cb48-649" aria-hidden="true" tabindex="-1"></a>cand2 <span class="ot">&lt;-</span> cand <span class="sc">%&gt;%</span></span>
<span id="cb48-650"><a href="#cb48-650" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb48-651"><a href="#cb48-651" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-652"><a href="#cb48-652" aria-hidden="true" tabindex="-1"></a>    <span class="at">func_dist =</span> {</span>
<span id="cb48-653"><a href="#cb48-653" aria-hidden="true" tabindex="-1"></a>      y1 <span class="ot">&lt;-</span> <span class="fu">interp_curve</span>(curve_id.x)</span>
<span id="cb48-654"><a href="#cb48-654" aria-hidden="true" tabindex="-1"></a>      y2 <span class="ot">&lt;-</span> <span class="fu">interp_curve</span>(curve_id.y)</span>
<span id="cb48-655"><a href="#cb48-655" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sqrt</span>(<span class="fu">sum</span>((y1 <span class="sc">-</span> y2)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> dt)</span>
<span id="cb48-656"><a href="#cb48-656" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb48-657"><a href="#cb48-657" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb48-658"><a href="#cb48-658" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb48-659"><a href="#cb48-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-660"><a href="#cb48-660" aria-hidden="true" tabindex="-1"></a>best <span class="ot">&lt;-</span> cand2 <span class="sc">%&gt;%</span></span>
<span id="cb48-661"><a href="#cb48-661" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(func_dist), scalar_dist) <span class="sc">%&gt;%</span></span>
<span id="cb48-662"><a href="#cb48-662" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb48-663"><a href="#cb48-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-664"><a href="#cb48-664" aria-hidden="true" tabindex="-1"></a>id1 <span class="ot">&lt;-</span> best<span class="sc">$</span>curve_id.x</span>
<span id="cb48-665"><a href="#cb48-665" aria-hidden="true" tabindex="-1"></a>id2 <span class="ot">&lt;-</span> best<span class="sc">$</span>curve_id.y</span>
<span id="cb48-666"><a href="#cb48-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-667"><a href="#cb48-667" aria-hidden="true" tabindex="-1"></a>best</span>
<span id="cb48-668"><a href="#cb48-668" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-669"><a href="#cb48-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-670"><a href="#cb48-670" aria-hidden="true" tabindex="-1"></a><span class="fu">### Plot the two raw curves</span></span>
<span id="cb48-671"><a href="#cb48-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-674"><a href="#cb48-674" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-675"><a href="#cb48-675" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: killer-plot-raw</span></span>
<span id="cb48-676"><a href="#cb48-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-677"><a href="#cb48-677" aria-hidden="true" tabindex="-1"></a>plot_pair <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb48-678"><a href="#cb48-678" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">as.character</span>(curve_id) <span class="sc">%in%</span> <span class="fu">c</span>(id1, id2)) <span class="sc">%&gt;%</span></span>
<span id="cb48-679"><a href="#cb48-679" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">curve =</span> <span class="fu">if_else</span>(<span class="fu">as.character</span>(curve_id) <span class="sc">==</span> id1, <span class="st">"A"</span>, <span class="st">"B"</span>))</span>
<span id="cb48-680"><a href="#cb48-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-681"><a href="#cb48-681" aria-hidden="true" tabindex="-1"></a>s1 <span class="ot">&lt;-</span> dfS <span class="sc">%&gt;%</span> <span class="fu">filter</span>(curve_id <span class="sc">==</span> id1)</span>
<span id="cb48-682"><a href="#cb48-682" aria-hidden="true" tabindex="-1"></a>s2 <span class="ot">&lt;-</span> dfS <span class="sc">%&gt;%</span> <span class="fu">filter</span>(curve_id <span class="sc">==</span> id2)</span>
<span id="cb48-683"><a href="#cb48-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-684"><a href="#cb48-684" aria-hidden="true" tabindex="-1"></a>ann <span class="ot">&lt;-</span> <span class="fu">glue</span>(</span>
<span id="cb48-685"><a href="#cb48-685" aria-hidden="true" tabindex="-1"></a>  <span class="st">"AUDPC  A={round(s1$AUDPC,2)}  B={round(s2$AUDPC,2)}</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb48-686"><a href="#cb48-686" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Final   A={round(s1$final_sev,2)}  B={round(s2$final_sev,2)}</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb48-687"><a href="#cb48-687" aria-hidden="true" tabindex="-1"></a>  <span class="st">"d_S={signif(best$scalar_dist,3)}   d_F={signif(best$func_dist,3)}"</span></span>
<span id="cb48-688"><a href="#cb48-688" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-689"><a href="#cb48-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-690"><a href="#cb48-690" aria-hidden="true" tabindex="-1"></a>y_top <span class="ot">&lt;-</span> <span class="fu">max</span>(plot_pair<span class="sc">$</span>y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="fl">1.15</span></span>
<span id="cb48-691"><a href="#cb48-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-692"><a href="#cb48-692" aria-hidden="true" tabindex="-1"></a>p_main <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_pair, <span class="fu">aes</span>(DAE, y, <span class="at">color =</span> curve)) <span class="sc">+</span></span>
<span id="cb48-693"><a href="#cb48-693" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb48-694"><a href="#cb48-694" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb48-695"><a href="#cb48-695" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_grey</span>() <span class="sc">+</span></span>
<span id="cb48-696"><a href="#cb48-696" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"label"</span>,</span>
<span id="cb48-697"><a href="#cb48-697" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> <span class="fu">min</span>(plot_pair<span class="sc">$</span>DAE) <span class="sc">+</span> <span class="dv">2</span>,</span>
<span id="cb48-698"><a href="#cb48-698" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> y_top <span class="sc">-</span> <span class="fl">0.02</span>,</span>
<span id="cb48-699"><a href="#cb48-699" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> ann,</span>
<span id="cb48-700"><a href="#cb48-700" aria-hidden="true" tabindex="-1"></a>           <span class="at">hjust =</span> <span class="dv">0</span>,</span>
<span id="cb48-701"><a href="#cb48-701" aria-hidden="true" tabindex="-1"></a>           <span class="at">size =</span> <span class="dv">4</span>,</span>
<span id="cb48-702"><a href="#cb48-702" aria-hidden="true" tabindex="-1"></a>           <span class="at">fill =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb48-703"><a href="#cb48-703" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb48-704"><a href="#cb48-704" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Days after emergence (DAE)"</span>,</span>
<span id="cb48-705"><a href="#cb48-705" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Disease severity (proportion)"</span>,</span>
<span id="cb48-706"><a href="#cb48-706" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Curve"</span></span>
<span id="cb48-707"><a href="#cb48-707" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb48-708"><a href="#cb48-708" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, y_top))</span>
<span id="cb48-709"><a href="#cb48-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-710"><a href="#cb48-710" aria-hidden="true" tabindex="-1"></a>p_main</span>
<span id="cb48-711"><a href="#cb48-711" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-712"><a href="#cb48-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-713"><a href="#cb48-713" aria-hidden="true" tabindex="-1"></a><span class="fu">### Difference function $\Delta(t)$ and its integral contribution</span></span>
<span id="cb48-714"><a href="#cb48-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-717"><a href="#cb48-717" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-718"><a href="#cb48-718" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: killer-delta</span></span>
<span id="cb48-719"><a href="#cb48-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-720"><a href="#cb48-720" aria-hidden="true" tabindex="-1"></a>yA <span class="ot">&lt;-</span> <span class="fu">interp_curve</span>(id1)</span>
<span id="cb48-721"><a href="#cb48-721" aria-hidden="true" tabindex="-1"></a>yB <span class="ot">&lt;-</span> <span class="fu">interp_curve</span>(id2)</span>
<span id="cb48-722"><a href="#cb48-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-723"><a href="#cb48-723" aria-hidden="true" tabindex="-1"></a>df_diff <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb48-724"><a href="#cb48-724" aria-hidden="true" tabindex="-1"></a>  <span class="at">DAE  =</span> t_grid,</span>
<span id="cb48-725"><a href="#cb48-725" aria-hidden="true" tabindex="-1"></a>  <span class="at">diff =</span> yA <span class="sc">-</span> yB,</span>
<span id="cb48-726"><a href="#cb48-726" aria-hidden="true" tabindex="-1"></a>  <span class="at">sq   =</span> (yA <span class="sc">-</span> yB)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb48-727"><a href="#cb48-727" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-728"><a href="#cb48-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-729"><a href="#cb48-729" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">diff</span>(t_grid))</span>
<span id="cb48-730"><a href="#cb48-730" aria-hidden="true" tabindex="-1"></a>L2_sq <span class="ot">&lt;-</span> <span class="fu">sum</span>(df_diff<span class="sc">$</span>sq) <span class="sc">*</span> dt</span>
<span id="cb48-731"><a href="#cb48-731" aria-hidden="true" tabindex="-1"></a>L2    <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(L2_sq)</span>
<span id="cb48-732"><a href="#cb48-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-733"><a href="#cb48-733" aria-hidden="true" tabindex="-1"></a>p_diff <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_diff, <span class="fu">aes</span>(DAE, diff)) <span class="sc">+</span></span>
<span id="cb48-734"><a href="#cb48-734" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linewidth =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb48-735"><a href="#cb48-735" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb48-736"><a href="#cb48-736" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb48-737"><a href="#cb48-737" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Days after emergence (DAE)"</span>,</span>
<span id="cb48-738"><a href="#cb48-738" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">Delta</span>(t) <span class="sc">==</span> y[A](t) <span class="sc">-</span> y[B](t)),</span>
<span id="cb48-739"><a href="#cb48-739" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"L2 distance = "</span>, <span class="fu">signif</span>(L2, <span class="dv">3</span>),</span>
<span id="cb48-740"><a href="#cb48-740" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"  ( ∫Δ(t)^2 dt = "</span>, <span class="fu">signif</span>(L2_sq, <span class="dv">3</span>), <span class="st">" )"</span>)</span>
<span id="cb48-741"><a href="#cb48-741" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-742"><a href="#cb48-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-743"><a href="#cb48-743" aria-hidden="true" tabindex="-1"></a>p_sq <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_diff, <span class="fu">aes</span>(DAE, sq)) <span class="sc">+</span></span>
<span id="cb48-744"><a href="#cb48-744" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb48-745"><a href="#cb48-745" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb48-746"><a href="#cb48-746" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Days after emergence (DAE)"</span>,</span>
<span id="cb48-747"><a href="#cb48-747" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">Delta</span>(t)<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb48-748"><a href="#cb48-748" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Integral of Δ(t)^2 over time drives the L2 distance"</span></span>
<span id="cb48-749"><a href="#cb48-749" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-750"><a href="#cb48-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-751"><a href="#cb48-751" aria-hidden="true" tabindex="-1"></a>p_diff</span>
<span id="cb48-752"><a href="#cb48-752" aria-hidden="true" tabindex="-1"></a>p_sq</span>
<span id="cb48-753"><a href="#cb48-753" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-754"><a href="#cb48-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-755"><a href="#cb48-755" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb48-756"><a href="#cb48-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-757"><a href="#cb48-757" aria-hidden="true" tabindex="-1"></a><span class="fu">## Traditional AUDPC analysis (mixed model + Tukey)</span></span>
<span id="cb48-758"><a href="#cb48-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-759"><a href="#cb48-759" aria-hidden="true" tabindex="-1"></a>**Important design note.** Your script uses one AUDPC per <span class="in">`Hibrido × Ambiente`</span>:</span>
<span id="cb48-760"><a href="#cb48-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-761"><a href="#cb48-761" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb48-762"><a href="#cb48-762" aria-hidden="true" tabindex="-1"></a>audpc_df <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Ambiente, Hibrido) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">AUDPC =</span> ..., <span class="at">.groups=</span><span class="st">"drop"</span>)</span>
<span id="cb48-763"><a href="#cb48-763" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-764"><a href="#cb48-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-765"><a href="#cb48-765" aria-hidden="true" tabindex="-1"></a>This is appropriate if (a) <span class="in">`Parcela`</span> is not a true replication factor, or (b) you intentionally aggregate within environment. If you do have plot-level replication and want plot-level inference, compute AUDPC by <span class="in">`Ambiente × Hibrido × Parcela`</span> and fit a corresponding mixed model.</span>
<span id="cb48-766"><a href="#cb48-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-767"><a href="#cb48-767" aria-hidden="true" tabindex="-1"></a><span class="fu">### Compute AUDPC and fit model</span></span>
<span id="cb48-768"><a href="#cb48-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-771"><a href="#cb48-771" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-772"><a href="#cb48-772" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: audpc-model</span></span>
<span id="cb48-773"><a href="#cb48-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-774"><a href="#cb48-774" aria-hidden="true" tabindex="-1"></a>audpc_df <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb48-775"><a href="#cb48-775" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ambiente, Hibrido) <span class="sc">%&gt;%</span></span>
<span id="cb48-776"><a href="#cb48-776" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">AUDPC =</span> pracma<span class="sc">::</span><span class="fu">trapz</span>(DAE, y), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb48-777"><a href="#cb48-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-778"><a href="#cb48-778" aria-hidden="true" tabindex="-1"></a>audpc_df2 <span class="ot">&lt;-</span> audpc_df <span class="sc">%&gt;%</span></span>
<span id="cb48-779"><a href="#cb48-779" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-780"><a href="#cb48-780" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ambiente =</span> <span class="fu">factor</span>(Ambiente),</span>
<span id="cb48-781"><a href="#cb48-781" aria-hidden="true" tabindex="-1"></a>    <span class="at">Hibrido  =</span> <span class="fu">factor</span>(Hibrido),</span>
<span id="cb48-782"><a href="#cb48-782" aria-hidden="true" tabindex="-1"></a>    <span class="at">AUDPC    =</span> <span class="fu">as.numeric</span>(AUDPC)</span>
<span id="cb48-783"><a href="#cb48-783" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb48-784"><a href="#cb48-784" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(AUDPC))</span>
<span id="cb48-785"><a href="#cb48-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-786"><a href="#cb48-786" aria-hidden="true" tabindex="-1"></a><span class="co"># Mixed model: random intercept for Ambiente (as in your earlier block)</span></span>
<span id="cb48-787"><a href="#cb48-787" aria-hidden="true" tabindex="-1"></a>m_audpc <span class="ot">&lt;-</span> <span class="fu">lmer</span>(AUDPC <span class="sc">~</span> Hibrido <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> Ambiente), <span class="at">data =</span> audpc_df2)</span>
<span id="cb48-788"><a href="#cb48-788" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(m_audpc)</span>
<span id="cb48-789"><a href="#cb48-789" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-790"><a href="#cb48-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-791"><a href="#cb48-791" aria-hidden="true" tabindex="-1"></a><span class="fu">### Model checks (DHARMa)</span></span>
<span id="cb48-792"><a href="#cb48-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-795"><a href="#cb48-795" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-796"><a href="#cb48-796" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: audpc-diagnostics</span></span>
<span id="cb48-797"><a href="#cb48-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-798"><a href="#cb48-798" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb48-799"><a href="#cb48-799" aria-hidden="true" tabindex="-1"></a>res_a <span class="ot">&lt;-</span> <span class="fu">simulateResiduals</span>(m_audpc, <span class="at">n =</span> <span class="dv">2000</span>)</span>
<span id="cb48-800"><a href="#cb48-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-801"><a href="#cb48-801" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(res_a)</span>
<span id="cb48-802"><a href="#cb48-802" aria-hidden="true" tabindex="-1"></a><span class="fu">testUniformity</span>(res_a)</span>
<span id="cb48-803"><a href="#cb48-803" aria-hidden="true" tabindex="-1"></a><span class="fu">testDispersion</span>(res_a)</span>
<span id="cb48-804"><a href="#cb48-804" aria-hidden="true" tabindex="-1"></a><span class="fu">testOutliers</span>(res_a)</span>
<span id="cb48-805"><a href="#cb48-805" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-806"><a href="#cb48-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-807"><a href="#cb48-807" aria-hidden="true" tabindex="-1"></a><span class="fu">### Hybrid means + Tukey letters</span></span>
<span id="cb48-808"><a href="#cb48-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-811"><a href="#cb48-811" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-812"><a href="#cb48-812" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: audpc-tukey</span></span>
<span id="cb48-813"><a href="#cb48-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-814"><a href="#cb48-814" aria-hidden="true" tabindex="-1"></a>emm_h <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(m_audpc, <span class="sc">~</span> Hibrido)</span>
<span id="cb48-815"><a href="#cb48-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-816"><a href="#cb48-816" aria-hidden="true" tabindex="-1"></a>cld_res <span class="ot">&lt;-</span> multcomp<span class="sc">::</span><span class="fu">cld</span>(</span>
<span id="cb48-817"><a href="#cb48-817" aria-hidden="true" tabindex="-1"></a>  emm_h,</span>
<span id="cb48-818"><a href="#cb48-818" aria-hidden="true" tabindex="-1"></a>  <span class="at">Letters =</span> letters,</span>
<span id="cb48-819"><a href="#cb48-819" aria-hidden="true" tabindex="-1"></a>  <span class="at">adjust  =</span> <span class="st">"tukey"</span></span>
<span id="cb48-820"><a href="#cb48-820" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-821"><a href="#cb48-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-822"><a href="#cb48-822" aria-hidden="true" tabindex="-1"></a>audpc_groups <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(cld_res) <span class="sc">%&gt;%</span></span>
<span id="cb48-823"><a href="#cb48-823" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb48-824"><a href="#cb48-824" aria-hidden="true" tabindex="-1"></a>    Hibrido,</span>
<span id="cb48-825"><a href="#cb48-825" aria-hidden="true" tabindex="-1"></a>    emmean,</span>
<span id="cb48-826"><a href="#cb48-826" aria-hidden="true" tabindex="-1"></a>    SE,</span>
<span id="cb48-827"><a href="#cb48-827" aria-hidden="true" tabindex="-1"></a>    df,</span>
<span id="cb48-828"><a href="#cb48-828" aria-hidden="true" tabindex="-1"></a>    lower.CL,</span>
<span id="cb48-829"><a href="#cb48-829" aria-hidden="true" tabindex="-1"></a>    upper.CL,</span>
<span id="cb48-830"><a href="#cb48-830" aria-hidden="true" tabindex="-1"></a>    <span class="at">.group =</span> stringr<span class="sc">::</span><span class="fu">str_squish</span>(.group)</span>
<span id="cb48-831"><a href="#cb48-831" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb48-832"><a href="#cb48-832" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(emmean)</span>
<span id="cb48-833"><a href="#cb48-833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-834"><a href="#cb48-834" aria-hidden="true" tabindex="-1"></a>audpc_groups</span>
<span id="cb48-835"><a href="#cb48-835" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-836"><a href="#cb48-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-837"><a href="#cb48-837" aria-hidden="true" tabindex="-1"></a><span class="fu">### Merge Tukey groups with functional clusters</span></span>
<span id="cb48-838"><a href="#cb48-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-841"><a href="#cb48-841" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-842"><a href="#cb48-842" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: audpc-merge-functional</span></span>
<span id="cb48-843"><a href="#cb48-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-844"><a href="#cb48-844" aria-hidden="true" tabindex="-1"></a>final_compare <span class="ot">&lt;-</span> audpc_groups <span class="sc">%&gt;%</span></span>
<span id="cb48-845"><a href="#cb48-845" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb48-846"><a href="#cb48-846" aria-hidden="true" tabindex="-1"></a>    cluster_table2 <span class="sc">%&gt;%</span> <span class="fu">select</span>(Hibrido, cluster, phenotype),</span>
<span id="cb48-847"><a href="#cb48-847" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"Hibrido"</span></span>
<span id="cb48-848"><a href="#cb48-848" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb48-849"><a href="#cb48-849" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(emmean)</span>
<span id="cb48-850"><a href="#cb48-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-851"><a href="#cb48-851" aria-hidden="true" tabindex="-1"></a>final_compare</span>
<span id="cb48-852"><a href="#cb48-852" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-853"><a href="#cb48-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-854"><a href="#cb48-854" aria-hidden="true" tabindex="-1"></a><span class="fu">### Plot: AUDPC means, CI, Tukey letters (colored by functional phenotype)</span></span>
<span id="cb48-855"><a href="#cb48-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-858"><a href="#cb48-858" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-859"><a href="#cb48-859" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: audpc-plot</span></span>
<span id="cb48-860"><a href="#cb48-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-861"><a href="#cb48-861" aria-hidden="true" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> final_compare <span class="sc">%&gt;%</span></span>
<span id="cb48-862"><a href="#cb48-862" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-863"><a href="#cb48-863" aria-hidden="true" tabindex="-1"></a>    <span class="at">hybrid_short =</span> <span class="fu">shorten_hybrid</span>(Hibrido),</span>
<span id="cb48-864"><a href="#cb48-864" aria-hidden="true" tabindex="-1"></a>    <span class="at">cluster =</span> <span class="fu">factor</span>(cluster)</span>
<span id="cb48-865"><a href="#cb48-865" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-866"><a href="#cb48-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-867"><a href="#cb48-867" aria-hidden="true" tabindex="-1"></a>cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#D55E00"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#009E73"</span>, <span class="st">"#CC79A7"</span>)[<span class="dv">1</span><span class="sc">:</span>k_clusters]</span>
<span id="cb48-868"><a href="#cb48-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-869"><a href="#cb48-869" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_df,</span>
<span id="cb48-870"><a href="#cb48-870" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">reorder</span>(hybrid_short, emmean),</span>
<span id="cb48-871"><a href="#cb48-871" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> emmean,</span>
<span id="cb48-872"><a href="#cb48-872" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> cluster)) <span class="sc">+</span></span>
<span id="cb48-873"><a href="#cb48-873" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb48-874"><a href="#cb48-874" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> cols) <span class="sc">+</span></span>
<span id="cb48-875"><a href="#cb48-875" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> lower.CL, <span class="at">xmax =</span> upper.CL), <span class="at">height =</span> <span class="fl">0.12</span>) <span class="sc">+</span></span>
<span id="cb48-876"><a href="#cb48-876" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> .group), <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb48-877"><a href="#cb48-877" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb48-878"><a href="#cb48-878" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"AUDPC"</span>,</span>
<span id="cb48-879"><a href="#cb48-879" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Hybrid"</span>,</span>
<span id="cb48-880"><a href="#cb48-880" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Functional phenotype"</span>,</span>
<span id="cb48-881"><a href="#cb48-881" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="cn">NULL</span></span>
<span id="cb48-882"><a href="#cb48-882" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb48-883"><a href="#cb48-883" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb48-884"><a href="#cb48-884" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="fu">min</span>(plot_df<span class="sc">$</span>lower.CL), <span class="fu">max</span>(plot_df<span class="sc">$</span>upper.CL) <span class="sc">*</span> <span class="fl">1.10</span>))</span>
<span id="cb48-885"><a href="#cb48-885" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-886"><a href="#cb48-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-887"><a href="#cb48-887" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb48-888"><a href="#cb48-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-889"><a href="#cb48-889" aria-hidden="true" tabindex="-1"></a><span class="fu">## Optional: run `compare_curves()` from `{r4pde}`</span></span>
<span id="cb48-890"><a href="#cb48-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-891"><a href="#cb48-891" aria-hidden="true" tabindex="-1"></a>This section reproduces your final call, assuming <span class="in">`{r4pde}`</span> is installed and your <span class="in">`dat`</span> object matches the required schema.</span>
<span id="cb48-892"><a href="#cb48-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-895"><a href="#cb48-895" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-896"><a href="#cb48-896" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: r4pde-compare-curves</span></span>
<span id="cb48-897"><a href="#cb48-897" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb48-898"><a href="#cb48-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-899"><a href="#cb48-899" aria-hidden="true" tabindex="-1"></a><span class="co">#pak::pkg_install("emdelponte/r4pde")</span></span>
<span id="cb48-900"><a href="#cb48-900" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(r4pde)</span>
<span id="cb48-901"><a href="#cb48-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-902"><a href="#cb48-902" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">compare_curves</span>(</span>
<span id="cb48-903"><a href="#cb48-903" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat,</span>
<span id="cb48-904"><a href="#cb48-904" aria-hidden="true" tabindex="-1"></a>  <span class="at">time =</span> <span class="st">"DAE"</span>,</span>
<span id="cb48-905"><a href="#cb48-905" aria-hidden="true" tabindex="-1"></a>  <span class="at">response =</span> <span class="st">"y"</span>,</span>
<span id="cb48-906"><a href="#cb48-906" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment =</span> <span class="st">"Hibrido"</span>,</span>
<span id="cb48-907"><a href="#cb48-907" aria-hidden="true" tabindex="-1"></a>  <span class="at">environment =</span> <span class="st">"Ambiente"</span>,</span>
<span id="cb48-908"><a href="#cb48-908" aria-hidden="true" tabindex="-1"></a>  <span class="at">test_factor =</span> <span class="st">"resistance"</span>,</span>
<span id="cb48-909"><a href="#cb48-909" aria-hidden="true" tabindex="-1"></a>  <span class="at">perm_unit =</span> <span class="st">"Hibrido"</span>,</span>
<span id="cb48-910"><a href="#cb48-910" aria-hidden="true" tabindex="-1"></a>  <span class="at">perm_strata =</span> <span class="st">"Ambiente"</span>,</span>
<span id="cb48-911"><a href="#cb48-911" aria-hidden="true" tabindex="-1"></a>  <span class="at">test_mode =</span> <span class="st">"global"</span>,</span>
<span id="cb48-912"><a href="#cb48-912" aria-hidden="true" tabindex="-1"></a>  <span class="at">bootstrap =</span> <span class="cn">TRUE</span>,</span>
<span id="cb48-913"><a href="#cb48-913" aria-hidden="true" tabindex="-1"></a>  <span class="at">boot_B =</span> <span class="dv">399</span></span>
<span id="cb48-914"><a href="#cb48-914" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-915"><a href="#cb48-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-916"><a href="#cb48-916" aria-hidden="true" tabindex="-1"></a>m1</span>
<span id="cb48-917"><a href="#cb48-917" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m1)</span>
<span id="cb48-918"><a href="#cb48-918" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_curves</span>(m1)</span>
<span id="cb48-919"><a href="#cb48-919" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_dendrogram</span>(m1)</span>
<span id="cb48-920"><a href="#cb48-920" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-921"><a href="#cb48-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-922"><a href="#cb48-922" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb48-923"><a href="#cb48-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-924"><a href="#cb48-924" aria-hidden="true" tabindex="-1"></a><span class="fu">## Session info</span></span>
<span id="cb48-925"><a href="#cb48-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-928"><a href="#cb48-928" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-929"><a href="#cb48-929" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: session-info</span></span>
<span id="cb48-930"><a href="#cb48-930" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb48-931"><a href="#cb48-931" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>