<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Emerson M. Del Ponte">

<title>Curve-based + traditional analysis of Bipolaris epidemics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="index_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap-6e5ff12f349f7d7ee99023e5a7f49be9.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="header-section-number">1</span> Overview</a></li>
  <li><a href="#data-and-design" id="toc-data-and-design" class="nav-link" data-scroll-target="#data-and-design"><span class="header-section-number">2</span> Data and design</a></li>
  <li><a href="#methods-equations" id="toc-methods-equations" class="nav-link" data-scroll-target="#methods-equations"><span class="header-section-number">3</span> Methods (equations)</a>
  <ul class="collapse">
  <li><a href="#response-scale-and-beta-regression-constraints" id="toc-response-scale-and-beta-regression-constraints" class="nav-link" data-scroll-target="#response-scale-and-beta-regression-constraints"><span class="header-section-number">3.1</span> Response scale and beta regression constraints</a></li>
  <li><a href="#audpc" id="toc-audpc" class="nav-link" data-scroll-target="#audpc"><span class="header-section-number">3.2</span> AUDPC</a></li>
  <li><a href="#t_50" id="toc-t_50" class="nav-link" data-scroll-target="#t_50"><span class="header-section-number">3.3</span> <span class="math inline">\(T_{50}\)</span></a></li>
  <li><a href="#logistic-rate-optional-scalar" id="toc-logistic-rate-optional-scalar" class="nav-link" data-scroll-target="#logistic-rate-optional-scalar"><span class="header-section-number">3.4</span> Logistic rate (optional scalar)</a></li>
  <li><a href="#functional-distance-between-curves" id="toc-functional-distance-between-curves" class="nav-link" data-scroll-target="#functional-distance-between-curves"><span class="header-section-number">3.5</span> Functional distance between curves</a></li>
  </ul></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup"><span class="header-section-number">4</span> Setup</a>
  <ul class="collapse">
  <li><a href="#packages" id="toc-packages" class="nav-link" data-scroll-target="#packages"><span class="header-section-number">4.1</span> Packages</a></li>
  <li><a href="#user-settings" id="toc-user-settings" class="nav-link" data-scroll-target="#user-settings"><span class="header-section-number">4.2</span> User settings</a></li>
  </ul></li>
  <li><a href="#read-and-prepare-data" id="toc-read-and-prepare-data" class="nav-link" data-scroll-target="#read-and-prepare-data"><span class="header-section-number">5</span> Read and prepare data</a>
  <ul class="collapse">
  <li><a href="#optional-join-hybrid-resistance-class" id="toc-optional-join-hybrid-resistance-class" class="nav-link" data-scroll-target="#optional-join-hybrid-resistance-class"><span class="header-section-number">5.1</span> Optional: join hybrid resistance class</a></li>
  </ul></li>
  <li><a href="#helper-functions-scalars" id="toc-helper-functions-scalars" class="nav-link" data-scroll-target="#helper-functions-scalars"><span class="header-section-number">6</span> Helper functions (scalars)</a></li>
  <li><a href="#per-curve-scalar-metrics-audpc-final-t50-r_norm" id="toc-per-curve-scalar-metrics-audpc-final-t50-r_norm" class="nav-link" data-scroll-target="#per-curve-scalar-metrics-audpc-final-t50-r_norm"><span class="header-section-number">7</span> Per-curve scalar metrics (AUDPC, final, T50, r_norm)</a></li>
  <li><a href="#hierarchical-beta-gam-hgam-for-smoothing-and-adjustment" id="toc-hierarchical-beta-gam-hgam-for-smoothing-and-adjustment" class="nav-link" data-scroll-target="#hierarchical-beta-gam-hgam-for-smoothing-and-adjustment"><span class="header-section-number">8</span> Hierarchical beta-GAM (HGAM) for smoothing and adjustment</a>
  <ul class="collapse">
  <li><a href="#diagnostics-observed-vs-fitted-and-residuals" id="toc-diagnostics-observed-vs-fitted-and-residuals" class="nav-link" data-scroll-target="#diagnostics-observed-vs-fitted-and-residuals"><span class="header-section-number">8.1</span> Diagnostics (observed vs fitted and residuals)</a></li>
  </ul></li>
  <li><a href="#environment-adjusted-hybrid-mean-curves" id="toc-environment-adjusted-hybrid-mean-curves" class="nav-link" data-scroll-target="#environment-adjusted-hybrid-mean-curves"><span class="header-section-number">9</span> Environment-adjusted hybrid mean curves</a></li>
  <li><a href="#functional-distance-among-hybrids-clustering" id="toc-functional-distance-among-hybrids-clustering" class="nav-link" data-scroll-target="#functional-distance-among-hybrids-clustering"><span class="header-section-number">10</span> Functional distance among hybrids + clustering</a>
  <ul class="collapse">
  <li><a href="#utility-shorten-hybrid-labels" id="toc-utility-shorten-hybrid-labels" class="nav-link" data-scroll-target="#utility-shorten-hybrid-labels"><span class="header-section-number">10.1</span> Utility: shorten hybrid labels</a></li>
  <li><a href="#build-distance-matrix-and-cluster" id="toc-build-distance-matrix-and-cluster" class="nav-link" data-scroll-target="#build-distance-matrix-and-cluster"><span class="header-section-number">10.2</span> Build distance matrix and cluster</a></li>
  <li><a href="#figure-mean-curves-by-phenotype-dendrogram" id="toc-figure-mean-curves-by-phenotype-dendrogram" class="nav-link" data-scroll-target="#figure-mean-curves-by-phenotype-dendrogram"><span class="header-section-number">10.3</span> Figure: mean curves by phenotype + dendrogram</a></li>
  </ul></li>
  <li><a href="#scalar-equivalent-but-trajectory-distinct-curves" id="toc-scalar-equivalent-but-trajectory-distinct-curves" class="nav-link" data-scroll-target="#scalar-equivalent-but-trajectory-distinct-curves"><span class="header-section-number">11</span> Scalar-equivalent but trajectory-distinct curves</a>
  <ul class="collapse">
  <li><a href="#select-candidate-pairs-scalar-nearest-and-maximize-functional-distance" id="toc-select-candidate-pairs-scalar-nearest-and-maximize-functional-distance" class="nav-link" data-scroll-target="#select-candidate-pairs-scalar-nearest-and-maximize-functional-distance"><span class="header-section-number">11.1</span> Select candidate pairs (scalar-nearest) and maximize functional distance</a></li>
  <li><a href="#plot-the-two-raw-curves" id="toc-plot-the-two-raw-curves" class="nav-link" data-scroll-target="#plot-the-two-raw-curves"><span class="header-section-number">11.2</span> Plot the two raw curves</a></li>
  </ul></li>
  <li><a href="#traditional-audpc-analysis-mixed-model-tukey" id="toc-traditional-audpc-analysis-mixed-model-tukey" class="nav-link" data-scroll-target="#traditional-audpc-analysis-mixed-model-tukey"><span class="header-section-number">12</span> Traditional AUDPC analysis (mixed model + Tukey)</a>
  <ul class="collapse">
  <li><a href="#compute-audpc-and-fit-model" id="toc-compute-audpc-and-fit-model" class="nav-link" data-scroll-target="#compute-audpc-and-fit-model"><span class="header-section-number">12.1</span> Compute AUDPC and fit model</a></li>
  <li><a href="#model-checks-dharma" id="toc-model-checks-dharma" class="nav-link" data-scroll-target="#model-checks-dharma"><span class="header-section-number">12.2</span> Model checks (DHARMa)</a></li>
  <li><a href="#hybrid-means-tukey-letters" id="toc-hybrid-means-tukey-letters" class="nav-link" data-scroll-target="#hybrid-means-tukey-letters"><span class="header-section-number">12.3</span> Hybrid means + Tukey letters</a></li>
  <li><a href="#merge-tukey-groups-with-functional-clusters" id="toc-merge-tukey-groups-with-functional-clusters" class="nav-link" data-scroll-target="#merge-tukey-groups-with-functional-clusters"><span class="header-section-number">12.4</span> Merge Tukey groups with functional clusters</a></li>
  <li><a href="#plot-audpc-means-ci-tukey-letters-colored-by-functional-phenotype" id="toc-plot-audpc-means-ci-tukey-letters-colored-by-functional-phenotype" class="nav-link" data-scroll-target="#plot-audpc-means-ci-tukey-letters-colored-by-functional-phenotype"><span class="header-section-number">12.5</span> Plot: AUDPC means, CI, Tukey letters (colored by functional phenotype)</a></li>
  </ul></li>
  <li><a href="#optional-run-compare_curves-from-r4pde" id="toc-optional-run-compare_curves-from-r4pde" class="nav-link" data-scroll-target="#optional-run-compare_curves-from-r4pde"><span class="header-section-number">13</span> Optional: run <code>compare_curves()</code> from <code>{r4pde}</code></a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info"><span class="header-section-number">14</span> Session info</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Curve-based + traditional analysis of Bipolaris epidemics</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
<p class="subtitle lead">Functional (beta-GAM/HGAM) smoothing, functional distances, and AUDPC mixed-model comparison</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Emerson M. Del Ponte </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="overview" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="overview"><span class="header-section-number">1</span> Overview</h2>
<p>This document implements two complementary analyses for Bipolaris leaf spot epidemics assessed in maize hybrids:</p>
<p><strong>A. Functional (curve-based) analysis</strong></p>
<ol type="1">
<li><strong>Beta-GAM (HGAM)</strong> to smooth severity trajectories and adjust for environment.</li>
<li><strong>Environment-adjusted hybrid mean curves</strong>.</li>
<li><strong>Functional distance</strong> among hybrids and <strong>hierarchical clustering</strong> (dendrogram + curve panel).</li>
<li><em>“Killer pair” figure:</em> two curves that are <strong>scalar-equivalent</strong> (AUDPC + final severity) but <strong>trajectory-distinct</strong>, with the difference function <span class="math inline">\(\Delta(t)\)</span> and its contribution to the <span class="math inline">\(L^2\)</span> distance.</li>
</ol>
<p><strong>B. Traditional (scalar) analysis</strong></p>
<ol type="1">
<li><strong>AUDPC</strong> per hybrid within environment (as available in the dataset design).</li>
<li>Mixed-model ANOVA and <strong>Tukey</strong> letter groups (via <code>emmeans::cld()</code>).</li>
<li>Merge <strong>Tukey groups</strong> with <strong>functional clusters</strong> for side-by-side comparison.</li>
</ol>
<hr>
</section>
<section id="data-and-design" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="data-and-design"><span class="header-section-number">2</span> Data and design</h2>
<ul>
<li><strong>Input file:</strong> <code>maize_bipolaris.csv</code></li>
<li><strong>Response:</strong> Bipolaris severity (%) converted to proportion</li>
<li><strong>Time scale:</strong> DAE (days after emergence)</li>
<li><strong>Design columns:</strong> <code>Ambiente</code> (environment), <code>Hibrido</code> (hybrid), <code>Parcela</code> (plot/block)</li>
</ul>
<hr>
</section>
<section id="methods-equations" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="methods-equations"><span class="header-section-number">3</span> Methods (equations)</h2>
<section id="response-scale-and-beta-regression-constraints" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="response-scale-and-beta-regression-constraints"><span class="header-section-number">3.1</span> Response scale and beta regression constraints</h3>
<p>The raw severity in percent is converted to a proportion:</p>
<p><span class="math display">\[
y = \frac{\text{severity (\%)}}{100}.
\]</span></p>
<p>Beta regression requires <span class="math inline">\(0 &lt; y &lt; 1\)</span>, so we apply a small boundary adjustment:</p>
<p><span class="math display">\[
y^* = \min\left(\max(y, \varepsilon), 1-\varepsilon\right).
\]</span></p>
</section>
<section id="audpc" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="audpc"><span class="header-section-number">3.2</span> AUDPC</h3>
<p>AUDPC is approximated using the trapezoidal rule for a curve <span class="math inline">\(y(t)\)</span> observed at times <span class="math inline">\(t_1 &lt; \dots &lt; t_m\)</span>:</p>
<p><span class="math display">\[
\mathrm{AUDPC} \approx \sum_{i=1}^{m-1} \frac{(y_i + y_{i+1})}{2}\,(t_{i+1}-t_i).
\]</span></p>
</section>
<section id="t_50" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="t_50"><span class="header-section-number">3.3</span> <span class="math inline">\(T_{50}\)</span></h3>
<p><span class="math inline">\(T_{50}\)</span> is computed as the time when the curve reaches half its observed maximum:</p>
<p><span class="math display">\[
T_{50}=\min\{t:\; y(t)\ge 0.5\,y_{\max}\},
\]</span></p>
<p>estimated by linear interpolation between adjacent observation times.</p>
</section>
<section id="logistic-rate-optional-scalar" class="level3" data-number="3.4">
<h3 data-number="3.4" class="anchored" data-anchor-id="logistic-rate-optional-scalar"><span class="header-section-number">3.4</span> Logistic rate (optional scalar)</h3>
<p>We fit a logistic curve to each epidemic trajectory:</p>
<p><span class="math display">\[
y(t)=\frac{K}{1 + \exp\{-r(t-t_0)\}},
\]</span></p>
<p>and report a duration-normalized rate:</p>
<p><span class="math display">\[
r_{\mathrm{norm}} = r\,(t_{\max}-t_{\min}).
\]</span></p>
</section>
<section id="functional-distance-between-curves" class="level3" data-number="3.5">
<h3 data-number="3.5" class="anchored" data-anchor-id="functional-distance-between-curves"><span class="header-section-number">3.5</span> Functional distance between curves</h3>
<p>For two smooth mean curves <span class="math inline">\(\mu_a(t)\)</span> and <span class="math inline">\(\mu_b(t)\)</span>, the <span class="math inline">\(L^2\)</span> distance is:</p>
<p><span class="math display">\[
d_F(a,b) = \left(\int \big[\mu_a(t)-\mu_b(t)\big]^2\,dt\right)^{1/2}.
\]</span></p>
<p>On an evenly spaced grid with step <span class="math inline">\(\Delta t\)</span>, we approximate:</p>
<p><span class="math display">\[
d_F(a,b)\approx \left(\sum_{j} [\mu_a(t_j)-\mu_b(t_j)]^2\,\Delta t\right)^{1/2}.
\]</span></p>
<hr>
</section>
</section>
<section id="setup" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="setup"><span class="header-section-number">4</span> Setup</h2>
<section id="packages" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="packages"><span class="header-section-number">4.1</span> Packages</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"readr"</span>,<span class="st">"dplyr"</span>,<span class="st">"tidyr"</span>,<span class="st">"tibble"</span>,<span class="st">"purrr"</span>,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ggplot2"</span>,<span class="st">"mgcv"</span>,<span class="st">"pracma"</span>,<span class="st">"pheatmap"</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"lme4"</span>,<span class="st">"lmerTest"</span>,<span class="st">"emmeans"</span>,<span class="st">"multcompView"</span>,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"cowplot"</span>,<span class="st">"ggrepel"</span>,<span class="st">"ggdendro"</span>,<span class="st">"patchwork"</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"DHARMa"</span>,<span class="st">"stringr"</span>,<span class="st">"glue"</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>to_install <span class="ot">&lt;-</span> pkgs[<span class="sc">!</span>pkgs <span class="sc">%in%</span> <span class="fu">rownames</span>(<span class="fu">installed.packages</span>())]</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(to_install) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">install.packages</span>(to_install, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pracma)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pheatmap)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmerTest)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emmeans)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(multcompView)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggrepel)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggdendro)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DHARMa)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_classic</span>(<span class="at">base_size =</span> <span class="dv">14</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="user-settings" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="user-settings"><span class="header-section-number">4.2</span> User settings</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>file_path  <span class="ot">&lt;-</span> <span class="st">"maize_bipolaris.csv"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Data window (as in your script)</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>dae_min <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>dae_max <span class="ot">&lt;-</span> <span class="dv">116</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Minimum number of assessments per curve_id to retain</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>min_assess <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Beta boundary adjustment</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>eps <span class="ot">&lt;-</span> <span class="fl">1e-4</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Functional clustering</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>k_clusters <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Time grid for functional distances / plots</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>grid_n <span class="ot">&lt;-</span> <span class="dv">140</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Reference environment used for "environment-adjusted" mean curves</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
</section>
<section id="read-and-prepare-data" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="read-and-prepare-data"><span class="header-section-number">5</span> Read and prepare data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>dat0 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>dat0 <span class="ot">&lt;-</span> dat0 <span class="sc">|&gt;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(DAE <span class="sc">&lt;</span> dae_max, DAE <span class="sc">&gt;</span> dae_min)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Expected columns: Ambiente, Hibrido, Parcela, DAE, Bipolaris</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat0 <span class="sc">%&gt;%</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ambiente  =</span> <span class="fu">factor</span>(Ambiente),</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">Hibrido   =</span> <span class="fu">factor</span>(Hibrido),</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">DAE       =</span> <span class="fu">as.numeric</span>(DAE),</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">bipolaris =</span> <span class="fu">as.numeric</span>(Bipolaris) <span class="sc">/</span> <span class="dv">100</span>  <span class="co"># % -&gt; proportion</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Ambiente), <span class="sc">!</span><span class="fu">is.na</span>(Hibrido), </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span><span class="fu">is.na</span>(DAE), <span class="sc">!</span><span class="fu">is.na</span>(bipolaris)) <span class="sc">%&gt;%</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">curve_id =</span> <span class="fu">interaction</span>(Ambiente, Hibrido), <span class="at">drop =</span> <span class="cn">TRUE</span>, <span class="at">sep =</span> <span class="st">"|"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(curve_id, DAE)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Retain curves with at least min_assess time points</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>curve_n <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">count</span>(curve_id, <span class="at">name =</span> <span class="st">"n_assess"</span>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(curve_n, <span class="at">by =</span> <span class="st">"curve_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_assess <span class="sc">&gt;=</span> min_assess) <span class="sc">%&gt;%</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>n_assess)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Beta regression requires 0 &lt; y &lt; 1</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(bipolaris, eps), <span class="dv">1</span> <span class="sc">-</span> eps))</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Rows: "</span>, <span class="fu">nrow</span>(dat),</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">" | curves: "</span>, <span class="fu">n_distinct</span>(dat<span class="sc">$</span>curve_id),</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">" | hybrids: "</span>, <span class="fu">n_distinct</span>(dat<span class="sc">$</span>Hibrido),</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">" | envs: "</span>, <span class="fu">n_distinct</span>(dat<span class="sc">$</span>Ambiente))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="optional-join-hybrid-resistance-class" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="optional-join-hybrid-resistance-class"><span class="header-section-number">5.1</span> Optional: join hybrid resistance class</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>bipolaris_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Hibrido =</span> <span class="fu">c</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AG 8701 PRO4"</span>,<span class="st">"AG 8707 PRO4"</span>,<span class="st">"AG 9021 PRO3"</span>,<span class="st">"AS 1757 PRO4"</span>,<span class="st">"AS 1868 PRO4"</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AS 1955 PRO4"</span>,<span class="st">"B 2801 PWU"</span>,<span class="st">"CRWX03"</span>,<span class="st">"DKB 230 PRO3"</span>,<span class="st">"DKB 242 PRO4"</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MG 616 PWU"</span>,<span class="st">"P 3016 VYHR"</span>,<span class="st">"T 1503 PWU"</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">resistance =</span> <span class="fu">c</span>(<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"R"</span>,<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"R"</span>,<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"R"</span>,<span class="st">"MR"</span>),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(bipolaris_df, <span class="at">by =</span> <span class="st">"Hibrido"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y          =</span> <span class="fu">as.numeric</span>(y),</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">DAE        =</span> <span class="fu">as.numeric</span>(DAE),</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ambiente   =</span> <span class="fu">factor</span>(Ambiente),</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">Hibrido    =</span> <span class="fu">factor</span>(Hibrido),</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">curve_id   =</span> <span class="fu">factor</span>(curve_id),</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">resistance =</span> <span class="fu">factor</span>(resistance)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   885 obs. of  6 variables:
 $ y         : num  0.0001 0.03 0.035 0.035 0.065 0.15 0.2 0.25 0.25 0.25 ...
 $ DAE       : num  49 54 62 68 78 84 90 97 103 109 ...
 $ Ambiente  : Factor w/ 6 levels "2024_Arapoti_Cedo",..: 1 1 1 1 1 1 1 1 1 1 ...
 $ Hibrido   : Factor w/ 13 levels "AG 8701 PRO4",..: 1 1 1 1 1 1 1 1 1 1 ...
 $ curve_id  : Factor w/ 74 levels "2024_Arapoti_Cedo.AG 8701 PRO4",..: 1 1 1 1 1 1 1 1 1 1 ...
 $ resistance: Factor w/ 2 levels "MR","R": 1 1 1 1 1 1 1 1 1 1 ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ambiente) <span class="sc">|&gt;</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(DAE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 71 × 3
# Groups:   Ambiente [6]
   Ambiente            DAE     n
   &lt;fct&gt;             &lt;dbl&gt; &lt;int&gt;
 1 2024_Arapoti_Cedo    49    11
 2 2024_Arapoti_Cedo    54    11
 3 2024_Arapoti_Cedo    62    11
 4 2024_Arapoti_Cedo    68    11
 5 2024_Arapoti_Cedo    78    11
 6 2024_Arapoti_Cedo    84    11
 7 2024_Arapoti_Cedo    90    11
 8 2024_Arapoti_Cedo    97    11
 9 2024_Arapoti_Cedo   103    11
10 2024_Arapoti_Cedo   109    11
# ℹ 61 more rows</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="helper-functions-scalars" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="helper-functions-scalars"><span class="header-section-number">6</span> Helper functions (scalars)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># T50: time when y reaches 0.5*ymax (linear interpolation)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>t50_interp <span class="ot">&lt;-</span> <span class="cf">function</span>(time, y){</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  o <span class="ot">&lt;-</span> <span class="fu">order</span>(time)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> time[o]; y <span class="ot">&lt;-</span> y[o]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  ymax <span class="ot">&lt;-</span> <span class="fu">max</span>(y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  thr  <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> ymax</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">all</span>(y <span class="sc">&lt;</span> thr, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="fu">return</span>(<span class="cn">NA_real_</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> <span class="fu">which</span>(y <span class="sc">&gt;=</span> thr)[<span class="dv">1</span>]</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(k <span class="sc">==</span> <span class="dv">1</span>) <span class="fu">return</span>(time[<span class="dv">1</span>])</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  t1 <span class="ot">&lt;-</span> time[k<span class="dv">-1</span>]; t2 <span class="ot">&lt;-</span> time[k]</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> y[k<span class="dv">-1</span>];    y2 <span class="ot">&lt;-</span> y[k]</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">isTRUE</span>(<span class="fu">all.equal</span>(y2, y1))) <span class="fu">return</span>(t2)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  t1 <span class="sc">+</span> (thr <span class="sc">-</span> y1) <span class="sc">*</span> (t2 <span class="sc">-</span> t1) <span class="sc">/</span> (y2 <span class="sc">-</span> y1)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Logistic fit: y(t)=K/(1+exp(-r(t-t0))) and r_norm = r*(tmax-tmin)</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>logistic_fit_rate <span class="ot">&lt;-</span> <span class="cf">function</span>(time, y){</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  o <span class="ot">&lt;-</span> <span class="fu">order</span>(time)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> time[o]; y <span class="ot">&lt;-</span> y[o]</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(y, <span class="fl">1e-4</span>), <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1e-4</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  K0  <span class="ot">&lt;-</span> <span class="fu">max</span>(y)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  d   <span class="ot">&lt;-</span> <span class="fu">diff</span>(y)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  t00 <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="fu">length</span>(d) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">any</span>(<span class="fu">is.finite</span>(d))) time[<span class="fu">which.max</span>(d) <span class="sc">+</span> <span class="dv">1</span>] <span class="cf">else</span> <span class="fu">median</span>(time)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.na</span>(t00)) t00 <span class="ot">&lt;-</span> <span class="fu">median</span>(time)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  r0  <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nls</span>(</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>      y <span class="sc">~</span> K <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>r <span class="sc">*</span> (time <span class="sc">-</span> t0))),</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">start =</span> <span class="fu">list</span>(<span class="at">K =</span> K0, <span class="at">r =</span> r0, <span class="at">t0 =</span> t00),</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">control =</span> <span class="fu">nls.control</span>(<span class="at">maxiter =</span> <span class="dv">200</span>, <span class="at">warnOnly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(f)) <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">r =</span> <span class="cn">NA_real_</span>, <span class="at">K =</span> <span class="cn">NA_real_</span>, <span class="at">t0 =</span> <span class="cn">NA_real_</span>, <span class="at">r_norm =</span> <span class="cn">NA_real_</span>))</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>  co  <span class="ot">&lt;-</span> <span class="fu">coef</span>(f)</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>  r   <span class="ot">&lt;-</span> <span class="fu">unname</span>(co[<span class="st">"r"</span>])</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>  K   <span class="ot">&lt;-</span> <span class="fu">unname</span>(co[<span class="st">"K"</span>])</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>  t0  <span class="ot">&lt;-</span> <span class="fu">unname</span>(co[<span class="st">"t0"</span>])</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>  dur <span class="ot">&lt;-</span> <span class="fu">max</span>(time) <span class="sc">-</span> <span class="fu">min</span>(time)</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">r =</span> r, <span class="at">K =</span> K, <span class="at">t0 =</span> t0, <span class="at">r_norm =</span> r <span class="sc">*</span> dur)</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="per-curve-scalar-metrics-audpc-final-t50-r_norm" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="per-curve-scalar-metrics-audpc-final-t50-r_norm"><span class="header-section-number">7</span> Per-curve scalar metrics (AUDPC, final, T50, r_norm)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>curve_stats <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(curve_id, Ambiente, Hibrido) <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">AUDPC     =</span> pracma<span class="sc">::</span><span class="fu">trapz</span>(DAE, y),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_sev =</span> y[<span class="fu">which.max</span>(DAE)],</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">T50       =</span> <span class="fu">t50_interp</span>(DAE, y),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups   =</span> <span class="st">"drop"</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>rate_df <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(<span class="fu">unique</span>(curve_stats<span class="sc">$</span>curve_id), <span class="cf">function</span>(cid){</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">filter</span>(curve_id <span class="sc">==</span> cid)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logistic_fit_rate</span>(df<span class="sc">$</span>DAE, df<span class="sc">$</span>y) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">curve_id =</span> <span class="fu">as.character</span>(cid))</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>curve_stats <span class="ot">&lt;-</span> curve_stats <span class="sc">%&gt;%</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">curve_id =</span> <span class="fu">as.character</span>(curve_id)) <span class="sc">%&gt;%</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(rate_df, <span class="at">by =</span> <span class="st">"curve_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(T50), <span class="fu">is.finite</span>(r_norm))</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Curves with all scalar metrics: "</span>, <span class="fu">nrow</span>(curve_stats))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="hierarchical-beta-gam-hgam-for-smoothing-and-adjustment" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="hierarchical-beta-gam-hgam-for-smoothing-and-adjustment"><span class="header-section-number">8</span> Hierarchical beta-GAM (HGAM) for smoothing and adjustment</h2>
<p>Model specification (as in your script):</p>
<ul>
<li><span class="math inline">\(s(\mathrm{DAE})\)</span> global mean epidemic shape<br>
</li>
<li><span class="math inline">\(s(\mathrm{DAE}, \mathrm{Ambiente}, \mathrm{bs}=\mathrm{fs})\)</span> environment-specific deviation (random smooth)<br>
</li>
<li><span class="math inline">\(s(\mathrm{DAE}, \mathrm{Hibrido}, \mathrm{bs}=\mathrm{fs})\)</span> hybrid-specific deviation (random smooth)<br>
</li>
<li><span class="math inline">\(s(\mathrm{curve\_id}, \mathrm{bs}=\mathrm{re})\)</span> curve-level random intercept</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>m_gam <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">bam</span>(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="fu">s</span>(DAE, <span class="at">k =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">s</span>(DAE, Ambiente, <span class="at">bs =</span> <span class="st">"fs"</span>, <span class="at">k =</span> <span class="dv">4</span>, <span class="at">m =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">s</span>(DAE, Hibrido,  <span class="at">bs =</span> <span class="st">"fs"</span>, <span class="at">k =</span> <span class="dv">4</span>, <span class="at">m =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">s</span>(curve_id, <span class="at">bs =</span> <span class="st">"re"</span>),</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">family   =</span> mgcv<span class="sc">::</span><span class="fu">betar</span>(<span class="at">link =</span> <span class="st">"logit"</span>),</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">data     =</span> dat,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">method   =</span> <span class="st">"fREML"</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">discrete =</span> <span class="cn">TRUE</span>,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">gamma    =</span> <span class="fl">1.4</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">select   =</span> <span class="cn">TRUE</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>mgcv<span class="sc">::</span><span class="fu">gam.check</span>(m_gam)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/gam-fit-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Method: fREML   Optimizer: perf chol
$grad
[1] 0.016704037 0.019373913 0.003781286 0.000570410 0.009893921 0.001340477
[7] 0.005584336

$hess
            [,1]         [,2]        [,3]         [,4]         [,5]
[1,]  1.76973968  0.103240242  0.07497799 -0.026833664 -0.030551157
[2,]  0.10324024  0.463675572 -0.02555147 -0.007386378  0.008808052
[3,]  0.07497799 -0.025551472  5.46217720 -0.193678316 -0.029884938
[4,] -0.02683366 -0.007386378 -0.19367832  2.253819385 -0.016483741
[5,] -0.03055116  0.008808052 -0.02988494 -0.016483741  8.933297269
[6,] -0.01726069 -0.004515995 -0.01074387 -0.049394610 -0.039103272
[7,] -0.01123920 -0.002223781 -0.06748220  0.103872441 -0.101083877
             [,6]         [,7]
[1,] -0.017260693 -0.011239202
[2,] -0.004515995 -0.002223781
[3,] -0.010743870 -0.067482197
[4,] -0.049394610  0.103872441
[5,] -0.039103272 -0.101083877
[6,]  4.419106114  0.527487268
[7,]  0.527487268 22.335109114

Model rank =  160 / 160 

Basis dimension (k) checking results. Low p-value (k-index&lt;1) may
indicate that k is too low, especially if edf is close to k'.

                   k'   edf k-index p-value
s(DAE)           9.00  5.92    1.08    0.99
s(DAE,Ambiente) 24.00 17.47    1.08    0.98
s(DAE,Hibrido)  52.00 33.67    1.08    0.99
s(curve_id)     74.00 51.12      NA      NA</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(m_gam)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -4425.653</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_gam)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: Beta regression(84.639) 
Link function: logit 

Formula:
y ~ s(DAE, k = 10) + s(DAE, Ambiente, bs = "fs", k = 4, m = 1) + 
    s(DAE, Hibrido, bs = "fs", k = 4, m = 1) + s(curve_id, bs = "re")

Parametric coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  -2.7529     0.2073  -13.28   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
                   edf Ref.df      F p-value    
s(DAE)           5.925      9  43.49  &lt;2e-16 ***
s(DAE,Ambiente) 17.466     23 266.33   0.992    
s(DAE,Hibrido)  33.670     52 980.08   0.998    
s(curve_id)     51.117     73  16.56  &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

R-sq.(adj) =  0.948   Deviance explained = 97.7%
fREML = -865.46  Scale est. = 1         n = 885</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>m_gam2 <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">bam</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="fu">s</span>(DAE, <span class="at">k =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">s</span>(DAE, Ambiente, <span class="at">bs =</span> <span class="st">"fs"</span>, <span class="at">k =</span> <span class="dv">6</span>, <span class="at">m =</span> <span class="dv">2</span>) <span class="sc">+</span>  <span class="co"># k↑, m=2</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">s</span>(DAE, Hibrido,  <span class="at">bs =</span> <span class="st">"fs"</span>, <span class="at">k =</span> <span class="dv">6</span>, <span class="at">m =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">s</span>(curve_id, <span class="at">bs =</span> <span class="st">"re"</span>),</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">family   =</span> mgcv<span class="sc">::</span><span class="fu">betar</span>(<span class="at">link =</span> <span class="st">"logit"</span>),</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data     =</span> dat,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">method   =</span> <span class="st">"fREML"</span>,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">discrete =</span> <span class="cn">TRUE</span>,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">gamma    =</span> <span class="fl">1.4</span>,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">select   =</span> <span class="cn">TRUE</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>mgcv<span class="sc">::</span><span class="fu">gam.check</span>(m_gam2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/gam-fit-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Method: fREML   Optimizer: perf chol
$grad
[1]  0.0032876299  0.0009501577  0.0486021224  0.0026125794 -0.0004461866
[6]  0.0274469802  0.0106350953  0.0245537013  0.0417448875

$hess
               [,1]          [,2]          [,3]          [,4]          [,5]
 [1,]  6.985031e-01  1.981914e-01  2.889002e-01 -1.143280e-02  8.880166e-06
 [2,]  1.981914e-01  4.310968e-01 -8.621333e-02  2.161799e-03 -4.742978e-05
 [3,]  2.889002e-01 -8.621333e-02  4.300863e+00 -6.791003e-02 -3.216533e-05
 [4,] -1.143280e-02  2.161799e-03 -6.791003e-02  2.243643e+00 -9.434701e-05
 [5,]  8.880166e-06 -4.742978e-05 -3.216533e-05 -9.434701e-05  4.463362e-04
 [6,] -7.016489e-03  9.660442e-03  6.108520e-03 -3.611582e-03 -3.145384e-05
 [7,] -2.080334e-03 -2.961120e-03 -5.918645e-02 -4.589021e-02  3.319564e-05
 [8,] -9.149235e-03 -4.857492e-03 -1.854552e-01 -5.744177e-03  8.779050e-06
 [9,] -8.423702e-03 -4.532488e-03 -3.956616e-02  1.800791e-01  4.166978e-05
               [,6]          [,7]          [,8]          [,9]
 [1,] -7.016489e-03 -2.080334e-03 -9.149235e-03 -8.423702e-03
 [2,]  9.660442e-03 -2.961120e-03 -4.857492e-03 -4.532488e-03
 [3,]  6.108520e-03 -5.918645e-02 -1.854552e-01 -3.956616e-02
 [4,] -3.611582e-03 -4.589021e-02 -5.744177e-03  1.800791e-01
 [5,] -3.145384e-05  3.319564e-05  8.779050e-06  4.166978e-05
 [6,]  2.226600e+00  7.606699e-02  1.087811e+00  4.965510e-02
 [7,]  7.606699e-02  4.385212e+00 -3.276525e-01  6.702370e-01
 [8,]  1.087811e+00 -3.276525e-01  3.387114e+00 -7.566166e-02
 [9,]  4.965510e-02  6.702370e-01 -7.566166e-02  2.251155e+01

Model rank =  198 / 198 

Basis dimension (k) checking results. Low p-value (k-index&lt;1) may
indicate that k is too low, especially if edf is close to k'.

                   k'   edf k-index p-value
s(DAE)           9.00  3.74    1.11       1
s(DAE,Ambiente) 36.00 24.36    1.11       1
s(DAE,Hibrido)  78.00 33.42    1.11       1
s(curve_id)     74.00 51.81      NA      NA</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(m_gam2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -4468.783</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_gam2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: Beta regression(90.641) 
Link function: logit 

Formula:
y ~ s(DAE, k = 10) + s(DAE, Ambiente, bs = "fs", k = 6, m = 2) + 
    s(DAE, Hibrido, bs = "fs", k = 6, m = 2) + s(curve_id, bs = "re")

Parametric coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  -2.6974     0.1689  -15.97   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
                   edf Ref.df      F p-value    
s(DAE)           3.742      9 185.93    0.32    
s(DAE,Ambiente) 24.359     36 195.35    1.00    
s(DAE,Hibrido)  33.425     78 117.89    1.00    
s(curve_id)     51.813     73  44.09  &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

R-sq.(adj) =  0.951   Deviance explained = 97.9%
fREML = -867.22  Scale est. = 1         n = 885</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(m_gam, m_gam2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             df       AIC
m_gam  112.6431 -4425.653
m_gam2 121.2807 -4468.783</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">BIC</span>(m_gam, m_gam2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             df       BIC
m_gam  112.6431 -3886.589
m_gam2 121.2807 -3888.384</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Modelo =</span> <span class="fu">c</span>(<span class="st">"k=4, m=1"</span>, <span class="st">"k=6, m=2"</span>),</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">AIC =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">4425.6</span>, <span class="sc">-</span><span class="fl">4469.4</span>),</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">BIC =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">3886.9</span>, <span class="sc">-</span><span class="fl">3892.1</span>),</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">edf_total =</span> <span class="fu">c</span>(<span class="fl">112.6</span>, <span class="fl">120.6</span>),</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">edf_ambiente =</span> <span class="fu">c</span>(<span class="fl">17.5</span>, <span class="fl">24.0</span>),</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">k_index_min =</span> <span class="fu">c</span>(<span class="fl">1.08</span>, <span class="fl">1.11</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  Modelo      AIC    BIC edf_total edf_ambiente k_index_min
  &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;
1 k=4, m=1 -4426. -3887.      113.         17.5        1.08
2 k=6, m=2 -4469. -3892.      121.         24          1.11</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">res_k4 =</span> <span class="fu">residuals</span>(m_gam, <span class="at">type =</span> <span class="st">"pearson"</span>),</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">res_k6 =</span> <span class="fu">residuals</span>(m_gam2, <span class="at">type =</span> <span class="st">"pearson"</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Desvio padrão dos resíduos por ambiente</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ambiente) <span class="sc">%&gt;%</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">SD_k4 =</span> <span class="fu">sd</span>(res_k4),</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">SD_k6 =</span> <span class="fu">sd</span>(res_k6),</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">Melhoria =</span> (SD_k4 <span class="sc">-</span> SD_k6) <span class="sc">/</span> SD_k4 <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Melhoria))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  Ambiente                       SD_k4 SD_k6 Melhoria
  &lt;fct&gt;                          &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
1 2024_Arapoti_Cedo              0.928 0.873    5.91 
2 2024_Ponta Grossa_Preferencial 0.851 0.837    1.66 
3 2024_Castro_Preferencial       1.14  1.14     0.368
4 2024_Itabera_Preferencial      0.754 0.755   -0.186
5 2024_Arapoti_Preferencial      0.811 0.820   -1.07 
6 2024_Ponta Grossa_Cedo         0.931 0.950   -1.95 </code></pre>
</div>
</div>
<section id="diagnostics-observed-vs-fitted-and-residuals" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="diagnostics-observed-vs-fitted-and-residuals"><span class="header-section-number">8.1</span> Diagnostics (observed vs fitted and residuals)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>mu_hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(m_gam2, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(mu_hat, y)) <span class="sc">+</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Fitted"</span>, <span class="at">y =</span> <span class="st">"Observed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/gam-diagnostics-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">residuals</span>(m_gam2, <span class="at">type =</span> <span class="st">"pearson"</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dat<span class="sc">$</span>DAE, res)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/gam-diagnostics-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="environment-adjusted-hybrid-mean-curves" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="environment-adjusted-hybrid-mean-curves"><span class="header-section-number">9</span> Environment-adjusted hybrid mean curves</h2>
<p>We obtain hybrid mean curves on a regular grid <strong>excluding</strong>:</p>
<ul>
<li>the environment random smooth term <code>s(DAE,Ambiente)</code></li>
<li>the curve random intercept <code>s(curve_id)</code></li>
</ul>
<p>so each hybrid is represented at a chosen reference environment level.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>t_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(dat<span class="sc">$</span>DAE), <span class="fu">max</span>(dat<span class="sc">$</span>DAE), <span class="at">length.out =</span> grid_n)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>env_ref <span class="ot">&lt;-</span> <span class="fu">levels</span>(dat<span class="sc">$</span>Ambiente)[<span class="dv">1</span>]</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>cultivars <span class="ot">&lt;-</span> <span class="fu">levels</span>(dat<span class="sc">$</span>Hibrido)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>pred_cult <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(cultivars, <span class="cf">function</span>(cv){</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  newd <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">DAE      =</span> t_grid,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ambiente =</span> <span class="fu">factor</span>(env_ref, <span class="at">levels =</span> <span class="fu">levels</span>(dat<span class="sc">$</span>Ambiente)),</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Hibrido  =</span> <span class="fu">factor</span>(cv, <span class="at">levels =</span> <span class="fu">levels</span>(dat<span class="sc">$</span>Hibrido)),</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">curve_id =</span> dat<span class="sc">$</span>curve_id[<span class="dv">1</span>]  <span class="co"># dummy; excluded below</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    m_gam2, <span class="at">newdata =</span> newd, <span class="at">type =</span> <span class="st">"response"</span>,</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">exclude =</span> <span class="fu">c</span>(<span class="st">"s(DAE,Ambiente)"</span>, <span class="st">"s(curve_id)"</span>)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">Hibrido =</span> cv, <span class="at">DAE =</span> t_grid, <span class="at">mu =</span> <span class="fu">as.numeric</span>(mu))</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>cult_score <span class="ot">&lt;-</span> pred_cult <span class="sc">%&gt;%</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Hibrido) <span class="sc">%&gt;%</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_mu =</span> <span class="fu">mean</span>(mu), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(mean_mu)</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>cult_score</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 2
   Hibrido      mean_mu
   &lt;chr&gt;          &lt;dbl&gt;
 1 P 3016 VYHR   0.0970
 2 CRWX03        0.0993
 3 AS 1868 PRO4  0.121 
 4 MG 616 PWU    0.121 
 5 T 1503 PWU    0.125 
 6 AG 8701 PRO4  0.129 
 7 B 2801 PWU    0.134 
 8 AG 9021 PRO3  0.136 
 9 DKB 230 PRO3  0.148 
10 DKB 242 PRO4  0.158 
11 AS 1955 PRO4  0.165 
12 AS 1757 PRO4  0.192 
13 AG 8707 PRO4  0.195 </code></pre>
</div>
</div>
<hr>
</section>
<section id="functional-distance-among-hybrids-clustering" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="functional-distance-among-hybrids-clustering"><span class="header-section-number">10</span> Functional distance among hybrids + clustering</h2>
<section id="utility-shorten-hybrid-labels" class="level3" data-number="10.1">
<h3 data-number="10.1" class="anchored" data-anchor-id="utility-shorten-hybrid-labels"><span class="header-section-number">10.1</span> Utility: shorten hybrid labels</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>shorten_hybrid <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" PRO[0-9]+| PWU| VYHR"</span>, <span class="st">""</span>, x)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">""</span>, x)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  x</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="build-distance-matrix-and-cluster" class="level3" data-number="10.2">
<h3 data-number="10.2" class="anchored" data-anchor-id="build-distance-matrix-and-cluster"><span class="header-section-number">10.2</span> Build distance matrix and cluster</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Wide matrix: rows = time, cols = hybrid</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> pred_cult <span class="sc">%&gt;%</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(DAE, Hibrido, mu) <span class="sc">%&gt;%</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> Hibrido, <span class="at">values_from =</span> mu) <span class="sc">%&gt;%</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(DAE)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>dt_grid <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">diff</span>(mat<span class="sc">$</span>DAE))</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>matX <span class="ot">&lt;-</span> mat <span class="sc">%&gt;%</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>DAE) <span class="sc">%&gt;%</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Functional L2 distance (grid approximation)</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>D_cult <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(<span class="fu">t</span>(matX), <span class="at">method =</span> <span class="st">"euclidean"</span>)) <span class="sc">*</span> <span class="fu">sqrt</span>(dt_grid)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>hc <span class="ot">&lt;-</span> <span class="fu">hclust</span>(<span class="fu">as.dist</span>(D_cult), <span class="at">method =</span> <span class="st">"ward.D2"</span>)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>cl_raw <span class="ot">&lt;-</span> <span class="fu">cutree</span>(hc, <span class="at">k =</span> k_clusters)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Order clusters by mean severity (from cult_score)</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>cluster_rank_map <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">Hibrido =</span> <span class="fu">names</span>(cl_raw),</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>                           <span class="at">cluster_raw =</span> <span class="fu">as.integer</span>(cl_raw)) <span class="sc">%&gt;%</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(cult_score <span class="sc">%&gt;%</span> <span class="fu">select</span>(Hibrido, mean_mu), <span class="at">by =</span> <span class="st">"Hibrido"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster_raw) <span class="sc">%&gt;%</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">cluster_mean =</span> <span class="fu">mean</span>(mean_mu, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(cluster_mean) <span class="sc">%&gt;%</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cluster =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(cluster_raw, cluster)</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>cluster_table2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">Hibrido =</span> <span class="fu">names</span>(cl_raw),</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cluster_raw =</span> <span class="fu">as.integer</span>(cl_raw)) <span class="sc">%&gt;%</span></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(cluster_rank_map, <span class="at">by =</span> <span class="st">"cluster_raw"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(cult_score <span class="sc">%&gt;%</span> <span class="fu">select</span>(Hibrido, mean_mu), <span class="at">by =</span> <span class="st">"Hibrido"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">phenotype =</span> <span class="fu">factor</span>(cluster,</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>                       <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span>k_clusters,</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> <span class="fu">paste0</span>(<span class="st">"P"</span>, <span class="dv">1</span><span class="sc">:</span>k_clusters))</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>cluster_table2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 5
   Hibrido      cluster_raw cluster mean_mu phenotype
   &lt;chr&gt;              &lt;int&gt;   &lt;int&gt;   &lt;dbl&gt; &lt;fct&gt;    
 1 AG 8701 PRO4           1       2  0.129  P2       
 2 AG 8707 PRO4           2       4  0.195  P4       
 3 AG 9021 PRO3           1       2  0.136  P2       
 4 AS 1757 PRO4           2       4  0.192  P4       
 5 AS 1868 PRO4           1       2  0.121  P2       
 6 AS 1955 PRO4           3       3  0.165  P3       
 7 B 2801 PWU             1       2  0.134  P2       
 8 CRWX03                 4       1  0.0993 P1       
 9 DKB 230 PRO3           1       2  0.148  P2       
10 DKB 242 PRO4           3       3  0.158  P3       
11 MG 616 PWU             1       2  0.121  P2       
12 P 3016 VYHR            4       1  0.0970 P1       
13 T 1503 PWU             1       2  0.125  P2       </code></pre>
</div>
</div>
</section>
<section id="figure-mean-curves-by-phenotype-dendrogram" class="level3" data-number="10.3">
<h3 data-number="10.3" class="anchored" data-anchor-id="figure-mean-curves-by-phenotype-dendrogram"><span class="header-section-number">10.3</span> Figure: mean curves by phenotype + dendrogram</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#D55E00"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#009E73"</span>, <span class="st">"#CC79A7"</span>)[<span class="dv">1</span><span class="sc">:</span>k_clusters]</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>phen_cols <span class="ot">&lt;-</span> <span class="fu">setNames</span>(cols, <span class="fu">levels</span>(cluster_table2<span class="sc">$</span>phenotype))</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>pred_cult2 <span class="ot">&lt;-</span> pred_cult <span class="sc">%&gt;%</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(cluster_table2 <span class="sc">%&gt;%</span> <span class="fu">select</span>(Hibrido, phenotype), <span class="at">by =</span> <span class="st">"Hibrido"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hybrid_short =</span> <span class="fu">shorten_hybrid</span>(Hibrido))</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>pred_cult2 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(pred_cult2, bipolaris_df)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>label_df <span class="ot">&lt;-</span> pred_cult2 <span class="sc">%&gt;%</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Hibrido) <span class="sc">%&gt;%</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(DAE <span class="sc">==</span> <span class="fu">max</span>(DAE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>p_hibridos <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pred_cult2,</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">aes</span>(<span class="at">x =</span> DAE, <span class="at">y =</span> mu, <span class="at">group =</span> Hibrido, <span class="at">linetype  =</span> resistance, <span class="at">color =</span> phenotype)) <span class="sc">+</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.1</span>, <span class="at">alpha =</span> <span class="fl">0.95</span>) <span class="sc">+</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>  ggrepel<span class="sc">::</span><span class="fu">geom_text_repel</span>(</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> label_df,</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">label =</span> hybrid_short),</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">direction =</span> <span class="st">"y"</span>,</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_x =</span> <span class="dv">2</span>,</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">2.8</span>,</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.size =</span> <span class="fl">0.2</span>,</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.alpha =</span> <span class="fl">0.6</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_limits</span>(<span class="at">x =</span> <span class="fu">max</span>(pred_cult2<span class="sc">$</span>DAE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> <span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> phen_cols, <span class="at">drop =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Days after emergence (DAE)"</span>,</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Environment-adjusted mean severity"</span>,</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Phenotype"</span>, <span class="at">linetype =</span> <span class="st">"Resistance"</span>) <span class="sc">+</span></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>ddata <span class="ot">&lt;-</span> ggdendro<span class="sc">::</span><span class="fu">dendro_data</span>(<span class="fu">as.dendrogram</span>(hc), <span class="at">type =</span> <span class="st">"rectangle"</span>)</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>lab_map <span class="ot">&lt;-</span> cluster_table2 <span class="sc">%&gt;%</span></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> Hibrido,</span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>         <span class="at">label_short =</span> <span class="fu">shorten_hybrid</span>(Hibrido),</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>         <span class="at">lab_col =</span> phen_cols[<span class="fu">as.character</span>(phenotype)]) <span class="sc">%&gt;%</span></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(label, label_short, lab_col)</span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>lab_df <span class="ot">&lt;-</span> ddata<span class="sc">$</span>labels <span class="sc">%&gt;%</span></span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(lab_map, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"label"</span> <span class="ot">=</span> <span class="st">"label"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label_short =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(label_short), <span class="fu">shorten_hybrid</span>(label), label_short))</span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>p_dend <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> ddata<span class="sc">$</span>segments,</span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend),</span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>               <span class="at">linewidth =</span> <span class="fl">0.45</span>) <span class="sc">+</span></span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> lab_df,</span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y <span class="sc">-</span> <span class="fl">0.02</span> <span class="sc">*</span> <span class="fu">max</span>(ddata<span class="sc">$</span>segments<span class="sc">$</span>y),</span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a>                <span class="at">label =</span> label_short, <span class="at">color =</span> <span class="fu">I</span>(lab_col)),</span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a>            <span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Functional distance"</span>) <span class="sc">+</span></span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.line.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x  =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">clip =</span> <span class="st">"off"</span>) <span class="sc">+</span></span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="fl">5.5</span>, <span class="at">r =</span> <span class="fl">5.5</span>, <span class="at">b =</span> <span class="dv">18</span>, <span class="at">l =</span> <span class="fl">5.5</span>))</span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a>h_cut <span class="ot">&lt;-</span> hc<span class="sc">$</span>height[<span class="fu">length</span>(hc<span class="sc">$</span>height) <span class="sc">-</span> (k_clusters <span class="sc">-</span> <span class="dv">1</span>)]</span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true" tabindex="-1"></a>p_dend <span class="ot">&lt;-</span> p_dend <span class="sc">+</span></span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> h_cut, <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb37-66"><a href="#cb37-66" aria-hidden="true" tabindex="-1"></a>             <span class="at">linewidth =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"grey30"</span>)</span>
<span id="cb37-67"><a href="#cb37-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-68"><a href="#cb37-68" aria-hidden="true" tabindex="-1"></a>fig_final <span class="ot">&lt;-</span> (p_hibridos <span class="sc">|</span> p_dend) <span class="sc">+</span> <span class="fu">plot_annotation</span>(<span class="at">tag_levels =</span> <span class="st">"A"</span>)</span>
<span id="cb37-69"><a href="#cb37-69" aria-hidden="true" tabindex="-1"></a>fig_final</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/figure-functional-panels-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("Figure2_functional_phenotypes.png", fig_final, width = 12, height = 5.5, dpi = 300)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
</section>
<section id="scalar-equivalent-but-trajectory-distinct-curves" class="level2" data-number="11">
<h2 data-number="11" class="anchored" data-anchor-id="scalar-equivalent-but-trajectory-distinct-curves"><span class="header-section-number">11</span> Scalar-equivalent but trajectory-distinct curves</h2>
<p>We select two <strong>individual curves</strong> (by <code>curve_id</code>) that are close in scalar space (AUDPC + final severity) but have large functional distance on a common grid.</p>
<section id="select-candidate-pairs-scalar-nearest-and-maximize-functional-distance" class="level3" data-number="11.1">
<h3 data-number="11.1" class="anchored" data-anchor-id="select-candidate-pairs-scalar-nearest-and-maximize-functional-distance"><span class="header-section-number">11.1</span> Select candidate pairs (scalar-nearest) and maximize functional distance</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 0) Prep scalar stats table (one row per curve)</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>dfS <span class="ot">&lt;-</span> curve_stats <span class="sc">%&gt;%</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">curve_id  =</span> <span class="fu">as.character</span>(curve_id),</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">AUDPC     =</span> <span class="fu">as.numeric</span>(AUDPC),</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_sev =</span> <span class="fu">as.numeric</span>(final_sev)</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(AUDPC), <span class="fu">is.finite</span>(final_sev)) <span class="sc">%&gt;%</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(curve_id, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">AUDPC_z =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(AUDPC)),</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_z =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(final_sev))</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">nrow</span>(dfS) <span class="sc">&gt;=</span> <span class="dv">2</span>)</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Common dt for functional distance</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">diff</span>(t_grid))</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Utilities (define ONCE, keep signature consistent)</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>interp_curve <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, t_grid, id){</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">as.character</span>(curve_id) <span class="sc">==</span> id) <span class="sc">%&gt;%</span></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(DAE)</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>  stats<span class="sc">::</span><span class="fu">approx</span>(df<span class="sc">$</span>DAE, df<span class="sc">$</span>y, <span class="at">xout =</span> t_grid, <span class="at">rule =</span> <span class="dv">2</span>)<span class="sc">$</span>y</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>pairwise_table <span class="ot">&lt;-</span> <span class="cf">function</span>(dfS){</span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crossing</span>(</span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>    dfS <span class="sc">%&gt;%</span></span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">paste0</span>(.x, <span class="st">".x"</span>), <span class="sc">-</span>curve_id) <span class="sc">%&gt;%</span></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">curve_id.x =</span> curve_id),</span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>    dfS <span class="sc">%&gt;%</span></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">paste0</span>(.x, <span class="st">".y"</span>), <span class="sc">-</span>curve_id) <span class="sc">%&gt;%</span></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">curve_id.y =</span> curve_id)</span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(curve_id.x <span class="sc">&lt;</span> curve_id.y)</span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a>add_func_dist <span class="ot">&lt;-</span> <span class="cf">function</span>(pairs_df, dat, t_grid, dt){</span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a>  pairs_df <span class="sc">%&gt;%</span></span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">func_dist =</span> {</span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a>        y1 <span class="ot">&lt;-</span> <span class="fu">interp_curve</span>(dat, t_grid, curve_id.x)</span>
<span id="cb39-54"><a href="#cb39-54" aria-hidden="true" tabindex="-1"></a>        y2 <span class="ot">&lt;-</span> <span class="fu">interp_curve</span>(dat, t_grid, curve_id.y)</span>
<span id="cb39-55"><a href="#cb39-55" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sqrt</span>(<span class="fu">sum</span>((y1 <span class="sc">-</span> y2)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> dt)</span>
<span id="cb39-56"><a href="#cb39-56" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb39-57"><a href="#cb39-57" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb39-58"><a href="#cb39-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb39-59"><a href="#cb39-59" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-60"><a href="#cb39-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-61"><a href="#cb39-61" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb39-62"><a href="#cb39-62" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Build base pair table with scalar distances/gaps</span></span>
<span id="cb39-63"><a href="#cb39-63" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb39-64"><a href="#cb39-64" aria-hidden="true" tabindex="-1"></a>pairs0 <span class="ot">&lt;-</span> <span class="fu">pairwise_table</span>(dfS) <span class="sc">%&gt;%</span></span>
<span id="cb39-65"><a href="#cb39-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb39-66"><a href="#cb39-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">scalar_dist =</span> <span class="fu">sqrt</span>((AUDPC_z.x <span class="sc">-</span> AUDPC_z.y)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (final_z.x <span class="sc">-</span> final_z.y)<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb39-67"><a href="#cb39-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">audpc_gap   =</span> <span class="fu">abs</span>(AUDPC.x <span class="sc">-</span> AUDPC.y),</span>
<span id="cb39-68"><a href="#cb39-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_gap   =</span> <span class="fu">abs</span>(final_sev.x <span class="sc">-</span> final_sev.y)</span>
<span id="cb39-69"><a href="#cb39-69" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb39-70"><a href="#cb39-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-71"><a href="#cb39-71" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb39-72"><a href="#cb39-72" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Panel A: "killer pair" = very similar scalar, maximize functional distance</span></span>
<span id="cb39-73"><a href="#cb39-73" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb39-74"><a href="#cb39-74" aria-hidden="true" tabindex="-1"></a>thr  <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pairs0<span class="sc">$</span>scalar_dist, <span class="fl">0.03</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-75"><a href="#cb39-75" aria-hidden="true" tabindex="-1"></a>candA <span class="ot">&lt;-</span> pairs0 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(scalar_dist <span class="sc">&lt;=</span> thr)</span>
<span id="cb39-76"><a href="#cb39-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-77"><a href="#cb39-77" aria-hidden="true" tabindex="-1"></a>candA2 <span class="ot">&lt;-</span> candA <span class="sc">%&gt;%</span></span>
<span id="cb39-78"><a href="#cb39-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_func_dist</span>(dat, t_grid, dt)</span>
<span id="cb39-79"><a href="#cb39-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-80"><a href="#cb39-80" aria-hidden="true" tabindex="-1"></a>best_A <span class="ot">&lt;-</span> candA2 <span class="sc">%&gt;%</span></span>
<span id="cb39-81"><a href="#cb39-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(func_dist), scalar_dist) <span class="sc">%&gt;%</span></span>
<span id="cb39-82"><a href="#cb39-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb39-83"><a href="#cb39-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-84"><a href="#cb39-84" aria-hidden="true" tabindex="-1"></a>idA1 <span class="ot">&lt;-</span> best_A<span class="sc">$</span>curve_id.x</span>
<span id="cb39-85"><a href="#cb39-85" aria-hidden="true" tabindex="-1"></a>idA2 <span class="ot">&lt;-</span> best_A<span class="sc">$</span>curve_id.y</span>
<span id="cb39-86"><a href="#cb39-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-87"><a href="#cb39-87" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb39-88"><a href="#cb39-88" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Panel B: maximize AUDPC gap (optionally annotate functional distance)</span></span>
<span id="cb39-89"><a href="#cb39-89" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb39-90"><a href="#cb39-90" aria-hidden="true" tabindex="-1"></a>best_B <span class="ot">&lt;-</span> pairs0 <span class="sc">%&gt;%</span></span>
<span id="cb39-91"><a href="#cb39-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(audpc_gap)) <span class="sc">%&gt;%</span></span>
<span id="cb39-92"><a href="#cb39-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb39-93"><a href="#cb39-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_func_dist</span>(dat, t_grid, dt)</span>
<span id="cb39-94"><a href="#cb39-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-95"><a href="#cb39-95" aria-hidden="true" tabindex="-1"></a>idB1 <span class="ot">&lt;-</span> best_B<span class="sc">$</span>curve_id.x</span>
<span id="cb39-96"><a href="#cb39-96" aria-hidden="true" tabindex="-1"></a>idB2 <span class="ot">&lt;-</span> best_B<span class="sc">$</span>curve_id.y</span>
<span id="cb39-97"><a href="#cb39-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-98"><a href="#cb39-98" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb39-99"><a href="#cb39-99" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) Panel C: same final, different AUDPC (safe fallback if empty)</span></span>
<span id="cb39-100"><a href="#cb39-100" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb39-101"><a href="#cb39-101" aria-hidden="true" tabindex="-1"></a>final_tol <span class="ot">&lt;-</span> <span class="fl">0.03</span></span>
<span id="cb39-102"><a href="#cb39-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-103"><a href="#cb39-103" aria-hidden="true" tabindex="-1"></a>candC <span class="ot">&lt;-</span> pairs0 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(final_gap <span class="sc">&lt;=</span> final_tol)</span>
<span id="cb39-104"><a href="#cb39-104" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(candC) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb39-105"><a href="#cb39-105" aria-hidden="true" tabindex="-1"></a>  final_tol <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb39-106"><a href="#cb39-106" aria-hidden="true" tabindex="-1"></a>  candC <span class="ot">&lt;-</span> pairs0 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(final_gap <span class="sc">&lt;=</span> final_tol)</span>
<span id="cb39-107"><a href="#cb39-107" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-108"><a href="#cb39-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-109"><a href="#cb39-109" aria-hidden="true" tabindex="-1"></a>best_C <span class="ot">&lt;-</span> candC <span class="sc">%&gt;%</span></span>
<span id="cb39-110"><a href="#cb39-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(audpc_gap), final_gap) <span class="sc">%&gt;%</span></span>
<span id="cb39-111"><a href="#cb39-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb39-112"><a href="#cb39-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_func_dist</span>(dat, t_grid, dt)</span>
<span id="cb39-113"><a href="#cb39-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-114"><a href="#cb39-114" aria-hidden="true" tabindex="-1"></a>idC1 <span class="ot">&lt;-</span> best_C<span class="sc">$</span>curve_id.x</span>
<span id="cb39-115"><a href="#cb39-115" aria-hidden="true" tabindex="-1"></a>idC2 <span class="ot">&lt;-</span> best_C<span class="sc">$</span>curve_id.y</span>
<span id="cb39-116"><a href="#cb39-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-117"><a href="#cb39-117" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb39-118"><a href="#cb39-118" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) Panel D: similar AUDPC, large functional distance (exclude used IDs)</span></span>
<span id="cb39-119"><a href="#cb39-119" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb39-120"><a href="#cb39-120" aria-hidden="true" tabindex="-1"></a>used_ids <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">c</span>(idA1, idA2, idB1, idB2, idC1, idC2))</span>
<span id="cb39-121"><a href="#cb39-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-122"><a href="#cb39-122" aria-hidden="true" tabindex="-1"></a>pairsD <span class="ot">&lt;-</span> pairs0 <span class="sc">%&gt;%</span></span>
<span id="cb39-123"><a href="#cb39-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(curve_id.x <span class="sc">%in%</span> used_ids),</span>
<span id="cb39-124"><a href="#cb39-124" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span>(curve_id.y <span class="sc">%in%</span> used_ids))</span>
<span id="cb39-125"><a href="#cb39-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-126"><a href="#cb39-126" aria-hidden="true" tabindex="-1"></a>audpc_q <span class="ot">&lt;-</span> <span class="fl">0.10</span></span>
<span id="cb39-127"><a href="#cb39-127" aria-hidden="true" tabindex="-1"></a>cutD <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pairsD<span class="sc">$</span>audpc_gap, audpc_q, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-128"><a href="#cb39-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-129"><a href="#cb39-129" aria-hidden="true" tabindex="-1"></a>candD <span class="ot">&lt;-</span> pairsD <span class="sc">%&gt;%</span></span>
<span id="cb39-130"><a href="#cb39-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(audpc_gap <span class="sc">&lt;=</span> cutD) <span class="sc">%&gt;%</span></span>
<span id="cb39-131"><a href="#cb39-131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_func_dist</span>(dat, t_grid, dt)</span>
<span id="cb39-132"><a href="#cb39-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-133"><a href="#cb39-133" aria-hidden="true" tabindex="-1"></a><span class="co"># fallback if candD empty</span></span>
<span id="cb39-134"><a href="#cb39-134" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(candD) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb39-135"><a href="#cb39-135" aria-hidden="true" tabindex="-1"></a>  cutD <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pairsD<span class="sc">$</span>audpc_gap, <span class="fl">0.20</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-136"><a href="#cb39-136" aria-hidden="true" tabindex="-1"></a>  candD <span class="ot">&lt;-</span> pairsD <span class="sc">%&gt;%</span></span>
<span id="cb39-137"><a href="#cb39-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(audpc_gap <span class="sc">&lt;=</span> cutD) <span class="sc">%&gt;%</span></span>
<span id="cb39-138"><a href="#cb39-138" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_func_dist</span>(dat, t_grid, dt)</span>
<span id="cb39-139"><a href="#cb39-139" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-140"><a href="#cb39-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-141"><a href="#cb39-141" aria-hidden="true" tabindex="-1"></a>best_D <span class="ot">&lt;-</span> candD <span class="sc">%&gt;%</span></span>
<span id="cb39-142"><a href="#cb39-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(func_dist), audpc_gap) <span class="sc">%&gt;%</span></span>
<span id="cb39-143"><a href="#cb39-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb39-144"><a href="#cb39-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-145"><a href="#cb39-145" aria-hidden="true" tabindex="-1"></a>idD1 <span class="ot">&lt;-</span> best_D<span class="sc">$</span>curve_id.x</span>
<span id="cb39-146"><a href="#cb39-146" aria-hidden="true" tabindex="-1"></a>idD2 <span class="ot">&lt;-</span> best_D<span class="sc">$</span>curve_id.y</span>
<span id="cb39-147"><a href="#cb39-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-148"><a href="#cb39-148" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb39-149"><a href="#cb39-149" aria-hidden="true" tabindex="-1"></a><span class="co"># Outputs you likely want</span></span>
<span id="cb39-150"><a href="#cb39-150" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb39-151"><a href="#cb39-151" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb39-152"><a href="#cb39-152" aria-hidden="true" tabindex="-1"></a>  <span class="at">best_A =</span> best_A,</span>
<span id="cb39-153"><a href="#cb39-153" aria-hidden="true" tabindex="-1"></a>  <span class="at">best_B =</span> best_B,</span>
<span id="cb39-154"><a href="#cb39-154" aria-hidden="true" tabindex="-1"></a>  <span class="at">best_C =</span> best_C,</span>
<span id="cb39-155"><a href="#cb39-155" aria-hidden="true" tabindex="-1"></a>  <span class="at">best_D =</span> best_D,</span>
<span id="cb39-156"><a href="#cb39-156" aria-hidden="true" tabindex="-1"></a>  <span class="at">ids =</span> <span class="fu">list</span>(<span class="at">A =</span> <span class="fu">c</span>(idA1, idA2),</span>
<span id="cb39-157"><a href="#cb39-157" aria-hidden="true" tabindex="-1"></a>             <span class="at">B =</span> <span class="fu">c</span>(idB1, idB2),</span>
<span id="cb39-158"><a href="#cb39-158" aria-hidden="true" tabindex="-1"></a>             <span class="at">C =</span> <span class="fu">c</span>(idC1, idC2),</span>
<span id="cb39-159"><a href="#cb39-159" aria-hidden="true" tabindex="-1"></a>             <span class="at">D =</span> <span class="fu">c</span>(idD1, idD2))</span>
<span id="cb39-160"><a href="#cb39-160" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$best_A
# A tibble: 1 × 14
  curve_id.x          AUDPC.x final_sev.x AUDPC_z.x final_z.x curve_id.y AUDPC.y
  &lt;chr&gt;                 &lt;dbl&gt;       &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;        &lt;dbl&gt;
1 2024_Arapoti_Prefe…    14.9        0.35     0.439   -0.0673 2024_Cast…    15.6
# ℹ 7 more variables: final_sev.y &lt;dbl&gt;, AUDPC_z.y &lt;dbl&gt;, final_z.y &lt;dbl&gt;,
#   scalar_dist &lt;dbl&gt;, audpc_gap &lt;dbl&gt;, final_gap &lt;dbl&gt;, func_dist &lt;dbl&gt;

$best_B
# A tibble: 1 × 14
  curve_id.x          AUDPC.x final_sev.x AUDPC_z.x final_z.x curve_id.y AUDPC.y
  &lt;chr&gt;                 &lt;dbl&gt;       &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;        &lt;dbl&gt;
1 2024_Arapoti_Cedo.…    3.79         0.1     -1.66     -1.80 2024_Itab…    28.1
# ℹ 7 more variables: final_sev.y &lt;dbl&gt;, AUDPC_z.y &lt;dbl&gt;, final_z.y &lt;dbl&gt;,
#   scalar_dist &lt;dbl&gt;, audpc_gap &lt;dbl&gt;, final_gap &lt;dbl&gt;, func_dist &lt;dbl&gt;

$best_C
# A tibble: 1 × 14
  curve_id.x          AUDPC.x final_sev.x AUDPC_z.x final_z.x curve_id.y AUDPC.y
  &lt;chr&gt;                 &lt;dbl&gt;       &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;        &lt;dbl&gt;
1 2024_Arapoti_Prefe…    20.6         0.4      1.53     0.279 2024_Pont…    10.7
# ℹ 7 more variables: final_sev.y &lt;dbl&gt;, AUDPC_z.y &lt;dbl&gt;, final_z.y &lt;dbl&gt;,
#   scalar_dist &lt;dbl&gt;, audpc_gap &lt;dbl&gt;, final_gap &lt;dbl&gt;, func_dist &lt;dbl&gt;

$best_D
# A tibble: 1 × 14
  curve_id.x          AUDPC.x final_sev.x AUDPC_z.x final_z.x curve_id.y AUDPC.y
  &lt;chr&gt;                 &lt;dbl&gt;       &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;        &lt;dbl&gt;
1 2024_Arapoti_Prefe…    11.2        0.25    -0.245    -0.759 2024_Cast…    11.1
# ℹ 7 more variables: final_sev.y &lt;dbl&gt;, AUDPC_z.y &lt;dbl&gt;, final_z.y &lt;dbl&gt;,
#   scalar_dist &lt;dbl&gt;, audpc_gap &lt;dbl&gt;, final_gap &lt;dbl&gt;, func_dist &lt;dbl&gt;

$ids
$ids$A
[1] "2024_Arapoti_Preferencial.AS 1868 PRO4"
[2] "2024_Castro_Preferencial.DKB 230 PRO3" 

$ids$B
[1] "2024_Arapoti_Cedo.P 3016 VYHR"         
[2] "2024_Itabera_Preferencial.AG 8707 PRO4"

$ids$C
[1] "2024_Arapoti_Preferencial.DKB 230 PRO3"   
[2] "2024_Ponta Grossa_Preferencial.T 1503 PWU"

$ids$D
[1] "2024_Arapoti_Preferencial.P 3016 VYHR"
[2] "2024_Castro_Preferencial.MG 616 PWU"  </code></pre>
</div>
</div>
</section>
<section id="plot-the-two-raw-curves" class="level3" data-number="11.2">
<h3 data-number="11.2" class="anchored" data-anchor-id="plot-the-two-raw-curves"><span class="header-section-number">11.2</span> Plot the two raw curves</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot helper (consistent styling)</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>plot_two_curves <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, dfS, id1, id2, panel_title,</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>                            <span class="at">letter =</span> <span class="cn">NULL</span>, <span class="at">t_grid =</span> <span class="cn">NULL</span>, <span class="at">func_dist =</span> <span class="cn">NULL</span>){</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># guards: fail fast with clear message</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(dat, <span class="fu">c</span>(<span class="st">"data.frame"</span>, <span class="st">"tbl_df"</span>, <span class="st">"tbl"</span>))) {</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"`dat` must be a data.frame/tibble. class(dat) = "</span>,</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>         <span class="fu">paste</span>(<span class="fu">class</span>(dat), <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(dfS, <span class="fu">c</span>(<span class="st">"data.frame"</span>, <span class="st">"tbl_df"</span>, <span class="st">"tbl"</span>))) {</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"`dfS` must be a data.frame/tibble. class(dfS) = "</span>,</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>         <span class="fu">paste</span>(<span class="fu">class</span>(dfS), <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>  id1 <span class="ot">&lt;-</span> <span class="fu">as.character</span>(id1)</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>  id2 <span class="ot">&lt;-</span> <span class="fu">as.character</span>(id2)</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>  plot_pair <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">curve_id =</span> <span class="fu">as.character</span>(curve_id)) <span class="sc">%&gt;%</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(curve_id <span class="sc">%in%</span> <span class="fu">c</span>(id1, id2)) <span class="sc">%&gt;%</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">curve =</span> dplyr<span class="sc">::</span><span class="fu">if_else</span>(curve_id <span class="sc">==</span> id1, <span class="st">"A"</span>, <span class="st">"B"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">arrange</span>(curve, DAE)</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(plot_pair) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"No rows found in `dat` for ids: "</span>, id1, <span class="st">" and "</span>, id2)</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>  s1 <span class="ot">&lt;-</span> dfS <span class="sc">%&gt;%</span></span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">curve_id =</span> <span class="fu">as.character</span>(curve_id)) <span class="sc">%&gt;%</span></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(curve_id <span class="sc">==</span> id1)</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>  s2 <span class="ot">&lt;-</span> dfS <span class="sc">%&gt;%</span></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">curve_id =</span> <span class="fu">as.character</span>(curve_id)) <span class="sc">%&gt;%</span></span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(curve_id <span class="sc">==</span> id2)</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(s1) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">nrow</span>(s2) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Missing scalar stats in `dfS` for ids: "</span>, id1, <span class="st">" and/or "</span>, id2)</span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># optional: pull T50 if curve_stats exists</span></span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">exists</span>(<span class="st">"curve_stats"</span>, <span class="at">inherits =</span> <span class="cn">TRUE</span>)){</span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>    t1 <span class="ot">&lt;-</span> curve_stats <span class="sc">%&gt;%</span></span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="fu">as.character</span>(curve_id) <span class="sc">==</span> id1) <span class="sc">%&gt;%</span></span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">pull</span>(T50)</span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a>    t2 <span class="ot">&lt;-</span> curve_stats <span class="sc">%&gt;%</span></span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="fu">as.character</span>(curve_id) <span class="sc">==</span> id2) <span class="sc">%&gt;%</span></span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">pull</span>(T50)</span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># you can append t1/t2 to ann if you want (kept commented)</span></span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute functional distance if requested and not supplied</span></span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(t_grid) <span class="sc">&amp;&amp;</span> <span class="fu">is.null</span>(func_dist)){</span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"interp_curve"</span>, <span class="at">inherits =</span> <span class="cn">TRUE</span>)){</span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"`interp_curve()` not found. Define it before calling plot_two_curves()."</span>)</span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb41-61"><a href="#cb41-61" aria-hidden="true" tabindex="-1"></a>    dt <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">diff</span>(t_grid))</span>
<span id="cb41-62"><a href="#cb41-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># IMPORTANT: consistent argument order: interp_curve(dat, t_grid, id)</span></span>
<span id="cb41-63"><a href="#cb41-63" aria-hidden="true" tabindex="-1"></a>    yA <span class="ot">&lt;-</span> <span class="fu">interp_curve</span>(dat, t_grid, id1)</span>
<span id="cb41-64"><a href="#cb41-64" aria-hidden="true" tabindex="-1"></a>    yB <span class="ot">&lt;-</span> <span class="fu">interp_curve</span>(dat, t_grid, id2)</span>
<span id="cb41-65"><a href="#cb41-65" aria-hidden="true" tabindex="-1"></a>    func_dist <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>((yA <span class="sc">-</span> yB)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> dt)</span>
<span id="cb41-66"><a href="#cb41-66" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb41-67"><a href="#cb41-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-68"><a href="#cb41-68" aria-hidden="true" tabindex="-1"></a>  ann <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb41-69"><a href="#cb41-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AUDPC  A="</span>, <span class="fu">round</span>(s1<span class="sc">$</span>AUDPC[<span class="dv">1</span>], <span class="dv">2</span>), <span class="st">"  B="</span>, <span class="fu">round</span>(s2<span class="sc">$</span>AUDPC[<span class="dv">1</span>], <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb41-70"><a href="#cb41-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Final   A="</span>, <span class="fu">round</span>(s1<span class="sc">$</span>final_sev[<span class="dv">1</span>], <span class="dv">2</span>), <span class="st">"  B="</span>, <span class="fu">round</span>(s2<span class="sc">$</span>final_sev[<span class="dv">1</span>], <span class="dv">2</span>),</span>
<span id="cb41-71"><a href="#cb41-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(func_dist)) <span class="fu">paste0</span>(<span class="st">"</span><span class="sc">\n</span><span class="st"> d_F="</span>, <span class="fu">signif</span>(func_dist, <span class="dv">3</span>)) <span class="cf">else</span> <span class="st">""</span></span>
<span id="cb41-72"><a href="#cb41-72" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb41-73"><a href="#cb41-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-74"><a href="#cb41-74" aria-hidden="true" tabindex="-1"></a>  y_top <span class="ot">&lt;-</span> <span class="fu">max</span>(plot_pair<span class="sc">$</span>y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="fl">1.2</span></span>
<span id="cb41-75"><a href="#cb41-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-76"><a href="#cb41-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(plot_pair, <span class="fu">aes</span>(DAE, y, <span class="at">color =</span> curve)) <span class="sc">+</span></span>
<span id="cb41-77"><a href="#cb41-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.75</span>, <span class="at">size =</span> <span class="fl">1.8</span>) <span class="sc">+</span></span>
<span id="cb41-78"><a href="#cb41-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb41-79"><a href="#cb41-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_grey</span>(<span class="at">start =</span> <span class="fl">0.15</span>, <span class="at">end =</span> <span class="fl">0.65</span>) <span class="sc">+</span></span>
<span id="cb41-80"><a href="#cb41-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"label"</span>,</span>
<span id="cb41-81"><a href="#cb41-81" aria-hidden="true" tabindex="-1"></a>             <span class="at">x =</span> <span class="fu">min</span>(plot_pair<span class="sc">$</span>DAE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> <span class="dv">2</span>,</span>
<span id="cb41-82"><a href="#cb41-82" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> y_top <span class="sc">-</span> <span class="fl">0.1</span>,</span>
<span id="cb41-83"><a href="#cb41-83" aria-hidden="true" tabindex="-1"></a>             <span class="at">label =</span> ann,</span>
<span id="cb41-84"><a href="#cb41-84" aria-hidden="true" tabindex="-1"></a>             <span class="at">hjust =</span> <span class="dv">0</span>,</span>
<span id="cb41-85"><a href="#cb41-85" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="fl">3.2</span>,</span>
<span id="cb41-86"><a href="#cb41-86" aria-hidden="true" tabindex="-1"></a>             <span class="at">label.size =</span> <span class="fl">0.25</span>,</span>
<span id="cb41-87"><a href="#cb41-87" aria-hidden="true" tabindex="-1"></a>             <span class="at">fill =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb41-88"><a href="#cb41-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb41-89"><a href="#cb41-89" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> panel_title,</span>
<span id="cb41-90"><a href="#cb41-90" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Days after emergence (DAE)"</span>,</span>
<span id="cb41-91"><a href="#cb41-91" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Disease severity (proportion)"</span>,</span>
<span id="cb41-92"><a href="#cb41-92" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">"Curve"</span></span>
<span id="cb41-93"><a href="#cb41-93" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb41-94"><a href="#cb41-94" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, y_top)) <span class="sc">+</span></span>
<span id="cb41-95"><a href="#cb41-95" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb41-96"><a href="#cb41-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb41-97"><a href="#cb41-97" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb41-98"><a href="#cb41-98" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb41-99"><a href="#cb41-99" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="dv">6</span>, <span class="dv">6</span>, <span class="dv">6</span>, <span class="dv">6</span>)</span>
<span id="cb41-100"><a href="#cb41-100" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-101"><a href="#cb41-101" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-102"><a href="#cb41-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-103"><a href="#cb41-103" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb41-104"><a href="#cb41-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Build 4 panels</span></span>
<span id="cb41-105"><a href="#cb41-105" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb41-106"><a href="#cb41-106" aria-hidden="true" tabindex="-1"></a>pD <span class="ot">&lt;-</span> <span class="fu">plot_two_curves</span>(dat, dfS, idA1, idA2,</span>
<span id="cb41-107"><a href="#cb41-107" aria-hidden="true" tabindex="-1"></a>                      <span class="at">panel_title =</span> <span class="st">"Similar AUPDC &amp; final Severity, trajectory-distinct"</span>,</span>
<span id="cb41-108"><a href="#cb41-108" aria-hidden="true" tabindex="-1"></a>                      <span class="at">t_grid =</span> t_grid)</span>
<span id="cb41-109"><a href="#cb41-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-110"><a href="#cb41-110" aria-hidden="true" tabindex="-1"></a>pA <span class="ot">&lt;-</span> <span class="fu">plot_two_curves</span>(dat, dfS, idB1, idB2,</span>
<span id="cb41-111"><a href="#cb41-111" aria-hidden="true" tabindex="-1"></a>                      <span class="at">panel_title =</span> <span class="st">"AUDPC discriminates epidemics"</span>,</span>
<span id="cb41-112"><a href="#cb41-112" aria-hidden="true" tabindex="-1"></a>                      <span class="at">t_grid =</span> t_grid,</span>
<span id="cb41-113"><a href="#cb41-113" aria-hidden="true" tabindex="-1"></a>                      <span class="at">func_dist =</span> best_B<span class="sc">$</span>func_dist)</span>
<span id="cb41-114"><a href="#cb41-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-115"><a href="#cb41-115" aria-hidden="true" tabindex="-1"></a>pB <span class="ot">&lt;-</span> <span class="fu">plot_two_curves</span>(dat, dfS, idC1, idC2,</span>
<span id="cb41-116"><a href="#cb41-116" aria-hidden="true" tabindex="-1"></a>                      <span class="at">panel_title =</span> <span class="st">"Same final severity, different AUDPC"</span>,</span>
<span id="cb41-117"><a href="#cb41-117" aria-hidden="true" tabindex="-1"></a>                      <span class="at">t_grid =</span> t_grid,</span>
<span id="cb41-118"><a href="#cb41-118" aria-hidden="true" tabindex="-1"></a>                      <span class="at">func_dist =</span> best_C<span class="sc">$</span>func_dist)</span>
<span id="cb41-119"><a href="#cb41-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-120"><a href="#cb41-120" aria-hidden="true" tabindex="-1"></a>pC <span class="ot">&lt;-</span> <span class="fu">plot_two_curves</span>(dat, dfS, idD1, idD2,</span>
<span id="cb41-121"><a href="#cb41-121" aria-hidden="true" tabindex="-1"></a>                      <span class="at">panel_title =</span> <span class="st">"Similar AUDPC, trajectory-distinct"</span>,</span>
<span id="cb41-122"><a href="#cb41-122" aria-hidden="true" tabindex="-1"></a>                      <span class="at">t_grid =</span> t_grid,</span>
<span id="cb41-123"><a href="#cb41-123" aria-hidden="true" tabindex="-1"></a>                      <span class="at">func_dist =</span> best_D<span class="sc">$</span>func_dist)</span>
<span id="cb41-124"><a href="#cb41-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-125"><a href="#cb41-125" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb41-126"><a href="#cb41-126" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine into 2x2 and tag A–D</span></span>
<span id="cb41-127"><a href="#cb41-127" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb41-128"><a href="#cb41-128" aria-hidden="true" tabindex="-1"></a>fig1_panel <span class="ot">&lt;-</span> (pA <span class="sc">|</span> pB) <span class="sc">/</span> (pC <span class="sc">|</span> pD) <span class="sc">+</span></span>
<span id="cb41-129"><a href="#cb41-129" aria-hidden="true" tabindex="-1"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(<span class="at">tag_levels =</span> <span class="st">"A"</span>) <span class="sc">+</span></span>
<span id="cb41-130"><a href="#cb41-130" aria-hidden="true" tabindex="-1"></a>  patchwork<span class="sc">::</span><span class="fu">plot_layout</span>(<span class="at">guides =</span> <span class="st">"collect"</span>) <span class="sc">&amp;</span></span>
<span id="cb41-131"><a href="#cb41-131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb41-132"><a href="#cb41-132" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb41-133"><a href="#cb41-133" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.direction =</span> <span class="st">"horizontal"</span></span>
<span id="cb41-134"><a href="#cb41-134" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb41-135"><a href="#cb41-135" aria-hidden="true" tabindex="-1"></a>fig1_panel</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/killer-plot-raw-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">"Fig1.png"</span>, <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="traditional-audpc-analysis-mixed-model-tukey" class="level2" data-number="12">
<h2 data-number="12" class="anchored" data-anchor-id="traditional-audpc-analysis-mixed-model-tukey"><span class="header-section-number">12</span> Traditional AUDPC analysis (mixed model + Tukey)</h2>
<div class="sourceCode" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>audpc_df <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Ambiente, Hibrido) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">AUDPC =</span> ..., <span class="at">.groups=</span><span class="st">"drop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is appropriate if (a) <code>Parcela</code> is not a true replication factor, or (b) you intentionally aggregate within environment. If you do have plot-level replication and want plot-level inference, compute AUDPC by <code>Ambiente × Hibrido × Parcela</code> and fit a corresponding mixed model.</p>
<section id="compute-audpc-and-fit-model" class="level3" data-number="12.1">
<h3 data-number="12.1" class="anchored" data-anchor-id="compute-audpc-and-fit-model"><span class="header-section-number">12.1</span> Compute AUDPC and fit model</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>audpc_df <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ambiente, Hibrido) <span class="sc">%&gt;%</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">AUDPC =</span> pracma<span class="sc">::</span><span class="fu">trapz</span>(DAE, y), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>audpc_df2 <span class="ot">&lt;-</span> audpc_df <span class="sc">%&gt;%</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ambiente =</span> <span class="fu">factor</span>(Ambiente),</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Hibrido  =</span> <span class="fu">factor</span>(Hibrido),</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">AUDPC    =</span> <span class="fu">as.numeric</span>(AUDPC)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(AUDPC))</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Mixed model: random intercept for Ambiente (as in your earlier block)</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>m_audpc <span class="ot">&lt;-</span> <span class="fu">lmer</span>(AUDPC <span class="sc">~</span> Hibrido <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> Ambiente), <span class="at">data =</span> audpc_df2)</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(m_audpc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Type III Analysis of Variance Table with Satterthwaite's method
        Sum Sq Mean Sq NumDF  DenDF F value    Pr(&gt;F)    
Hibrido 684.75  57.063    12 55.991  5.5711 3.681e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
</section>
<section id="model-checks-dharma" class="level3" data-number="12.2">
<h3 data-number="12.2" class="anchored" data-anchor-id="model-checks-dharma"><span class="header-section-number">12.2</span> Model checks (DHARMa)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>res_a <span class="ot">&lt;-</span> <span class="fu">simulateResiduals</span>(m_audpc, <span class="at">n =</span> <span class="dv">2000</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(res_a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/audpc-diagnostics-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">testUniformity</span>(res_a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/audpc-diagnostics-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Asymptotic one-sample Kolmogorov-Smirnov test

data:  simulationOutput$scaledResiduals
D = 0.067351, p-value = 0.8904
alternative hypothesis: two-sided</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">testDispersion</span>(res_a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/audpc-diagnostics-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    DHARMa nonparametric dispersion test via sd of residuals fitted vs.
    simulated

data:  simulationOutput
dispersion = 0.90491, p-value = 0.962
alternative hypothesis: two.sided</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">testOutliers</span>(res_a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/audpc-diagnostics-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    DHARMa outlier test based on exact binomial test with approximate
    expectations

data:  res_a
outliers at both margin(s) = 0, observations = 74, p-value = 1
alternative hypothesis: true probability of success is not equal to 0.0009995002
95 percent confidence interval:
 0.00000000 0.04862762
sample estimates:
frequency of outliers (expected: 0.000999500249875062 ) 
                                                      0 </code></pre>
</div>
</div>
</section>
<section id="hybrid-means-tukey-letters" class="level3" data-number="12.3">
<h3 data-number="12.3" class="anchored" data-anchor-id="hybrid-means-tukey-letters"><span class="header-section-number">12.3</span> Hybrid means + Tukey letters</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>emm_h <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(m_audpc, <span class="sc">~</span> Hibrido)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>cld_res <span class="ot">&lt;-</span> multcomp<span class="sc">::</span><span class="fu">cld</span>(</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  emm_h,</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Letters =</span> letters,</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">adjust  =</span> <span class="st">"tukey"</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>audpc_groups <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(cld_res) <span class="sc">%&gt;%</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    Hibrido,</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>    emmean,</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>    SE,</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>    df,</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    lower.CL,</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    upper.CL,</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">.group =</span> stringr<span class="sc">::</span><span class="fu">str_squish</span>(.group)</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(emmean)</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>audpc_groups</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Hibrido    emmean       SE       df   lower.CL upper.CL .group
1   P 3016 VYHR  8.078767 2.001389 13.00413  1.0806978 15.07684      a
2        CRWX03  8.124162 2.221715 18.63419  0.8172663 15.43106     ab
3    MG 616 PWU  9.714700 2.001389 13.00413  2.7166311 16.71277     ab
4    T 1503 PWU  9.967308 2.001389 13.00413  2.9692394 16.96538     ab
5  AS 1868 PRO4 10.275675 2.001389 13.00413  3.2776061 17.27374     ab
6    B 2801 PWU 11.039174 2.221715 18.63419  3.7322788 18.34607   abcd
7  AG 8701 PRO4 11.048208 2.001389 13.00413  4.0501394 18.04628    abc
8  AG 9021 PRO3 12.287733 2.001389 13.00413  5.2896644 19.28580   abcd
9  DKB 230 PRO3 13.911767 2.001389 13.00413  6.9136978 20.90984   abcd
10 DKB 242 PRO4 14.184983 2.001389 13.00413  7.1869144 21.18305   abcd
11 AS 1955 PRO4 15.084983 2.001389 13.00413  8.0869144 22.08305    bcd
12 AS 1757 PRO4 17.016708 2.001389 13.00413 10.0186394 24.01478     cd
13 AG 8707 PRO4 17.799042 2.001389 13.00413 10.8009728 24.79711      d</code></pre>
</div>
</div>
</section>
<section id="merge-tukey-groups-with-functional-clusters" class="level3" data-number="12.4">
<h3 data-number="12.4" class="anchored" data-anchor-id="merge-tukey-groups-with-functional-clusters"><span class="header-section-number">12.4</span> Merge Tukey groups with functional clusters</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>final_compare <span class="ot">&lt;-</span> audpc_groups <span class="sc">%&gt;%</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    cluster_table2 <span class="sc">%&gt;%</span> <span class="fu">select</span>(Hibrido, cluster, phenotype),</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"Hibrido"</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(emmean)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>final_compare</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Hibrido    emmean       SE       df   lower.CL upper.CL .group cluster
1   P 3016 VYHR  8.078767 2.001389 13.00413  1.0806978 15.07684      a       1
2        CRWX03  8.124162 2.221715 18.63419  0.8172663 15.43106     ab       1
3    MG 616 PWU  9.714700 2.001389 13.00413  2.7166311 16.71277     ab       2
4    T 1503 PWU  9.967308 2.001389 13.00413  2.9692394 16.96538     ab       2
5  AS 1868 PRO4 10.275675 2.001389 13.00413  3.2776061 17.27374     ab       2
6    B 2801 PWU 11.039174 2.221715 18.63419  3.7322788 18.34607   abcd       2
7  AG 8701 PRO4 11.048208 2.001389 13.00413  4.0501394 18.04628    abc       2
8  AG 9021 PRO3 12.287733 2.001389 13.00413  5.2896644 19.28580   abcd       2
9  DKB 230 PRO3 13.911767 2.001389 13.00413  6.9136978 20.90984   abcd       2
10 DKB 242 PRO4 14.184983 2.001389 13.00413  7.1869144 21.18305   abcd       3
11 AS 1955 PRO4 15.084983 2.001389 13.00413  8.0869144 22.08305    bcd       3
12 AS 1757 PRO4 17.016708 2.001389 13.00413 10.0186394 24.01478     cd       4
13 AG 8707 PRO4 17.799042 2.001389 13.00413 10.8009728 24.79711      d       4
   phenotype
1         P1
2         P1
3         P2
4         P2
5         P2
6         P2
7         P2
8         P2
9         P2
10        P3
11        P3
12        P4
13        P4</code></pre>
</div>
</div>
</section>
<section id="plot-audpc-means-ci-tukey-letters-colored-by-functional-phenotype" class="level3" data-number="12.5">
<h3 data-number="12.5" class="anchored" data-anchor-id="plot-audpc-means-ci-tukey-letters-colored-by-functional-phenotype"><span class="header-section-number">12.5</span> Plot: AUDPC means, CI, Tukey letters (colored by functional phenotype)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> final_compare <span class="sc">%&gt;%</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">hybrid_short =</span> <span class="fu">shorten_hybrid</span>(Hibrido),</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">cluster =</span> <span class="fu">factor</span>(cluster)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#D55E00"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#009E73"</span>, <span class="st">"#CC79A7"</span>)[<span class="dv">1</span><span class="sc">:</span>k_clusters]</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_df,</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">reorder</span>(hybrid_short, emmean),</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> emmean,</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> cluster)) <span class="sc">+</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> cols) <span class="sc">+</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> lower.CL, <span class="at">xmax =</span> upper.CL), <span class="at">height =</span> <span class="fl">0.12</span>) <span class="sc">+</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> .group), <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"AUDPC"</span>,</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Hybrid"</span>,</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Functional phenotype"</span>,</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="cn">NULL</span></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="fu">min</span>(plot_df<span class="sc">$</span>lower.CL), <span class="fu">max</span>(plot_df<span class="sc">$</span>upper.CL) <span class="sc">*</span> <span class="fl">1.10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/audpc-plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="optional-run-compare_curves-from-r4pde" class="level2" data-number="13">
<h2 data-number="13" class="anchored" data-anchor-id="optional-run-compare_curves-from-r4pde"><span class="header-section-number">13</span> Optional: run <code>compare_curves()</code> from <code>{r4pde}</code></h2>
<p>This section reproduces your final call, assuming <code>{r4pde}</code> is installed and your <code>dat</code> object matches the required schema.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co">#pak::pkg_install("emdelponte/r4pde")</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(r4pde)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">compare_curves</span>(</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat,</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">time =</span> <span class="st">"DAE"</span>,</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">response =</span> <span class="st">"y"</span>,</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment =</span> <span class="st">"Hibrido"</span>,</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">environment =</span> <span class="st">"Ambiente"</span>,</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">test_factor =</span> <span class="st">"resistance"</span>,</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">perm_unit =</span> <span class="st">"Hibrido"</span>,</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">perm_strata =</span> <span class="st">"Ambiente"</span>,</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">test_mode =</span> <span class="st">"global"</span>,</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">bootstrap =</span> <span class="cn">TRUE</span>,</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">boot_B =</span> <span class="dv">399</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>m1</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m1)</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_curves</span>(m1)</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_dendrogram</span>(m1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="session-info" class="level2" data-number="14">
<h2 data-number="14" class="anchored" data-anchor-id="session-info"><span class="header-section-number">14</span> Session info</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.5.2 (2025-10-31 ucrt)
Platform: x86_64-w64-mingw32/x64
Running under: Windows 11 x64 (build 26100)

Matrix products: default
  LAPACK version 3.12.1

locale:
[1] LC_COLLATE=English_United States.utf8 
[2] LC_CTYPE=English_United States.utf8   
[3] LC_MONETARY=English_United States.utf8
[4] LC_NUMERIC=C                          
[5] LC_TIME=English_United States.utf8    

time zone: America/Sao_Paulo
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] lubridate_1.9.4     forcats_1.0.0       tidyverse_2.0.0    
 [4] glue_1.8.0          stringr_1.6.0       DHARMa_0.4.7       
 [7] patchwork_1.3.1     ggdendro_0.2.0      ggrepel_0.9.6      
[10] cowplot_1.2.0       multcompView_0.1-10 emmeans_2.0.1      
[13] lmerTest_3.1-3      lme4_1.1-38         Matrix_1.7-4       
[16] pheatmap_1.0.13     pracma_2.4.6        mgcv_1.9-3         
[19] nlme_3.1-168        ggplot2_3.5.2       purrr_1.0.4        
[22] tibble_3.3.0        tidyr_1.3.1         dplyr_1.1.4        
[25] readr_2.1.5        

loaded via a namespace (and not attached):
 [1] Rdpack_2.6.5        sandwich_3.1-1      rlang_1.1.7        
 [4] magrittr_2.0.3      multcomp_1.4-29     compiler_4.5.2     
 [7] systemfonts_1.3.1   vctrs_0.7.1.9000    pkgconfig_2.0.3    
[10] crayon_1.5.3        fastmap_1.2.0       backports_1.5.0    
[13] labeling_0.4.3      utf8_1.2.6          promises_1.3.3     
[16] rmarkdown_2.29      tzdb_0.5.0          nloptr_2.2.1       
[19] ragg_1.4.0          bit_4.6.0           xfun_0.52          
[22] jsonlite_2.0.0      later_1.4.2         broom_1.0.12       
[25] parallel_4.5.2      R6_2.6.1            gap.datasets_0.0.6 
[28] stringi_1.8.7       qgam_2.0.0          RColorBrewer_1.1-3 
[31] boot_1.3-32         numDeriv_2016.8-1.1 estimability_1.5.1 
[34] Rcpp_1.1.1          iterators_1.0.14    knitr_1.50         
[37] zoo_1.8-15          httpuv_1.6.16       splines_4.5.2      
[40] timechange_0.3.0    tidyselect_1.2.1    rstudioapi_0.17.1  
[43] dichromat_2.0-0.1   yaml_2.3.10         doParallel_1.0.17  
[46] codetools_0.2-20    lattice_0.22-7      plyr_1.8.9         
[49] shiny_1.11.1        withr_3.0.2         coda_0.19-4.1      
[52] evaluate_1.0.5      survival_3.8-3      pillar_1.11.1      
[55] gap_1.6             foreach_1.5.2       reformulas_0.4.4   
[58] generics_0.1.4      vroom_1.6.5         hms_1.1.4          
[61] scales_1.4.0        minqa_1.2.8         xtable_1.8-4       
[64] tools_4.5.2         mvtnorm_1.3-3       grid_4.5.2         
[67] rbibutils_2.4.1     cli_3.6.5           textshaping_1.0.1  
[70] gtable_0.3.6        digest_0.6.37       pbkrtest_0.5.5     
[73] TH.data_1.1-5       htmlwidgets_1.6.4   farver_2.1.2       
[76] htmltools_0.5.8.1   lifecycle_1.0.5     mime_0.13          
[79] bit64_4.6.0-1       MASS_7.3-65        </code></pre>
</div>
</div>
<!-- -->

</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb61" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Curve-based + traditional analysis of Bipolaris epidemics"</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Functional (beta-GAM/HGAM) smoothing, functional distances, and AUDPC mixed-model comparison"</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Emerson M. Del Ponte"</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="an">theme:</span><span class="co"> flatly</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>This document implements two complementary analyses for Bipolaris leaf spot epidemics assessed in maize hybrids:</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>**A. Functional (curve-based) analysis**</span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Beta-GAM (HGAM)** to smooth severity trajectories and adjust for environment.</span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Environment-adjusted hybrid mean curves**.</span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Functional distance** among hybrids and **hierarchical clustering** (dendrogram + curve panel).</span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>*“Killer pair” figure:* two curves that are **scalar-equivalent** (AUDPC + final severity) but **trajectory-distinct**, with the difference function $\Delta(t)$ and its contribution to the $L^2$ distance.</span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>**B. Traditional (scalar) analysis**</span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**AUDPC** per hybrid within environment (as available in the dataset design).</span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Mixed-model ANOVA and **Tukey** letter groups (via <span class="in">`emmeans::cld()`</span>).</span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Merge **Tukey groups** with **functional clusters** for side-by-side comparison.</span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-40"><a href="#cb61-40" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data and design</span></span>
<span id="cb61-41"><a href="#cb61-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-42"><a href="#cb61-42" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Input file:** <span class="in">`maize_bipolaris.csv`</span></span>
<span id="cb61-43"><a href="#cb61-43" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Response:** Bipolaris severity (%) converted to proportion</span>
<span id="cb61-44"><a href="#cb61-44" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Time scale:** DAE (days after emergence)</span>
<span id="cb61-45"><a href="#cb61-45" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Design columns:** <span class="in">`Ambiente`</span> (environment), <span class="in">`Hibrido`</span> (hybrid), <span class="in">`Parcela`</span> (plot/block)</span>
<span id="cb61-46"><a href="#cb61-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-47"><a href="#cb61-47" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb61-48"><a href="#cb61-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-49"><a href="#cb61-49" aria-hidden="true" tabindex="-1"></a><span class="fu">## Methods (equations)</span></span>
<span id="cb61-50"><a href="#cb61-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-51"><a href="#cb61-51" aria-hidden="true" tabindex="-1"></a><span class="fu">### Response scale and beta regression constraints</span></span>
<span id="cb61-52"><a href="#cb61-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-53"><a href="#cb61-53" aria-hidden="true" tabindex="-1"></a>The raw severity in percent is converted to a proportion:</span>
<span id="cb61-54"><a href="#cb61-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-55"><a href="#cb61-55" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-56"><a href="#cb61-56" aria-hidden="true" tabindex="-1"></a>y = \frac{\text{severity (\%)}}{100}.</span>
<span id="cb61-57"><a href="#cb61-57" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-58"><a href="#cb61-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-59"><a href="#cb61-59" aria-hidden="true" tabindex="-1"></a>Beta regression requires $0 &lt; y &lt; 1$, so we apply a small boundary adjustment:</span>
<span id="cb61-60"><a href="#cb61-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-61"><a href="#cb61-61" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-62"><a href="#cb61-62" aria-hidden="true" tabindex="-1"></a>y^* = \min\left(\max(y, \varepsilon), 1-\varepsilon\right).</span>
<span id="cb61-63"><a href="#cb61-63" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-64"><a href="#cb61-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-65"><a href="#cb61-65" aria-hidden="true" tabindex="-1"></a><span class="fu">### AUDPC</span></span>
<span id="cb61-66"><a href="#cb61-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-67"><a href="#cb61-67" aria-hidden="true" tabindex="-1"></a>AUDPC is approximated using the trapezoidal rule for a curve $y(t)$ observed at times $t_1 &lt; \dots &lt; t_m$:</span>
<span id="cb61-68"><a href="#cb61-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-69"><a href="#cb61-69" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-70"><a href="#cb61-70" aria-hidden="true" tabindex="-1"></a>\mathrm{AUDPC} \approx \sum_{i=1}^{m-1} \frac{(y_i + y_{i+1})}{2}\,(t_{i+1}-t_i).</span>
<span id="cb61-71"><a href="#cb61-71" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-72"><a href="#cb61-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-73"><a href="#cb61-73" aria-hidden="true" tabindex="-1"></a><span class="fu">### $T_{50}$</span></span>
<span id="cb61-74"><a href="#cb61-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-75"><a href="#cb61-75" aria-hidden="true" tabindex="-1"></a>$T_{50}$ is computed as the time when the curve reaches half its observed maximum:</span>
<span id="cb61-76"><a href="#cb61-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-77"><a href="#cb61-77" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-78"><a href="#cb61-78" aria-hidden="true" tabindex="-1"></a>T_{50}=\min<span class="sc">\{</span>t:\; y(t)\ge 0.5\,y_{\max}<span class="sc">\}</span>,</span>
<span id="cb61-79"><a href="#cb61-79" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-80"><a href="#cb61-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-81"><a href="#cb61-81" aria-hidden="true" tabindex="-1"></a>estimated by linear interpolation between adjacent observation times.</span>
<span id="cb61-82"><a href="#cb61-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-83"><a href="#cb61-83" aria-hidden="true" tabindex="-1"></a><span class="fu">### Logistic rate (optional scalar)</span></span>
<span id="cb61-84"><a href="#cb61-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-85"><a href="#cb61-85" aria-hidden="true" tabindex="-1"></a>We fit a logistic curve to each epidemic trajectory:</span>
<span id="cb61-86"><a href="#cb61-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-87"><a href="#cb61-87" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-88"><a href="#cb61-88" aria-hidden="true" tabindex="-1"></a>y(t)=\frac{K}{1 + \exp<span class="sc">\{</span>-r(t-t_0)<span class="sc">\}</span>},</span>
<span id="cb61-89"><a href="#cb61-89" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-90"><a href="#cb61-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-91"><a href="#cb61-91" aria-hidden="true" tabindex="-1"></a>and report a duration-normalized rate:</span>
<span id="cb61-92"><a href="#cb61-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-93"><a href="#cb61-93" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-94"><a href="#cb61-94" aria-hidden="true" tabindex="-1"></a>r_{\mathrm{norm}} = r\,(t_{\max}-t_{\min}).</span>
<span id="cb61-95"><a href="#cb61-95" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-96"><a href="#cb61-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-97"><a href="#cb61-97" aria-hidden="true" tabindex="-1"></a><span class="fu">### Functional distance between curves</span></span>
<span id="cb61-98"><a href="#cb61-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-99"><a href="#cb61-99" aria-hidden="true" tabindex="-1"></a>For two smooth mean curves $\mu_a(t)$ and $\mu_b(t)$, the $L^2$ distance is:</span>
<span id="cb61-100"><a href="#cb61-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-101"><a href="#cb61-101" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-102"><a href="#cb61-102" aria-hidden="true" tabindex="-1"></a>d_F(a,b) = \left(\int \big<span class="co">[</span><span class="ot">\mu_a(t)-\mu_b(t)\big</span><span class="co">]</span>^2\,dt\right)^{1/2}.</span>
<span id="cb61-103"><a href="#cb61-103" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-104"><a href="#cb61-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-105"><a href="#cb61-105" aria-hidden="true" tabindex="-1"></a>On an evenly spaced grid with step $\Delta t$, we approximate:</span>
<span id="cb61-106"><a href="#cb61-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-107"><a href="#cb61-107" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-108"><a href="#cb61-108" aria-hidden="true" tabindex="-1"></a>d_F(a,b)\approx \left(\sum_{j} <span class="co">[</span><span class="ot">\mu_a(t_j)-\mu_b(t_j)</span><span class="co">]</span>^2\,\Delta t\right)^{1/2}.</span>
<span id="cb61-109"><a href="#cb61-109" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb61-110"><a href="#cb61-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-111"><a href="#cb61-111" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb61-112"><a href="#cb61-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-113"><a href="#cb61-113" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setup</span></span>
<span id="cb61-114"><a href="#cb61-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-115"><a href="#cb61-115" aria-hidden="true" tabindex="-1"></a><span class="fu">### Packages</span></span>
<span id="cb61-116"><a href="#cb61-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-119"><a href="#cb61-119" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-120"><a href="#cb61-120" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup-packages</span></span>
<span id="cb61-121"><a href="#cb61-121" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb61-122"><a href="#cb61-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-123"><a href="#cb61-123" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb61-124"><a href="#cb61-124" aria-hidden="true" tabindex="-1"></a>  <span class="st">"readr"</span>,<span class="st">"dplyr"</span>,<span class="st">"tidyr"</span>,<span class="st">"tibble"</span>,<span class="st">"purrr"</span>,</span>
<span id="cb61-125"><a href="#cb61-125" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ggplot2"</span>,<span class="st">"mgcv"</span>,<span class="st">"pracma"</span>,<span class="st">"pheatmap"</span>,</span>
<span id="cb61-126"><a href="#cb61-126" aria-hidden="true" tabindex="-1"></a>  <span class="st">"lme4"</span>,<span class="st">"lmerTest"</span>,<span class="st">"emmeans"</span>,<span class="st">"multcompView"</span>,</span>
<span id="cb61-127"><a href="#cb61-127" aria-hidden="true" tabindex="-1"></a>  <span class="st">"cowplot"</span>,<span class="st">"ggrepel"</span>,<span class="st">"ggdendro"</span>,<span class="st">"patchwork"</span>,</span>
<span id="cb61-128"><a href="#cb61-128" aria-hidden="true" tabindex="-1"></a>  <span class="st">"DHARMa"</span>,<span class="st">"stringr"</span>,<span class="st">"glue"</span></span>
<span id="cb61-129"><a href="#cb61-129" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-130"><a href="#cb61-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-131"><a href="#cb61-131" aria-hidden="true" tabindex="-1"></a>to_install <span class="ot">&lt;-</span> pkgs[<span class="sc">!</span>pkgs <span class="sc">%in%</span> <span class="fu">rownames</span>(<span class="fu">installed.packages</span>())]</span>
<span id="cb61-132"><a href="#cb61-132" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(to_install) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">install.packages</span>(to_install, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb61-133"><a href="#cb61-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-134"><a href="#cb61-134" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb61-135"><a href="#cb61-135" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb61-136"><a href="#cb61-136" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb61-137"><a href="#cb61-137" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb61-138"><a href="#cb61-138" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb61-139"><a href="#cb61-139" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb61-140"><a href="#cb61-140" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb61-141"><a href="#cb61-141" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pracma)</span>
<span id="cb61-142"><a href="#cb61-142" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pheatmap)</span>
<span id="cb61-143"><a href="#cb61-143" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb61-144"><a href="#cb61-144" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmerTest)</span>
<span id="cb61-145"><a href="#cb61-145" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emmeans)</span>
<span id="cb61-146"><a href="#cb61-146" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(multcompView)</span>
<span id="cb61-147"><a href="#cb61-147" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb61-148"><a href="#cb61-148" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggrepel)</span>
<span id="cb61-149"><a href="#cb61-149" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggdendro)</span>
<span id="cb61-150"><a href="#cb61-150" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb61-151"><a href="#cb61-151" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DHARMa)</span>
<span id="cb61-152"><a href="#cb61-152" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb61-153"><a href="#cb61-153" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb61-154"><a href="#cb61-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-155"><a href="#cb61-155" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_classic</span>(<span class="at">base_size =</span> <span class="dv">14</span>))</span>
<span id="cb61-156"><a href="#cb61-156" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-157"><a href="#cb61-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-158"><a href="#cb61-158" aria-hidden="true" tabindex="-1"></a><span class="fu">### User settings</span></span>
<span id="cb61-159"><a href="#cb61-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-162"><a href="#cb61-162" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-163"><a href="#cb61-163" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup-settings</span></span>
<span id="cb61-164"><a href="#cb61-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-165"><a href="#cb61-165" aria-hidden="true" tabindex="-1"></a>file_path  <span class="ot">&lt;-</span> <span class="st">"maize_bipolaris.csv"</span></span>
<span id="cb61-166"><a href="#cb61-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-167"><a href="#cb61-167" aria-hidden="true" tabindex="-1"></a><span class="co"># Data window (as in your script)</span></span>
<span id="cb61-168"><a href="#cb61-168" aria-hidden="true" tabindex="-1"></a>dae_min <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb61-169"><a href="#cb61-169" aria-hidden="true" tabindex="-1"></a>dae_max <span class="ot">&lt;-</span> <span class="dv">116</span></span>
<span id="cb61-170"><a href="#cb61-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-171"><a href="#cb61-171" aria-hidden="true" tabindex="-1"></a><span class="co"># Minimum number of assessments per curve_id to retain</span></span>
<span id="cb61-172"><a href="#cb61-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-173"><a href="#cb61-173" aria-hidden="true" tabindex="-1"></a>min_assess <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb61-174"><a href="#cb61-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-175"><a href="#cb61-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Beta boundary adjustment</span></span>
<span id="cb61-176"><a href="#cb61-176" aria-hidden="true" tabindex="-1"></a>eps <span class="ot">&lt;-</span> <span class="fl">1e-4</span></span>
<span id="cb61-177"><a href="#cb61-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-178"><a href="#cb61-178" aria-hidden="true" tabindex="-1"></a><span class="co"># Functional clustering</span></span>
<span id="cb61-179"><a href="#cb61-179" aria-hidden="true" tabindex="-1"></a>k_clusters <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb61-180"><a href="#cb61-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-181"><a href="#cb61-181" aria-hidden="true" tabindex="-1"></a><span class="co"># Time grid for functional distances / plots</span></span>
<span id="cb61-182"><a href="#cb61-182" aria-hidden="true" tabindex="-1"></a>grid_n <span class="ot">&lt;-</span> <span class="dv">140</span></span>
<span id="cb61-183"><a href="#cb61-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-184"><a href="#cb61-184" aria-hidden="true" tabindex="-1"></a><span class="co"># Reference environment used for "environment-adjusted" mean curves</span></span>
<span id="cb61-185"><a href="#cb61-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-186"><a href="#cb61-186" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-187"><a href="#cb61-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-188"><a href="#cb61-188" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb61-189"><a href="#cb61-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-190"><a href="#cb61-190" aria-hidden="true" tabindex="-1"></a><span class="fu">## Read and prepare data</span></span>
<span id="cb61-191"><a href="#cb61-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-194"><a href="#cb61-194" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-195"><a href="#cb61-195" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: data-read</span></span>
<span id="cb61-196"><a href="#cb61-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-197"><a href="#cb61-197" aria-hidden="true" tabindex="-1"></a>dat0 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb61-198"><a href="#cb61-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-199"><a href="#cb61-199" aria-hidden="true" tabindex="-1"></a>dat0 <span class="ot">&lt;-</span> dat0 <span class="sc">|&gt;</span></span>
<span id="cb61-200"><a href="#cb61-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(DAE <span class="sc">&lt;</span> dae_max, DAE <span class="sc">&gt;</span> dae_min)</span>
<span id="cb61-201"><a href="#cb61-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-202"><a href="#cb61-202" aria-hidden="true" tabindex="-1"></a><span class="co"># Expected columns: Ambiente, Hibrido, Parcela, DAE, Bipolaris</span></span>
<span id="cb61-203"><a href="#cb61-203" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat0 <span class="sc">%&gt;%</span></span>
<span id="cb61-204"><a href="#cb61-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb61-205"><a href="#cb61-205" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ambiente  =</span> <span class="fu">factor</span>(Ambiente),</span>
<span id="cb61-206"><a href="#cb61-206" aria-hidden="true" tabindex="-1"></a>    <span class="at">Hibrido   =</span> <span class="fu">factor</span>(Hibrido),</span>
<span id="cb61-207"><a href="#cb61-207" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-208"><a href="#cb61-208" aria-hidden="true" tabindex="-1"></a>    <span class="at">DAE       =</span> <span class="fu">as.numeric</span>(DAE),</span>
<span id="cb61-209"><a href="#cb61-209" aria-hidden="true" tabindex="-1"></a>    <span class="at">bipolaris =</span> <span class="fu">as.numeric</span>(Bipolaris) <span class="sc">/</span> <span class="dv">100</span>  <span class="co"># % -&gt; proportion</span></span>
<span id="cb61-210"><a href="#cb61-210" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb61-211"><a href="#cb61-211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Ambiente), <span class="sc">!</span><span class="fu">is.na</span>(Hibrido), </span>
<span id="cb61-212"><a href="#cb61-212" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span><span class="fu">is.na</span>(DAE), <span class="sc">!</span><span class="fu">is.na</span>(bipolaris)) <span class="sc">%&gt;%</span></span>
<span id="cb61-213"><a href="#cb61-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb61-214"><a href="#cb61-214" aria-hidden="true" tabindex="-1"></a>    <span class="at">curve_id =</span> <span class="fu">interaction</span>(Ambiente, Hibrido), <span class="at">drop =</span> <span class="cn">TRUE</span>, <span class="at">sep =</span> <span class="st">"|"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-215"><a href="#cb61-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(curve_id, DAE)</span>
<span id="cb61-216"><a href="#cb61-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-217"><a href="#cb61-217" aria-hidden="true" tabindex="-1"></a><span class="co"># Retain curves with at least min_assess time points</span></span>
<span id="cb61-218"><a href="#cb61-218" aria-hidden="true" tabindex="-1"></a>curve_n <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">count</span>(curve_id, <span class="at">name =</span> <span class="st">"n_assess"</span>)</span>
<span id="cb61-219"><a href="#cb61-219" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb61-220"><a href="#cb61-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(curve_n, <span class="at">by =</span> <span class="st">"curve_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-221"><a href="#cb61-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_assess <span class="sc">&gt;=</span> min_assess) <span class="sc">%&gt;%</span></span>
<span id="cb61-222"><a href="#cb61-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>n_assess)</span>
<span id="cb61-223"><a href="#cb61-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-224"><a href="#cb61-224" aria-hidden="true" tabindex="-1"></a><span class="co"># Beta regression requires 0 &lt; y &lt; 1</span></span>
<span id="cb61-225"><a href="#cb61-225" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb61-226"><a href="#cb61-226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(bipolaris, eps), <span class="dv">1</span> <span class="sc">-</span> eps))</span>
<span id="cb61-227"><a href="#cb61-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-228"><a href="#cb61-228" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Rows: "</span>, <span class="fu">nrow</span>(dat),</span>
<span id="cb61-229"><a href="#cb61-229" aria-hidden="true" tabindex="-1"></a>        <span class="st">" | curves: "</span>, <span class="fu">n_distinct</span>(dat<span class="sc">$</span>curve_id),</span>
<span id="cb61-230"><a href="#cb61-230" aria-hidden="true" tabindex="-1"></a>        <span class="st">" | hybrids: "</span>, <span class="fu">n_distinct</span>(dat<span class="sc">$</span>Hibrido),</span>
<span id="cb61-231"><a href="#cb61-231" aria-hidden="true" tabindex="-1"></a>        <span class="st">" | envs: "</span>, <span class="fu">n_distinct</span>(dat<span class="sc">$</span>Ambiente))</span>
<span id="cb61-232"><a href="#cb61-232" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-233"><a href="#cb61-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-234"><a href="#cb61-234" aria-hidden="true" tabindex="-1"></a><span class="fu">### Optional: join hybrid resistance class</span></span>
<span id="cb61-235"><a href="#cb61-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-238"><a href="#cb61-238" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-239"><a href="#cb61-239" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: data-resistance</span></span>
<span id="cb61-240"><a href="#cb61-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-241"><a href="#cb61-241" aria-hidden="true" tabindex="-1"></a>bipolaris_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb61-242"><a href="#cb61-242" aria-hidden="true" tabindex="-1"></a>  <span class="at">Hibrido =</span> <span class="fu">c</span>(</span>
<span id="cb61-243"><a href="#cb61-243" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AG 8701 PRO4"</span>,<span class="st">"AG 8707 PRO4"</span>,<span class="st">"AG 9021 PRO3"</span>,<span class="st">"AS 1757 PRO4"</span>,<span class="st">"AS 1868 PRO4"</span>,</span>
<span id="cb61-244"><a href="#cb61-244" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AS 1955 PRO4"</span>,<span class="st">"B 2801 PWU"</span>,<span class="st">"CRWX03"</span>,<span class="st">"DKB 230 PRO3"</span>,<span class="st">"DKB 242 PRO4"</span>,</span>
<span id="cb61-245"><a href="#cb61-245" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MG 616 PWU"</span>,<span class="st">"P 3016 VYHR"</span>,<span class="st">"T 1503 PWU"</span></span>
<span id="cb61-246"><a href="#cb61-246" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb61-247"><a href="#cb61-247" aria-hidden="true" tabindex="-1"></a>  <span class="at">resistance =</span> <span class="fu">c</span>(<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"R"</span>,<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"R"</span>,<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"MR"</span>,<span class="st">"R"</span>,<span class="st">"MR"</span>),</span>
<span id="cb61-248"><a href="#cb61-248" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb61-249"><a href="#cb61-249" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-250"><a href="#cb61-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-251"><a href="#cb61-251" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb61-252"><a href="#cb61-252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(bipolaris_df, <span class="at">by =</span> <span class="st">"Hibrido"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-253"><a href="#cb61-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb61-254"><a href="#cb61-254" aria-hidden="true" tabindex="-1"></a>    <span class="at">y          =</span> <span class="fu">as.numeric</span>(y),</span>
<span id="cb61-255"><a href="#cb61-255" aria-hidden="true" tabindex="-1"></a>    <span class="at">DAE        =</span> <span class="fu">as.numeric</span>(DAE),</span>
<span id="cb61-256"><a href="#cb61-256" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ambiente   =</span> <span class="fu">factor</span>(Ambiente),</span>
<span id="cb61-257"><a href="#cb61-257" aria-hidden="true" tabindex="-1"></a>    <span class="at">Hibrido    =</span> <span class="fu">factor</span>(Hibrido),</span>
<span id="cb61-258"><a href="#cb61-258" aria-hidden="true" tabindex="-1"></a>    <span class="at">curve_id   =</span> <span class="fu">factor</span>(curve_id),</span>
<span id="cb61-259"><a href="#cb61-259" aria-hidden="true" tabindex="-1"></a>    <span class="at">resistance =</span> <span class="fu">factor</span>(resistance)</span>
<span id="cb61-260"><a href="#cb61-260" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb61-261"><a href="#cb61-261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb61-262"><a href="#cb61-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-263"><a href="#cb61-263" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(dat)</span>
<span id="cb61-264"><a href="#cb61-264" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">|&gt;</span> </span>
<span id="cb61-265"><a href="#cb61-265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ambiente) <span class="sc">|&gt;</span> </span>
<span id="cb61-266"><a href="#cb61-266" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(DAE)</span>
<span id="cb61-267"><a href="#cb61-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-268"><a href="#cb61-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-269"><a href="#cb61-269" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-270"><a href="#cb61-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-271"><a href="#cb61-271" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb61-272"><a href="#cb61-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-273"><a href="#cb61-273" aria-hidden="true" tabindex="-1"></a><span class="fu">## Helper functions (scalars)</span></span>
<span id="cb61-274"><a href="#cb61-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-277"><a href="#cb61-277" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-278"><a href="#cb61-278" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: helpers-scalars</span></span>
<span id="cb61-279"><a href="#cb61-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-280"><a href="#cb61-280" aria-hidden="true" tabindex="-1"></a><span class="co"># T50: time when y reaches 0.5*ymax (linear interpolation)</span></span>
<span id="cb61-281"><a href="#cb61-281" aria-hidden="true" tabindex="-1"></a>t50_interp <span class="ot">&lt;-</span> <span class="cf">function</span>(time, y){</span>
<span id="cb61-282"><a href="#cb61-282" aria-hidden="true" tabindex="-1"></a>  o <span class="ot">&lt;-</span> <span class="fu">order</span>(time)</span>
<span id="cb61-283"><a href="#cb61-283" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> time[o]; y <span class="ot">&lt;-</span> y[o]</span>
<span id="cb61-284"><a href="#cb61-284" aria-hidden="true" tabindex="-1"></a>  ymax <span class="ot">&lt;-</span> <span class="fu">max</span>(y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb61-285"><a href="#cb61-285" aria-hidden="true" tabindex="-1"></a>  thr  <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> ymax</span>
<span id="cb61-286"><a href="#cb61-286" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">all</span>(y <span class="sc">&lt;</span> thr, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="fu">return</span>(<span class="cn">NA_real_</span>)</span>
<span id="cb61-287"><a href="#cb61-287" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> <span class="fu">which</span>(y <span class="sc">&gt;=</span> thr)[<span class="dv">1</span>]</span>
<span id="cb61-288"><a href="#cb61-288" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(k <span class="sc">==</span> <span class="dv">1</span>) <span class="fu">return</span>(time[<span class="dv">1</span>])</span>
<span id="cb61-289"><a href="#cb61-289" aria-hidden="true" tabindex="-1"></a>  t1 <span class="ot">&lt;-</span> time[k<span class="dv">-1</span>]; t2 <span class="ot">&lt;-</span> time[k]</span>
<span id="cb61-290"><a href="#cb61-290" aria-hidden="true" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> y[k<span class="dv">-1</span>];    y2 <span class="ot">&lt;-</span> y[k]</span>
<span id="cb61-291"><a href="#cb61-291" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">isTRUE</span>(<span class="fu">all.equal</span>(y2, y1))) <span class="fu">return</span>(t2)</span>
<span id="cb61-292"><a href="#cb61-292" aria-hidden="true" tabindex="-1"></a>  t1 <span class="sc">+</span> (thr <span class="sc">-</span> y1) <span class="sc">*</span> (t2 <span class="sc">-</span> t1) <span class="sc">/</span> (y2 <span class="sc">-</span> y1)</span>
<span id="cb61-293"><a href="#cb61-293" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-294"><a href="#cb61-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-295"><a href="#cb61-295" aria-hidden="true" tabindex="-1"></a><span class="co"># Logistic fit: y(t)=K/(1+exp(-r(t-t0))) and r_norm = r*(tmax-tmin)</span></span>
<span id="cb61-296"><a href="#cb61-296" aria-hidden="true" tabindex="-1"></a>logistic_fit_rate <span class="ot">&lt;-</span> <span class="cf">function</span>(time, y){</span>
<span id="cb61-297"><a href="#cb61-297" aria-hidden="true" tabindex="-1"></a>  o <span class="ot">&lt;-</span> <span class="fu">order</span>(time)</span>
<span id="cb61-298"><a href="#cb61-298" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> time[o]; y <span class="ot">&lt;-</span> y[o]</span>
<span id="cb61-299"><a href="#cb61-299" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(y, <span class="fl">1e-4</span>), <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1e-4</span>)</span>
<span id="cb61-300"><a href="#cb61-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-301"><a href="#cb61-301" aria-hidden="true" tabindex="-1"></a>  K0  <span class="ot">&lt;-</span> <span class="fu">max</span>(y)</span>
<span id="cb61-302"><a href="#cb61-302" aria-hidden="true" tabindex="-1"></a>  d   <span class="ot">&lt;-</span> <span class="fu">diff</span>(y)</span>
<span id="cb61-303"><a href="#cb61-303" aria-hidden="true" tabindex="-1"></a>  t00 <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="fu">length</span>(d) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">any</span>(<span class="fu">is.finite</span>(d))) time[<span class="fu">which.max</span>(d) <span class="sc">+</span> <span class="dv">1</span>] <span class="cf">else</span> <span class="fu">median</span>(time)</span>
<span id="cb61-304"><a href="#cb61-304" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.na</span>(t00)) t00 <span class="ot">&lt;-</span> <span class="fu">median</span>(time)</span>
<span id="cb61-305"><a href="#cb61-305" aria-hidden="true" tabindex="-1"></a>  r0  <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb61-306"><a href="#cb61-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-307"><a href="#cb61-307" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb61-308"><a href="#cb61-308" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nls</span>(</span>
<span id="cb61-309"><a href="#cb61-309" aria-hidden="true" tabindex="-1"></a>      y <span class="sc">~</span> K <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>r <span class="sc">*</span> (time <span class="sc">-</span> t0))),</span>
<span id="cb61-310"><a href="#cb61-310" aria-hidden="true" tabindex="-1"></a>      <span class="at">start =</span> <span class="fu">list</span>(<span class="at">K =</span> K0, <span class="at">r =</span> r0, <span class="at">t0 =</span> t00),</span>
<span id="cb61-311"><a href="#cb61-311" aria-hidden="true" tabindex="-1"></a>      <span class="at">control =</span> <span class="fu">nls.control</span>(<span class="at">maxiter =</span> <span class="dv">200</span>, <span class="at">warnOnly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb61-312"><a href="#cb61-312" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb61-313"><a href="#cb61-313" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb61-314"><a href="#cb61-314" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-315"><a href="#cb61-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-316"><a href="#cb61-316" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(f)) <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">r =</span> <span class="cn">NA_real_</span>, <span class="at">K =</span> <span class="cn">NA_real_</span>, <span class="at">t0 =</span> <span class="cn">NA_real_</span>, <span class="at">r_norm =</span> <span class="cn">NA_real_</span>))</span>
<span id="cb61-317"><a href="#cb61-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-318"><a href="#cb61-318" aria-hidden="true" tabindex="-1"></a>  co  <span class="ot">&lt;-</span> <span class="fu">coef</span>(f)</span>
<span id="cb61-319"><a href="#cb61-319" aria-hidden="true" tabindex="-1"></a>  r   <span class="ot">&lt;-</span> <span class="fu">unname</span>(co[<span class="st">"r"</span>])</span>
<span id="cb61-320"><a href="#cb61-320" aria-hidden="true" tabindex="-1"></a>  K   <span class="ot">&lt;-</span> <span class="fu">unname</span>(co[<span class="st">"K"</span>])</span>
<span id="cb61-321"><a href="#cb61-321" aria-hidden="true" tabindex="-1"></a>  t0  <span class="ot">&lt;-</span> <span class="fu">unname</span>(co[<span class="st">"t0"</span>])</span>
<span id="cb61-322"><a href="#cb61-322" aria-hidden="true" tabindex="-1"></a>  dur <span class="ot">&lt;-</span> <span class="fu">max</span>(time) <span class="sc">-</span> <span class="fu">min</span>(time)</span>
<span id="cb61-323"><a href="#cb61-323" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">r =</span> r, <span class="at">K =</span> K, <span class="at">t0 =</span> t0, <span class="at">r_norm =</span> r <span class="sc">*</span> dur)</span>
<span id="cb61-324"><a href="#cb61-324" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-325"><a href="#cb61-325" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-326"><a href="#cb61-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-327"><a href="#cb61-327" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb61-328"><a href="#cb61-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-329"><a href="#cb61-329" aria-hidden="true" tabindex="-1"></a><span class="fu">## Per-curve scalar metrics (AUDPC, final, T50, r_norm)</span></span>
<span id="cb61-330"><a href="#cb61-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-333"><a href="#cb61-333" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-334"><a href="#cb61-334" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: scalars-per-curve</span></span>
<span id="cb61-335"><a href="#cb61-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-336"><a href="#cb61-336" aria-hidden="true" tabindex="-1"></a>curve_stats <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb61-337"><a href="#cb61-337" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(curve_id, Ambiente, Hibrido) <span class="sc">%&gt;%</span></span>
<span id="cb61-338"><a href="#cb61-338" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb61-339"><a href="#cb61-339" aria-hidden="true" tabindex="-1"></a>    <span class="at">AUDPC     =</span> pracma<span class="sc">::</span><span class="fu">trapz</span>(DAE, y),</span>
<span id="cb61-340"><a href="#cb61-340" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_sev =</span> y[<span class="fu">which.max</span>(DAE)],</span>
<span id="cb61-341"><a href="#cb61-341" aria-hidden="true" tabindex="-1"></a>    <span class="at">T50       =</span> <span class="fu">t50_interp</span>(DAE, y),</span>
<span id="cb61-342"><a href="#cb61-342" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups   =</span> <span class="st">"drop"</span></span>
<span id="cb61-343"><a href="#cb61-343" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-344"><a href="#cb61-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-345"><a href="#cb61-345" aria-hidden="true" tabindex="-1"></a>rate_df <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(<span class="fu">unique</span>(curve_stats<span class="sc">$</span>curve_id), <span class="cf">function</span>(cid){</span>
<span id="cb61-346"><a href="#cb61-346" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">filter</span>(curve_id <span class="sc">==</span> cid)</span>
<span id="cb61-347"><a href="#cb61-347" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logistic_fit_rate</span>(df<span class="sc">$</span>DAE, df<span class="sc">$</span>y) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">curve_id =</span> <span class="fu">as.character</span>(cid))</span>
<span id="cb61-348"><a href="#cb61-348" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb61-349"><a href="#cb61-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-350"><a href="#cb61-350" aria-hidden="true" tabindex="-1"></a>curve_stats <span class="ot">&lt;-</span> curve_stats <span class="sc">%&gt;%</span></span>
<span id="cb61-351"><a href="#cb61-351" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">curve_id =</span> <span class="fu">as.character</span>(curve_id)) <span class="sc">%&gt;%</span></span>
<span id="cb61-352"><a href="#cb61-352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(rate_df, <span class="at">by =</span> <span class="st">"curve_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-353"><a href="#cb61-353" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(T50), <span class="fu">is.finite</span>(r_norm))</span>
<span id="cb61-354"><a href="#cb61-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-355"><a href="#cb61-355" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Curves with all scalar metrics: "</span>, <span class="fu">nrow</span>(curve_stats))</span>
<span id="cb61-356"><a href="#cb61-356" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-357"><a href="#cb61-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-358"><a href="#cb61-358" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb61-359"><a href="#cb61-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-360"><a href="#cb61-360" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hierarchical beta-GAM (HGAM) for smoothing and adjustment</span></span>
<span id="cb61-361"><a href="#cb61-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-362"><a href="#cb61-362" aria-hidden="true" tabindex="-1"></a>Model specification (as in your script):</span>
<span id="cb61-363"><a href="#cb61-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-364"><a href="#cb61-364" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>$s(\mathrm{DAE})$ global mean epidemic shape\</span>
<span id="cb61-365"><a href="#cb61-365" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>$s(\mathrm{DAE}, \mathrm{Ambiente}, \mathrm{bs}=\mathrm{fs})$ environment-specific deviation (random smooth)\</span>
<span id="cb61-366"><a href="#cb61-366" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>$s(\mathrm{DAE}, \mathrm{Hibrido}, \mathrm{bs}=\mathrm{fs})$ hybrid-specific deviation (random smooth)\</span>
<span id="cb61-367"><a href="#cb61-367" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>$s(\mathrm{curve<span class="sc">\_</span>id}, \mathrm{bs}=\mathrm{re})$ curve-level random intercept</span>
<span id="cb61-368"><a href="#cb61-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-371"><a href="#cb61-371" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-372"><a href="#cb61-372" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: gam-fit</span></span>
<span id="cb61-373"><a href="#cb61-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-374"><a href="#cb61-374" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb61-375"><a href="#cb61-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-376"><a href="#cb61-376" aria-hidden="true" tabindex="-1"></a>m_gam <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">bam</span>(</span>
<span id="cb61-377"><a href="#cb61-377" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="fu">s</span>(DAE, <span class="at">k =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb61-378"><a href="#cb61-378" aria-hidden="true" tabindex="-1"></a>    <span class="fu">s</span>(DAE, Ambiente, <span class="at">bs =</span> <span class="st">"fs"</span>, <span class="at">k =</span> <span class="dv">4</span>, <span class="at">m =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb61-379"><a href="#cb61-379" aria-hidden="true" tabindex="-1"></a>    <span class="fu">s</span>(DAE, Hibrido,  <span class="at">bs =</span> <span class="st">"fs"</span>, <span class="at">k =</span> <span class="dv">4</span>, <span class="at">m =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb61-380"><a href="#cb61-380" aria-hidden="true" tabindex="-1"></a>    <span class="fu">s</span>(curve_id, <span class="at">bs =</span> <span class="st">"re"</span>),</span>
<span id="cb61-381"><a href="#cb61-381" aria-hidden="true" tabindex="-1"></a>  <span class="at">family   =</span> mgcv<span class="sc">::</span><span class="fu">betar</span>(<span class="at">link =</span> <span class="st">"logit"</span>),</span>
<span id="cb61-382"><a href="#cb61-382" aria-hidden="true" tabindex="-1"></a>  <span class="at">data     =</span> dat,</span>
<span id="cb61-383"><a href="#cb61-383" aria-hidden="true" tabindex="-1"></a>  <span class="at">method   =</span> <span class="st">"fREML"</span>,</span>
<span id="cb61-384"><a href="#cb61-384" aria-hidden="true" tabindex="-1"></a>  <span class="at">discrete =</span> <span class="cn">TRUE</span>,</span>
<span id="cb61-385"><a href="#cb61-385" aria-hidden="true" tabindex="-1"></a>  <span class="at">gamma    =</span> <span class="fl">1.4</span>,</span>
<span id="cb61-386"><a href="#cb61-386" aria-hidden="true" tabindex="-1"></a>  <span class="at">select   =</span> <span class="cn">TRUE</span></span>
<span id="cb61-387"><a href="#cb61-387" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-388"><a href="#cb61-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-389"><a href="#cb61-389" aria-hidden="true" tabindex="-1"></a>mgcv<span class="sc">::</span><span class="fu">gam.check</span>(m_gam)</span>
<span id="cb61-390"><a href="#cb61-390" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(m_gam)</span>
<span id="cb61-391"><a href="#cb61-391" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_gam)</span>
<span id="cb61-392"><a href="#cb61-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-393"><a href="#cb61-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-394"><a href="#cb61-394" aria-hidden="true" tabindex="-1"></a>m_gam2 <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">bam</span>(</span>
<span id="cb61-395"><a href="#cb61-395" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="fu">s</span>(DAE, <span class="at">k =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb61-396"><a href="#cb61-396" aria-hidden="true" tabindex="-1"></a>    <span class="fu">s</span>(DAE, Ambiente, <span class="at">bs =</span> <span class="st">"fs"</span>, <span class="at">k =</span> <span class="dv">6</span>, <span class="at">m =</span> <span class="dv">2</span>) <span class="sc">+</span>  <span class="co"># k↑, m=2</span></span>
<span id="cb61-397"><a href="#cb61-397" aria-hidden="true" tabindex="-1"></a>    <span class="fu">s</span>(DAE, Hibrido,  <span class="at">bs =</span> <span class="st">"fs"</span>, <span class="at">k =</span> <span class="dv">6</span>, <span class="at">m =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb61-398"><a href="#cb61-398" aria-hidden="true" tabindex="-1"></a>    <span class="fu">s</span>(curve_id, <span class="at">bs =</span> <span class="st">"re"</span>),</span>
<span id="cb61-399"><a href="#cb61-399" aria-hidden="true" tabindex="-1"></a>  <span class="at">family   =</span> mgcv<span class="sc">::</span><span class="fu">betar</span>(<span class="at">link =</span> <span class="st">"logit"</span>),</span>
<span id="cb61-400"><a href="#cb61-400" aria-hidden="true" tabindex="-1"></a>  <span class="at">data     =</span> dat,</span>
<span id="cb61-401"><a href="#cb61-401" aria-hidden="true" tabindex="-1"></a>  <span class="at">method   =</span> <span class="st">"fREML"</span>,</span>
<span id="cb61-402"><a href="#cb61-402" aria-hidden="true" tabindex="-1"></a>  <span class="at">discrete =</span> <span class="cn">TRUE</span>,</span>
<span id="cb61-403"><a href="#cb61-403" aria-hidden="true" tabindex="-1"></a>  <span class="at">gamma    =</span> <span class="fl">1.4</span>,</span>
<span id="cb61-404"><a href="#cb61-404" aria-hidden="true" tabindex="-1"></a>  <span class="at">select   =</span> <span class="cn">TRUE</span></span>
<span id="cb61-405"><a href="#cb61-405" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-406"><a href="#cb61-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-407"><a href="#cb61-407" aria-hidden="true" tabindex="-1"></a>mgcv<span class="sc">::</span><span class="fu">gam.check</span>(m_gam2)</span>
<span id="cb61-408"><a href="#cb61-408" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(m_gam2)</span>
<span id="cb61-409"><a href="#cb61-409" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_gam2)</span>
<span id="cb61-410"><a href="#cb61-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-411"><a href="#cb61-411" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(m_gam, m_gam2)</span>
<span id="cb61-412"><a href="#cb61-412" aria-hidden="true" tabindex="-1"></a><span class="fu">BIC</span>(m_gam, m_gam2)</span>
<span id="cb61-413"><a href="#cb61-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-414"><a href="#cb61-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-415"><a href="#cb61-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-416"><a href="#cb61-416" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb61-417"><a href="#cb61-417" aria-hidden="true" tabindex="-1"></a>  <span class="at">Modelo =</span> <span class="fu">c</span>(<span class="st">"k=4, m=1"</span>, <span class="st">"k=6, m=2"</span>),</span>
<span id="cb61-418"><a href="#cb61-418" aria-hidden="true" tabindex="-1"></a>  <span class="at">AIC =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">4425.6</span>, <span class="sc">-</span><span class="fl">4469.4</span>),</span>
<span id="cb61-419"><a href="#cb61-419" aria-hidden="true" tabindex="-1"></a>  <span class="at">BIC =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">3886.9</span>, <span class="sc">-</span><span class="fl">3892.1</span>),</span>
<span id="cb61-420"><a href="#cb61-420" aria-hidden="true" tabindex="-1"></a>  <span class="at">edf_total =</span> <span class="fu">c</span>(<span class="fl">112.6</span>, <span class="fl">120.6</span>),</span>
<span id="cb61-421"><a href="#cb61-421" aria-hidden="true" tabindex="-1"></a>  <span class="at">edf_ambiente =</span> <span class="fu">c</span>(<span class="fl">17.5</span>, <span class="fl">24.0</span>),</span>
<span id="cb61-422"><a href="#cb61-422" aria-hidden="true" tabindex="-1"></a>  <span class="at">k_index_min =</span> <span class="fu">c</span>(<span class="fl">1.08</span>, <span class="fl">1.11</span>)</span>
<span id="cb61-423"><a href="#cb61-423" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-424"><a href="#cb61-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-425"><a href="#cb61-425" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb61-426"><a href="#cb61-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-427"><a href="#cb61-427" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb61-428"><a href="#cb61-428" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb61-429"><a href="#cb61-429" aria-hidden="true" tabindex="-1"></a>    <span class="at">res_k4 =</span> <span class="fu">residuals</span>(m_gam, <span class="at">type =</span> <span class="st">"pearson"</span>),</span>
<span id="cb61-430"><a href="#cb61-430" aria-hidden="true" tabindex="-1"></a>    <span class="at">res_k6 =</span> <span class="fu">residuals</span>(m_gam2, <span class="at">type =</span> <span class="st">"pearson"</span>)</span>
<span id="cb61-431"><a href="#cb61-431" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-432"><a href="#cb61-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-433"><a href="#cb61-433" aria-hidden="true" tabindex="-1"></a><span class="co"># Desvio padrão dos resíduos por ambiente</span></span>
<span id="cb61-434"><a href="#cb61-434" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span></span>
<span id="cb61-435"><a href="#cb61-435" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ambiente) <span class="sc">%&gt;%</span></span>
<span id="cb61-436"><a href="#cb61-436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb61-437"><a href="#cb61-437" aria-hidden="true" tabindex="-1"></a>    <span class="at">SD_k4 =</span> <span class="fu">sd</span>(res_k4),</span>
<span id="cb61-438"><a href="#cb61-438" aria-hidden="true" tabindex="-1"></a>    <span class="at">SD_k6 =</span> <span class="fu">sd</span>(res_k6),</span>
<span id="cb61-439"><a href="#cb61-439" aria-hidden="true" tabindex="-1"></a>    <span class="at">Melhoria =</span> (SD_k4 <span class="sc">-</span> SD_k6) <span class="sc">/</span> SD_k4 <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb61-440"><a href="#cb61-440" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb61-441"><a href="#cb61-441" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Melhoria))</span>
<span id="cb61-442"><a href="#cb61-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-443"><a href="#cb61-443" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-444"><a href="#cb61-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-445"><a href="#cb61-445" aria-hidden="true" tabindex="-1"></a><span class="fu">### Diagnostics (observed vs fitted and residuals)</span></span>
<span id="cb61-446"><a href="#cb61-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-449"><a href="#cb61-449" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-450"><a href="#cb61-450" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: gam-diagnostics</span></span>
<span id="cb61-451"><a href="#cb61-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-452"><a href="#cb61-452" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>mu_hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(m_gam2, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb61-453"><a href="#cb61-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-454"><a href="#cb61-454" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(mu_hat, y)) <span class="sc">+</span></span>
<span id="cb61-455"><a href="#cb61-455" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb61-456"><a href="#cb61-456" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb61-457"><a href="#cb61-457" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Fitted"</span>, <span class="at">y =</span> <span class="st">"Observed"</span>)</span>
<span id="cb61-458"><a href="#cb61-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-459"><a href="#cb61-459" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">residuals</span>(m_gam2, <span class="at">type =</span> <span class="st">"pearson"</span>)</span>
<span id="cb61-460"><a href="#cb61-460" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dat<span class="sc">$</span>DAE, res)</span>
<span id="cb61-461"><a href="#cb61-461" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb61-462"><a href="#cb61-462" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-463"><a href="#cb61-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-464"><a href="#cb61-464" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb61-465"><a href="#cb61-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-466"><a href="#cb61-466" aria-hidden="true" tabindex="-1"></a><span class="fu">## Environment-adjusted hybrid mean curves</span></span>
<span id="cb61-467"><a href="#cb61-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-468"><a href="#cb61-468" aria-hidden="true" tabindex="-1"></a>We obtain hybrid mean curves on a regular grid **excluding**:</span>
<span id="cb61-469"><a href="#cb61-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-470"><a href="#cb61-470" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>the environment random smooth term <span class="in">`s(DAE,Ambiente)`</span></span>
<span id="cb61-471"><a href="#cb61-471" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>the curve random intercept <span class="in">`s(curve_id)`</span></span>
<span id="cb61-472"><a href="#cb61-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-473"><a href="#cb61-473" aria-hidden="true" tabindex="-1"></a>so each hybrid is represented at a chosen reference environment level.</span>
<span id="cb61-474"><a href="#cb61-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-477"><a href="#cb61-477" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-478"><a href="#cb61-478" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: pred-hybrid-curves</span></span>
<span id="cb61-479"><a href="#cb61-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-480"><a href="#cb61-480" aria-hidden="true" tabindex="-1"></a>t_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(dat<span class="sc">$</span>DAE), <span class="fu">max</span>(dat<span class="sc">$</span>DAE), <span class="at">length.out =</span> grid_n)</span>
<span id="cb61-481"><a href="#cb61-481" aria-hidden="true" tabindex="-1"></a>env_ref <span class="ot">&lt;-</span> <span class="fu">levels</span>(dat<span class="sc">$</span>Ambiente)[<span class="dv">1</span>]</span>
<span id="cb61-482"><a href="#cb61-482" aria-hidden="true" tabindex="-1"></a>cultivars <span class="ot">&lt;-</span> <span class="fu">levels</span>(dat<span class="sc">$</span>Hibrido)</span>
<span id="cb61-483"><a href="#cb61-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-484"><a href="#cb61-484" aria-hidden="true" tabindex="-1"></a>pred_cult <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(cultivars, <span class="cf">function</span>(cv){</span>
<span id="cb61-485"><a href="#cb61-485" aria-hidden="true" tabindex="-1"></a>  newd <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb61-486"><a href="#cb61-486" aria-hidden="true" tabindex="-1"></a>    <span class="at">DAE      =</span> t_grid,</span>
<span id="cb61-487"><a href="#cb61-487" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ambiente =</span> <span class="fu">factor</span>(env_ref, <span class="at">levels =</span> <span class="fu">levels</span>(dat<span class="sc">$</span>Ambiente)),</span>
<span id="cb61-488"><a href="#cb61-488" aria-hidden="true" tabindex="-1"></a>    <span class="at">Hibrido  =</span> <span class="fu">factor</span>(cv, <span class="at">levels =</span> <span class="fu">levels</span>(dat<span class="sc">$</span>Hibrido)),</span>
<span id="cb61-489"><a href="#cb61-489" aria-hidden="true" tabindex="-1"></a>    <span class="at">curve_id =</span> dat<span class="sc">$</span>curve_id[<span class="dv">1</span>]  <span class="co"># dummy; excluded below</span></span>
<span id="cb61-490"><a href="#cb61-490" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-491"><a href="#cb61-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-492"><a href="#cb61-492" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb61-493"><a href="#cb61-493" aria-hidden="true" tabindex="-1"></a>    m_gam2, <span class="at">newdata =</span> newd, <span class="at">type =</span> <span class="st">"response"</span>,</span>
<span id="cb61-494"><a href="#cb61-494" aria-hidden="true" tabindex="-1"></a>    <span class="at">exclude =</span> <span class="fu">c</span>(<span class="st">"s(DAE,Ambiente)"</span>, <span class="st">"s(curve_id)"</span>)</span>
<span id="cb61-495"><a href="#cb61-495" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-496"><a href="#cb61-496" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">Hibrido =</span> cv, <span class="at">DAE =</span> t_grid, <span class="at">mu =</span> <span class="fu">as.numeric</span>(mu))</span>
<span id="cb61-497"><a href="#cb61-497" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb61-498"><a href="#cb61-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-499"><a href="#cb61-499" aria-hidden="true" tabindex="-1"></a>cult_score <span class="ot">&lt;-</span> pred_cult <span class="sc">%&gt;%</span></span>
<span id="cb61-500"><a href="#cb61-500" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Hibrido) <span class="sc">%&gt;%</span></span>
<span id="cb61-501"><a href="#cb61-501" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_mu =</span> <span class="fu">mean</span>(mu), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-502"><a href="#cb61-502" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(mean_mu)</span>
<span id="cb61-503"><a href="#cb61-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-504"><a href="#cb61-504" aria-hidden="true" tabindex="-1"></a>cult_score</span>
<span id="cb61-505"><a href="#cb61-505" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-506"><a href="#cb61-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-507"><a href="#cb61-507" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb61-508"><a href="#cb61-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-509"><a href="#cb61-509" aria-hidden="true" tabindex="-1"></a><span class="fu">## Functional distance among hybrids + clustering</span></span>
<span id="cb61-510"><a href="#cb61-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-511"><a href="#cb61-511" aria-hidden="true" tabindex="-1"></a><span class="fu">### Utility: shorten hybrid labels</span></span>
<span id="cb61-512"><a href="#cb61-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-515"><a href="#cb61-515" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-516"><a href="#cb61-516" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: utils-short-label</span></span>
<span id="cb61-517"><a href="#cb61-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-518"><a href="#cb61-518" aria-hidden="true" tabindex="-1"></a>shorten_hybrid <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb61-519"><a href="#cb61-519" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" PRO[0-9]+| PWU| VYHR"</span>, <span class="st">""</span>, x)</span>
<span id="cb61-520"><a href="#cb61-520" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">""</span>, x)</span>
<span id="cb61-521"><a href="#cb61-521" aria-hidden="true" tabindex="-1"></a>  x</span>
<span id="cb61-522"><a href="#cb61-522" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-523"><a href="#cb61-523" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-524"><a href="#cb61-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-525"><a href="#cb61-525" aria-hidden="true" tabindex="-1"></a><span class="fu">### Build distance matrix and cluster</span></span>
<span id="cb61-526"><a href="#cb61-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-529"><a href="#cb61-529" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-530"><a href="#cb61-530" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: functional-distance</span></span>
<span id="cb61-531"><a href="#cb61-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-532"><a href="#cb61-532" aria-hidden="true" tabindex="-1"></a><span class="co"># Wide matrix: rows = time, cols = hybrid</span></span>
<span id="cb61-533"><a href="#cb61-533" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> pred_cult <span class="sc">%&gt;%</span></span>
<span id="cb61-534"><a href="#cb61-534" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(DAE, Hibrido, mu) <span class="sc">%&gt;%</span></span>
<span id="cb61-535"><a href="#cb61-535" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> Hibrido, <span class="at">values_from =</span> mu) <span class="sc">%&gt;%</span></span>
<span id="cb61-536"><a href="#cb61-536" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(DAE)</span>
<span id="cb61-537"><a href="#cb61-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-538"><a href="#cb61-538" aria-hidden="true" tabindex="-1"></a>dt_grid <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">diff</span>(mat<span class="sc">$</span>DAE))</span>
<span id="cb61-539"><a href="#cb61-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-540"><a href="#cb61-540" aria-hidden="true" tabindex="-1"></a>matX <span class="ot">&lt;-</span> mat <span class="sc">%&gt;%</span></span>
<span id="cb61-541"><a href="#cb61-541" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>DAE) <span class="sc">%&gt;%</span></span>
<span id="cb61-542"><a href="#cb61-542" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb61-543"><a href="#cb61-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-544"><a href="#cb61-544" aria-hidden="true" tabindex="-1"></a><span class="co"># Functional L2 distance (grid approximation)</span></span>
<span id="cb61-545"><a href="#cb61-545" aria-hidden="true" tabindex="-1"></a>D_cult <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(<span class="fu">t</span>(matX), <span class="at">method =</span> <span class="st">"euclidean"</span>)) <span class="sc">*</span> <span class="fu">sqrt</span>(dt_grid)</span>
<span id="cb61-546"><a href="#cb61-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-547"><a href="#cb61-547" aria-hidden="true" tabindex="-1"></a>hc <span class="ot">&lt;-</span> <span class="fu">hclust</span>(<span class="fu">as.dist</span>(D_cult), <span class="at">method =</span> <span class="st">"ward.D2"</span>)</span>
<span id="cb61-548"><a href="#cb61-548" aria-hidden="true" tabindex="-1"></a>cl_raw <span class="ot">&lt;-</span> <span class="fu">cutree</span>(hc, <span class="at">k =</span> k_clusters)</span>
<span id="cb61-549"><a href="#cb61-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-550"><a href="#cb61-550" aria-hidden="true" tabindex="-1"></a><span class="co"># Order clusters by mean severity (from cult_score)</span></span>
<span id="cb61-551"><a href="#cb61-551" aria-hidden="true" tabindex="-1"></a>cluster_rank_map <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">Hibrido =</span> <span class="fu">names</span>(cl_raw),</span>
<span id="cb61-552"><a href="#cb61-552" aria-hidden="true" tabindex="-1"></a>                           <span class="at">cluster_raw =</span> <span class="fu">as.integer</span>(cl_raw)) <span class="sc">%&gt;%</span></span>
<span id="cb61-553"><a href="#cb61-553" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(cult_score <span class="sc">%&gt;%</span> <span class="fu">select</span>(Hibrido, mean_mu), <span class="at">by =</span> <span class="st">"Hibrido"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-554"><a href="#cb61-554" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster_raw) <span class="sc">%&gt;%</span></span>
<span id="cb61-555"><a href="#cb61-555" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">cluster_mean =</span> <span class="fu">mean</span>(mean_mu, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-556"><a href="#cb61-556" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(cluster_mean) <span class="sc">%&gt;%</span></span>
<span id="cb61-557"><a href="#cb61-557" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cluster =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb61-558"><a href="#cb61-558" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(cluster_raw, cluster)</span>
<span id="cb61-559"><a href="#cb61-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-560"><a href="#cb61-560" aria-hidden="true" tabindex="-1"></a>cluster_table2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">Hibrido =</span> <span class="fu">names</span>(cl_raw),</span>
<span id="cb61-561"><a href="#cb61-561" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cluster_raw =</span> <span class="fu">as.integer</span>(cl_raw)) <span class="sc">%&gt;%</span></span>
<span id="cb61-562"><a href="#cb61-562" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(cluster_rank_map, <span class="at">by =</span> <span class="st">"cluster_raw"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-563"><a href="#cb61-563" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(cult_score <span class="sc">%&gt;%</span> <span class="fu">select</span>(Hibrido, mean_mu), <span class="at">by =</span> <span class="st">"Hibrido"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-564"><a href="#cb61-564" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb61-565"><a href="#cb61-565" aria-hidden="true" tabindex="-1"></a>    <span class="at">phenotype =</span> <span class="fu">factor</span>(cluster,</span>
<span id="cb61-566"><a href="#cb61-566" aria-hidden="true" tabindex="-1"></a>                       <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span>k_clusters,</span>
<span id="cb61-567"><a href="#cb61-567" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> <span class="fu">paste0</span>(<span class="st">"P"</span>, <span class="dv">1</span><span class="sc">:</span>k_clusters))</span>
<span id="cb61-568"><a href="#cb61-568" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-569"><a href="#cb61-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-570"><a href="#cb61-570" aria-hidden="true" tabindex="-1"></a>cluster_table2</span>
<span id="cb61-571"><a href="#cb61-571" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-572"><a href="#cb61-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-573"><a href="#cb61-573" aria-hidden="true" tabindex="-1"></a><span class="fu">### Figure: mean curves by phenotype + dendrogram</span></span>
<span id="cb61-574"><a href="#cb61-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-577"><a href="#cb61-577" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-578"><a href="#cb61-578" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: figure-functional-panels</span></span>
<span id="cb61-579"><a href="#cb61-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-580"><a href="#cb61-580" aria-hidden="true" tabindex="-1"></a>cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#D55E00"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#009E73"</span>, <span class="st">"#CC79A7"</span>)[<span class="dv">1</span><span class="sc">:</span>k_clusters]</span>
<span id="cb61-581"><a href="#cb61-581" aria-hidden="true" tabindex="-1"></a>phen_cols <span class="ot">&lt;-</span> <span class="fu">setNames</span>(cols, <span class="fu">levels</span>(cluster_table2<span class="sc">$</span>phenotype))</span>
<span id="cb61-582"><a href="#cb61-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-583"><a href="#cb61-583" aria-hidden="true" tabindex="-1"></a>pred_cult2 <span class="ot">&lt;-</span> pred_cult <span class="sc">%&gt;%</span></span>
<span id="cb61-584"><a href="#cb61-584" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(cluster_table2 <span class="sc">%&gt;%</span> <span class="fu">select</span>(Hibrido, phenotype), <span class="at">by =</span> <span class="st">"Hibrido"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-585"><a href="#cb61-585" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hybrid_short =</span> <span class="fu">shorten_hybrid</span>(Hibrido))</span>
<span id="cb61-586"><a href="#cb61-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-587"><a href="#cb61-587" aria-hidden="true" tabindex="-1"></a>pred_cult2 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(pred_cult2, bipolaris_df)</span>
<span id="cb61-588"><a href="#cb61-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-589"><a href="#cb61-589" aria-hidden="true" tabindex="-1"></a>label_df <span class="ot">&lt;-</span> pred_cult2 <span class="sc">%&gt;%</span></span>
<span id="cb61-590"><a href="#cb61-590" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Hibrido) <span class="sc">%&gt;%</span></span>
<span id="cb61-591"><a href="#cb61-591" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(DAE <span class="sc">==</span> <span class="fu">max</span>(DAE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb61-592"><a href="#cb61-592" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb61-593"><a href="#cb61-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-594"><a href="#cb61-594" aria-hidden="true" tabindex="-1"></a>p_hibridos <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pred_cult2,</span>
<span id="cb61-595"><a href="#cb61-595" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">aes</span>(<span class="at">x =</span> DAE, <span class="at">y =</span> mu, <span class="at">group =</span> Hibrido, <span class="at">linetype  =</span> resistance, <span class="at">color =</span> phenotype)) <span class="sc">+</span></span>
<span id="cb61-596"><a href="#cb61-596" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.1</span>, <span class="at">alpha =</span> <span class="fl">0.95</span>) <span class="sc">+</span></span>
<span id="cb61-597"><a href="#cb61-597" aria-hidden="true" tabindex="-1"></a>  ggrepel<span class="sc">::</span><span class="fu">geom_text_repel</span>(</span>
<span id="cb61-598"><a href="#cb61-598" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> label_df,</span>
<span id="cb61-599"><a href="#cb61-599" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">label =</span> hybrid_short),</span>
<span id="cb61-600"><a href="#cb61-600" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">direction =</span> <span class="st">"y"</span>,</span>
<span id="cb61-601"><a href="#cb61-601" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_x =</span> <span class="dv">2</span>,</span>
<span id="cb61-602"><a href="#cb61-602" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fl">2.8</span>,</span>
<span id="cb61-603"><a href="#cb61-603" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb61-604"><a href="#cb61-604" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.size =</span> <span class="fl">0.2</span>,</span>
<span id="cb61-605"><a href="#cb61-605" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.alpha =</span> <span class="fl">0.6</span></span>
<span id="cb61-606"><a href="#cb61-606" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb61-607"><a href="#cb61-607" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_limits</span>(<span class="at">x =</span> <span class="fu">max</span>(pred_cult2<span class="sc">$</span>DAE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> <span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb61-608"><a href="#cb61-608" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> phen_cols, <span class="at">drop =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb61-609"><a href="#cb61-609" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Days after emergence (DAE)"</span>,</span>
<span id="cb61-610"><a href="#cb61-610" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Environment-adjusted mean severity"</span>,</span>
<span id="cb61-611"><a href="#cb61-611" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Phenotype"</span>, <span class="at">linetype =</span> <span class="st">"Resistance"</span>) <span class="sc">+</span></span>
<span id="cb61-612"><a href="#cb61-612" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb61-613"><a href="#cb61-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-614"><a href="#cb61-614" aria-hidden="true" tabindex="-1"></a>ddata <span class="ot">&lt;-</span> ggdendro<span class="sc">::</span><span class="fu">dendro_data</span>(<span class="fu">as.dendrogram</span>(hc), <span class="at">type =</span> <span class="st">"rectangle"</span>)</span>
<span id="cb61-615"><a href="#cb61-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-616"><a href="#cb61-616" aria-hidden="true" tabindex="-1"></a>lab_map <span class="ot">&lt;-</span> cluster_table2 <span class="sc">%&gt;%</span></span>
<span id="cb61-617"><a href="#cb61-617" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> Hibrido,</span>
<span id="cb61-618"><a href="#cb61-618" aria-hidden="true" tabindex="-1"></a>         <span class="at">label_short =</span> <span class="fu">shorten_hybrid</span>(Hibrido),</span>
<span id="cb61-619"><a href="#cb61-619" aria-hidden="true" tabindex="-1"></a>         <span class="at">lab_col =</span> phen_cols[<span class="fu">as.character</span>(phenotype)]) <span class="sc">%&gt;%</span></span>
<span id="cb61-620"><a href="#cb61-620" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(label, label_short, lab_col)</span>
<span id="cb61-621"><a href="#cb61-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-622"><a href="#cb61-622" aria-hidden="true" tabindex="-1"></a>lab_df <span class="ot">&lt;-</span> ddata<span class="sc">$</span>labels <span class="sc">%&gt;%</span></span>
<span id="cb61-623"><a href="#cb61-623" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(lab_map, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"label"</span> <span class="ot">=</span> <span class="st">"label"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb61-624"><a href="#cb61-624" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label_short =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(label_short), <span class="fu">shorten_hybrid</span>(label), label_short))</span>
<span id="cb61-625"><a href="#cb61-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-626"><a href="#cb61-626" aria-hidden="true" tabindex="-1"></a>p_dend <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb61-627"><a href="#cb61-627" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> ddata<span class="sc">$</span>segments,</span>
<span id="cb61-628"><a href="#cb61-628" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend),</span>
<span id="cb61-629"><a href="#cb61-629" aria-hidden="true" tabindex="-1"></a>               <span class="at">linewidth =</span> <span class="fl">0.45</span>) <span class="sc">+</span></span>
<span id="cb61-630"><a href="#cb61-630" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> lab_df,</span>
<span id="cb61-631"><a href="#cb61-631" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y <span class="sc">-</span> <span class="fl">0.02</span> <span class="sc">*</span> <span class="fu">max</span>(ddata<span class="sc">$</span>segments<span class="sc">$</span>y),</span>
<span id="cb61-632"><a href="#cb61-632" aria-hidden="true" tabindex="-1"></a>                <span class="at">label =</span> label_short, <span class="at">color =</span> <span class="fu">I</span>(lab_col)),</span>
<span id="cb61-633"><a href="#cb61-633" aria-hidden="true" tabindex="-1"></a>            <span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb61-634"><a href="#cb61-634" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Functional distance"</span>) <span class="sc">+</span></span>
<span id="cb61-635"><a href="#cb61-635" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb61-636"><a href="#cb61-636" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.line.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb61-637"><a href="#cb61-637" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb61-638"><a href="#cb61-638" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x  =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb61-639"><a href="#cb61-639" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">clip =</span> <span class="st">"off"</span>) <span class="sc">+</span></span>
<span id="cb61-640"><a href="#cb61-640" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="fl">5.5</span>, <span class="at">r =</span> <span class="fl">5.5</span>, <span class="at">b =</span> <span class="dv">18</span>, <span class="at">l =</span> <span class="fl">5.5</span>))</span>
<span id="cb61-641"><a href="#cb61-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-642"><a href="#cb61-642" aria-hidden="true" tabindex="-1"></a>h_cut <span class="ot">&lt;-</span> hc<span class="sc">$</span>height[<span class="fu">length</span>(hc<span class="sc">$</span>height) <span class="sc">-</span> (k_clusters <span class="sc">-</span> <span class="dv">1</span>)]</span>
<span id="cb61-643"><a href="#cb61-643" aria-hidden="true" tabindex="-1"></a>p_dend <span class="ot">&lt;-</span> p_dend <span class="sc">+</span></span>
<span id="cb61-644"><a href="#cb61-644" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> h_cut, <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb61-645"><a href="#cb61-645" aria-hidden="true" tabindex="-1"></a>             <span class="at">linewidth =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"grey30"</span>)</span>
<span id="cb61-646"><a href="#cb61-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-647"><a href="#cb61-647" aria-hidden="true" tabindex="-1"></a>fig_final <span class="ot">&lt;-</span> (p_hibridos <span class="sc">|</span> p_dend) <span class="sc">+</span> <span class="fu">plot_annotation</span>(<span class="at">tag_levels =</span> <span class="st">"A"</span>)</span>
<span id="cb61-648"><a href="#cb61-648" aria-hidden="true" tabindex="-1"></a>fig_final</span>
<span id="cb61-649"><a href="#cb61-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-650"><a href="#cb61-650" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("Figure2_functional_phenotypes.png", fig_final, width = 12, height = 5.5, dpi = 300)</span></span>
<span id="cb61-651"><a href="#cb61-651" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-652"><a href="#cb61-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-653"><a href="#cb61-653" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb61-654"><a href="#cb61-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-655"><a href="#cb61-655" aria-hidden="true" tabindex="-1"></a><span class="fu">## Scalar-equivalent but trajectory-distinct curves</span></span>
<span id="cb61-656"><a href="#cb61-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-657"><a href="#cb61-657" aria-hidden="true" tabindex="-1"></a>We select two **individual curves** (by <span class="in">`curve_id`</span>) that are close in scalar space (AUDPC + final severity) but have large functional distance on a common grid.</span>
<span id="cb61-658"><a href="#cb61-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-659"><a href="#cb61-659" aria-hidden="true" tabindex="-1"></a><span class="fu">### Select candidate pairs (scalar-nearest) and maximize functional distance</span></span>
<span id="cb61-660"><a href="#cb61-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-663"><a href="#cb61-663" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-664"><a href="#cb61-664" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: killer-select-pair</span></span>
<span id="cb61-665"><a href="#cb61-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-666"><a href="#cb61-666" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb61-667"><a href="#cb61-667" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb61-668"><a href="#cb61-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-669"><a href="#cb61-669" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-670"><a href="#cb61-670" aria-hidden="true" tabindex="-1"></a><span class="co"># 0) Prep scalar stats table (one row per curve)</span></span>
<span id="cb61-671"><a href="#cb61-671" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-672"><a href="#cb61-672" aria-hidden="true" tabindex="-1"></a>dfS <span class="ot">&lt;-</span> curve_stats <span class="sc">%&gt;%</span></span>
<span id="cb61-673"><a href="#cb61-673" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb61-674"><a href="#cb61-674" aria-hidden="true" tabindex="-1"></a>    <span class="at">curve_id  =</span> <span class="fu">as.character</span>(curve_id),</span>
<span id="cb61-675"><a href="#cb61-675" aria-hidden="true" tabindex="-1"></a>    <span class="at">AUDPC     =</span> <span class="fu">as.numeric</span>(AUDPC),</span>
<span id="cb61-676"><a href="#cb61-676" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_sev =</span> <span class="fu">as.numeric</span>(final_sev)</span>
<span id="cb61-677"><a href="#cb61-677" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb61-678"><a href="#cb61-678" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(AUDPC), <span class="fu">is.finite</span>(final_sev)) <span class="sc">%&gt;%</span></span>
<span id="cb61-679"><a href="#cb61-679" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(curve_id, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-680"><a href="#cb61-680" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb61-681"><a href="#cb61-681" aria-hidden="true" tabindex="-1"></a>    <span class="at">AUDPC_z =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(AUDPC)),</span>
<span id="cb61-682"><a href="#cb61-682" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_z =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(final_sev))</span>
<span id="cb61-683"><a href="#cb61-683" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-684"><a href="#cb61-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-685"><a href="#cb61-685" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">nrow</span>(dfS) <span class="sc">&gt;=</span> <span class="dv">2</span>)</span>
<span id="cb61-686"><a href="#cb61-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-687"><a href="#cb61-687" aria-hidden="true" tabindex="-1"></a><span class="co"># Common dt for functional distance</span></span>
<span id="cb61-688"><a href="#cb61-688" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">diff</span>(t_grid))</span>
<span id="cb61-689"><a href="#cb61-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-690"><a href="#cb61-690" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-691"><a href="#cb61-691" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Utilities (define ONCE, keep signature consistent)</span></span>
<span id="cb61-692"><a href="#cb61-692" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-693"><a href="#cb61-693" aria-hidden="true" tabindex="-1"></a>interp_curve <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, t_grid, id){</span>
<span id="cb61-694"><a href="#cb61-694" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb61-695"><a href="#cb61-695" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">as.character</span>(curve_id) <span class="sc">==</span> id) <span class="sc">%&gt;%</span></span>
<span id="cb61-696"><a href="#cb61-696" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(DAE)</span>
<span id="cb61-697"><a href="#cb61-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-698"><a href="#cb61-698" aria-hidden="true" tabindex="-1"></a>  stats<span class="sc">::</span><span class="fu">approx</span>(df<span class="sc">$</span>DAE, df<span class="sc">$</span>y, <span class="at">xout =</span> t_grid, <span class="at">rule =</span> <span class="dv">2</span>)<span class="sc">$</span>y</span>
<span id="cb61-699"><a href="#cb61-699" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-700"><a href="#cb61-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-701"><a href="#cb61-701" aria-hidden="true" tabindex="-1"></a>pairwise_table <span class="ot">&lt;-</span> <span class="cf">function</span>(dfS){</span>
<span id="cb61-702"><a href="#cb61-702" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crossing</span>(</span>
<span id="cb61-703"><a href="#cb61-703" aria-hidden="true" tabindex="-1"></a>    dfS <span class="sc">%&gt;%</span></span>
<span id="cb61-704"><a href="#cb61-704" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">paste0</span>(.x, <span class="st">".x"</span>), <span class="sc">-</span>curve_id) <span class="sc">%&gt;%</span></span>
<span id="cb61-705"><a href="#cb61-705" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">curve_id.x =</span> curve_id),</span>
<span id="cb61-706"><a href="#cb61-706" aria-hidden="true" tabindex="-1"></a>    dfS <span class="sc">%&gt;%</span></span>
<span id="cb61-707"><a href="#cb61-707" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">paste0</span>(.x, <span class="st">".y"</span>), <span class="sc">-</span>curve_id) <span class="sc">%&gt;%</span></span>
<span id="cb61-708"><a href="#cb61-708" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">curve_id.y =</span> curve_id)</span>
<span id="cb61-709"><a href="#cb61-709" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb61-710"><a href="#cb61-710" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(curve_id.x <span class="sc">&lt;</span> curve_id.y)</span>
<span id="cb61-711"><a href="#cb61-711" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-712"><a href="#cb61-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-713"><a href="#cb61-713" aria-hidden="true" tabindex="-1"></a>add_func_dist <span class="ot">&lt;-</span> <span class="cf">function</span>(pairs_df, dat, t_grid, dt){</span>
<span id="cb61-714"><a href="#cb61-714" aria-hidden="true" tabindex="-1"></a>  pairs_df <span class="sc">%&gt;%</span></span>
<span id="cb61-715"><a href="#cb61-715" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb61-716"><a href="#cb61-716" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb61-717"><a href="#cb61-717" aria-hidden="true" tabindex="-1"></a>      <span class="at">func_dist =</span> {</span>
<span id="cb61-718"><a href="#cb61-718" aria-hidden="true" tabindex="-1"></a>        y1 <span class="ot">&lt;-</span> <span class="fu">interp_curve</span>(dat, t_grid, curve_id.x)</span>
<span id="cb61-719"><a href="#cb61-719" aria-hidden="true" tabindex="-1"></a>        y2 <span class="ot">&lt;-</span> <span class="fu">interp_curve</span>(dat, t_grid, curve_id.y)</span>
<span id="cb61-720"><a href="#cb61-720" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sqrt</span>(<span class="fu">sum</span>((y1 <span class="sc">-</span> y2)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> dt)</span>
<span id="cb61-721"><a href="#cb61-721" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb61-722"><a href="#cb61-722" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb61-723"><a href="#cb61-723" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb61-724"><a href="#cb61-724" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-725"><a href="#cb61-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-726"><a href="#cb61-726" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-727"><a href="#cb61-727" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Build base pair table with scalar distances/gaps</span></span>
<span id="cb61-728"><a href="#cb61-728" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-729"><a href="#cb61-729" aria-hidden="true" tabindex="-1"></a>pairs0 <span class="ot">&lt;-</span> <span class="fu">pairwise_table</span>(dfS) <span class="sc">%&gt;%</span></span>
<span id="cb61-730"><a href="#cb61-730" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb61-731"><a href="#cb61-731" aria-hidden="true" tabindex="-1"></a>    <span class="at">scalar_dist =</span> <span class="fu">sqrt</span>((AUDPC_z.x <span class="sc">-</span> AUDPC_z.y)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (final_z.x <span class="sc">-</span> final_z.y)<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb61-732"><a href="#cb61-732" aria-hidden="true" tabindex="-1"></a>    <span class="at">audpc_gap   =</span> <span class="fu">abs</span>(AUDPC.x <span class="sc">-</span> AUDPC.y),</span>
<span id="cb61-733"><a href="#cb61-733" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_gap   =</span> <span class="fu">abs</span>(final_sev.x <span class="sc">-</span> final_sev.y)</span>
<span id="cb61-734"><a href="#cb61-734" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-735"><a href="#cb61-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-736"><a href="#cb61-736" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-737"><a href="#cb61-737" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Panel A: "killer pair" = very similar scalar, maximize functional distance</span></span>
<span id="cb61-738"><a href="#cb61-738" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-739"><a href="#cb61-739" aria-hidden="true" tabindex="-1"></a>thr  <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pairs0<span class="sc">$</span>scalar_dist, <span class="fl">0.03</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb61-740"><a href="#cb61-740" aria-hidden="true" tabindex="-1"></a>candA <span class="ot">&lt;-</span> pairs0 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(scalar_dist <span class="sc">&lt;=</span> thr)</span>
<span id="cb61-741"><a href="#cb61-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-742"><a href="#cb61-742" aria-hidden="true" tabindex="-1"></a>candA2 <span class="ot">&lt;-</span> candA <span class="sc">%&gt;%</span></span>
<span id="cb61-743"><a href="#cb61-743" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_func_dist</span>(dat, t_grid, dt)</span>
<span id="cb61-744"><a href="#cb61-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-745"><a href="#cb61-745" aria-hidden="true" tabindex="-1"></a>best_A <span class="ot">&lt;-</span> candA2 <span class="sc">%&gt;%</span></span>
<span id="cb61-746"><a href="#cb61-746" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(func_dist), scalar_dist) <span class="sc">%&gt;%</span></span>
<span id="cb61-747"><a href="#cb61-747" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb61-748"><a href="#cb61-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-749"><a href="#cb61-749" aria-hidden="true" tabindex="-1"></a>idA1 <span class="ot">&lt;-</span> best_A<span class="sc">$</span>curve_id.x</span>
<span id="cb61-750"><a href="#cb61-750" aria-hidden="true" tabindex="-1"></a>idA2 <span class="ot">&lt;-</span> best_A<span class="sc">$</span>curve_id.y</span>
<span id="cb61-751"><a href="#cb61-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-752"><a href="#cb61-752" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-753"><a href="#cb61-753" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Panel B: maximize AUDPC gap (optionally annotate functional distance)</span></span>
<span id="cb61-754"><a href="#cb61-754" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-755"><a href="#cb61-755" aria-hidden="true" tabindex="-1"></a>best_B <span class="ot">&lt;-</span> pairs0 <span class="sc">%&gt;%</span></span>
<span id="cb61-756"><a href="#cb61-756" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(audpc_gap)) <span class="sc">%&gt;%</span></span>
<span id="cb61-757"><a href="#cb61-757" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-758"><a href="#cb61-758" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_func_dist</span>(dat, t_grid, dt)</span>
<span id="cb61-759"><a href="#cb61-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-760"><a href="#cb61-760" aria-hidden="true" tabindex="-1"></a>idB1 <span class="ot">&lt;-</span> best_B<span class="sc">$</span>curve_id.x</span>
<span id="cb61-761"><a href="#cb61-761" aria-hidden="true" tabindex="-1"></a>idB2 <span class="ot">&lt;-</span> best_B<span class="sc">$</span>curve_id.y</span>
<span id="cb61-762"><a href="#cb61-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-763"><a href="#cb61-763" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-764"><a href="#cb61-764" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) Panel C: same final, different AUDPC (safe fallback if empty)</span></span>
<span id="cb61-765"><a href="#cb61-765" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-766"><a href="#cb61-766" aria-hidden="true" tabindex="-1"></a>final_tol <span class="ot">&lt;-</span> <span class="fl">0.03</span></span>
<span id="cb61-767"><a href="#cb61-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-768"><a href="#cb61-768" aria-hidden="true" tabindex="-1"></a>candC <span class="ot">&lt;-</span> pairs0 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(final_gap <span class="sc">&lt;=</span> final_tol)</span>
<span id="cb61-769"><a href="#cb61-769" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(candC) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb61-770"><a href="#cb61-770" aria-hidden="true" tabindex="-1"></a>  final_tol <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb61-771"><a href="#cb61-771" aria-hidden="true" tabindex="-1"></a>  candC <span class="ot">&lt;-</span> pairs0 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(final_gap <span class="sc">&lt;=</span> final_tol)</span>
<span id="cb61-772"><a href="#cb61-772" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-773"><a href="#cb61-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-774"><a href="#cb61-774" aria-hidden="true" tabindex="-1"></a>best_C <span class="ot">&lt;-</span> candC <span class="sc">%&gt;%</span></span>
<span id="cb61-775"><a href="#cb61-775" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(audpc_gap), final_gap) <span class="sc">%&gt;%</span></span>
<span id="cb61-776"><a href="#cb61-776" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-777"><a href="#cb61-777" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_func_dist</span>(dat, t_grid, dt)</span>
<span id="cb61-778"><a href="#cb61-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-779"><a href="#cb61-779" aria-hidden="true" tabindex="-1"></a>idC1 <span class="ot">&lt;-</span> best_C<span class="sc">$</span>curve_id.x</span>
<span id="cb61-780"><a href="#cb61-780" aria-hidden="true" tabindex="-1"></a>idC2 <span class="ot">&lt;-</span> best_C<span class="sc">$</span>curve_id.y</span>
<span id="cb61-781"><a href="#cb61-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-782"><a href="#cb61-782" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-783"><a href="#cb61-783" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) Panel D: similar AUDPC, large functional distance (exclude used IDs)</span></span>
<span id="cb61-784"><a href="#cb61-784" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-785"><a href="#cb61-785" aria-hidden="true" tabindex="-1"></a>used_ids <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">c</span>(idA1, idA2, idB1, idB2, idC1, idC2))</span>
<span id="cb61-786"><a href="#cb61-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-787"><a href="#cb61-787" aria-hidden="true" tabindex="-1"></a>pairsD <span class="ot">&lt;-</span> pairs0 <span class="sc">%&gt;%</span></span>
<span id="cb61-788"><a href="#cb61-788" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(curve_id.x <span class="sc">%in%</span> used_ids),</span>
<span id="cb61-789"><a href="#cb61-789" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span>(curve_id.y <span class="sc">%in%</span> used_ids))</span>
<span id="cb61-790"><a href="#cb61-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-791"><a href="#cb61-791" aria-hidden="true" tabindex="-1"></a>audpc_q <span class="ot">&lt;-</span> <span class="fl">0.10</span></span>
<span id="cb61-792"><a href="#cb61-792" aria-hidden="true" tabindex="-1"></a>cutD <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pairsD<span class="sc">$</span>audpc_gap, audpc_q, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb61-793"><a href="#cb61-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-794"><a href="#cb61-794" aria-hidden="true" tabindex="-1"></a>candD <span class="ot">&lt;-</span> pairsD <span class="sc">%&gt;%</span></span>
<span id="cb61-795"><a href="#cb61-795" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(audpc_gap <span class="sc">&lt;=</span> cutD) <span class="sc">%&gt;%</span></span>
<span id="cb61-796"><a href="#cb61-796" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_func_dist</span>(dat, t_grid, dt)</span>
<span id="cb61-797"><a href="#cb61-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-798"><a href="#cb61-798" aria-hidden="true" tabindex="-1"></a><span class="co"># fallback if candD empty</span></span>
<span id="cb61-799"><a href="#cb61-799" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(candD) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb61-800"><a href="#cb61-800" aria-hidden="true" tabindex="-1"></a>  cutD <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pairsD<span class="sc">$</span>audpc_gap, <span class="fl">0.20</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb61-801"><a href="#cb61-801" aria-hidden="true" tabindex="-1"></a>  candD <span class="ot">&lt;-</span> pairsD <span class="sc">%&gt;%</span></span>
<span id="cb61-802"><a href="#cb61-802" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(audpc_gap <span class="sc">&lt;=</span> cutD) <span class="sc">%&gt;%</span></span>
<span id="cb61-803"><a href="#cb61-803" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_func_dist</span>(dat, t_grid, dt)</span>
<span id="cb61-804"><a href="#cb61-804" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-805"><a href="#cb61-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-806"><a href="#cb61-806" aria-hidden="true" tabindex="-1"></a>best_D <span class="ot">&lt;-</span> candD <span class="sc">%&gt;%</span></span>
<span id="cb61-807"><a href="#cb61-807" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(func_dist), audpc_gap) <span class="sc">%&gt;%</span></span>
<span id="cb61-808"><a href="#cb61-808" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb61-809"><a href="#cb61-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-810"><a href="#cb61-810" aria-hidden="true" tabindex="-1"></a>idD1 <span class="ot">&lt;-</span> best_D<span class="sc">$</span>curve_id.x</span>
<span id="cb61-811"><a href="#cb61-811" aria-hidden="true" tabindex="-1"></a>idD2 <span class="ot">&lt;-</span> best_D<span class="sc">$</span>curve_id.y</span>
<span id="cb61-812"><a href="#cb61-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-813"><a href="#cb61-813" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-814"><a href="#cb61-814" aria-hidden="true" tabindex="-1"></a><span class="co"># Outputs you likely want</span></span>
<span id="cb61-815"><a href="#cb61-815" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-816"><a href="#cb61-816" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb61-817"><a href="#cb61-817" aria-hidden="true" tabindex="-1"></a>  <span class="at">best_A =</span> best_A,</span>
<span id="cb61-818"><a href="#cb61-818" aria-hidden="true" tabindex="-1"></a>  <span class="at">best_B =</span> best_B,</span>
<span id="cb61-819"><a href="#cb61-819" aria-hidden="true" tabindex="-1"></a>  <span class="at">best_C =</span> best_C,</span>
<span id="cb61-820"><a href="#cb61-820" aria-hidden="true" tabindex="-1"></a>  <span class="at">best_D =</span> best_D,</span>
<span id="cb61-821"><a href="#cb61-821" aria-hidden="true" tabindex="-1"></a>  <span class="at">ids =</span> <span class="fu">list</span>(<span class="at">A =</span> <span class="fu">c</span>(idA1, idA2),</span>
<span id="cb61-822"><a href="#cb61-822" aria-hidden="true" tabindex="-1"></a>             <span class="at">B =</span> <span class="fu">c</span>(idB1, idB2),</span>
<span id="cb61-823"><a href="#cb61-823" aria-hidden="true" tabindex="-1"></a>             <span class="at">C =</span> <span class="fu">c</span>(idC1, idC2),</span>
<span id="cb61-824"><a href="#cb61-824" aria-hidden="true" tabindex="-1"></a>             <span class="at">D =</span> <span class="fu">c</span>(idD1, idD2))</span>
<span id="cb61-825"><a href="#cb61-825" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-826"><a href="#cb61-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-827"><a href="#cb61-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-828"><a href="#cb61-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-829"><a href="#cb61-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-830"><a href="#cb61-830" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-831"><a href="#cb61-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-832"><a href="#cb61-832" aria-hidden="true" tabindex="-1"></a><span class="fu">### Plot the two raw curves</span></span>
<span id="cb61-833"><a href="#cb61-833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-836"><a href="#cb61-836" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-837"><a href="#cb61-837" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: killer-plot-raw</span></span>
<span id="cb61-838"><a href="#cb61-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-839"><a href="#cb61-839" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb61-840"><a href="#cb61-840" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb61-841"><a href="#cb61-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-842"><a href="#cb61-842" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-843"><a href="#cb61-843" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot helper (consistent styling)</span></span>
<span id="cb61-844"><a href="#cb61-844" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-845"><a href="#cb61-845" aria-hidden="true" tabindex="-1"></a>plot_two_curves <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, dfS, id1, id2, panel_title,</span>
<span id="cb61-846"><a href="#cb61-846" aria-hidden="true" tabindex="-1"></a>                            <span class="at">letter =</span> <span class="cn">NULL</span>, <span class="at">t_grid =</span> <span class="cn">NULL</span>, <span class="at">func_dist =</span> <span class="cn">NULL</span>){</span>
<span id="cb61-847"><a href="#cb61-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-848"><a href="#cb61-848" aria-hidden="true" tabindex="-1"></a>  <span class="co"># guards: fail fast with clear message</span></span>
<span id="cb61-849"><a href="#cb61-849" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(dat, <span class="fu">c</span>(<span class="st">"data.frame"</span>, <span class="st">"tbl_df"</span>, <span class="st">"tbl"</span>))) {</span>
<span id="cb61-850"><a href="#cb61-850" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"`dat` must be a data.frame/tibble. class(dat) = "</span>,</span>
<span id="cb61-851"><a href="#cb61-851" aria-hidden="true" tabindex="-1"></a>         <span class="fu">paste</span>(<span class="fu">class</span>(dat), <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb61-852"><a href="#cb61-852" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb61-853"><a href="#cb61-853" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(dfS, <span class="fu">c</span>(<span class="st">"data.frame"</span>, <span class="st">"tbl_df"</span>, <span class="st">"tbl"</span>))) {</span>
<span id="cb61-854"><a href="#cb61-854" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"`dfS` must be a data.frame/tibble. class(dfS) = "</span>,</span>
<span id="cb61-855"><a href="#cb61-855" aria-hidden="true" tabindex="-1"></a>         <span class="fu">paste</span>(<span class="fu">class</span>(dfS), <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb61-856"><a href="#cb61-856" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb61-857"><a href="#cb61-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-858"><a href="#cb61-858" aria-hidden="true" tabindex="-1"></a>  id1 <span class="ot">&lt;-</span> <span class="fu">as.character</span>(id1)</span>
<span id="cb61-859"><a href="#cb61-859" aria-hidden="true" tabindex="-1"></a>  id2 <span class="ot">&lt;-</span> <span class="fu">as.character</span>(id2)</span>
<span id="cb61-860"><a href="#cb61-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-861"><a href="#cb61-861" aria-hidden="true" tabindex="-1"></a>  plot_pair <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb61-862"><a href="#cb61-862" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">curve_id =</span> <span class="fu">as.character</span>(curve_id)) <span class="sc">%&gt;%</span></span>
<span id="cb61-863"><a href="#cb61-863" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(curve_id <span class="sc">%in%</span> <span class="fu">c</span>(id1, id2)) <span class="sc">%&gt;%</span></span>
<span id="cb61-864"><a href="#cb61-864" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">curve =</span> dplyr<span class="sc">::</span><span class="fu">if_else</span>(curve_id <span class="sc">==</span> id1, <span class="st">"A"</span>, <span class="st">"B"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb61-865"><a href="#cb61-865" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">arrange</span>(curve, DAE)</span>
<span id="cb61-866"><a href="#cb61-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-867"><a href="#cb61-867" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(plot_pair) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb61-868"><a href="#cb61-868" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"No rows found in `dat` for ids: "</span>, id1, <span class="st">" and "</span>, id2)</span>
<span id="cb61-869"><a href="#cb61-869" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb61-870"><a href="#cb61-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-871"><a href="#cb61-871" aria-hidden="true" tabindex="-1"></a>  s1 <span class="ot">&lt;-</span> dfS <span class="sc">%&gt;%</span></span>
<span id="cb61-872"><a href="#cb61-872" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">curve_id =</span> <span class="fu">as.character</span>(curve_id)) <span class="sc">%&gt;%</span></span>
<span id="cb61-873"><a href="#cb61-873" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(curve_id <span class="sc">==</span> id1)</span>
<span id="cb61-874"><a href="#cb61-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-875"><a href="#cb61-875" aria-hidden="true" tabindex="-1"></a>  s2 <span class="ot">&lt;-</span> dfS <span class="sc">%&gt;%</span></span>
<span id="cb61-876"><a href="#cb61-876" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">curve_id =</span> <span class="fu">as.character</span>(curve_id)) <span class="sc">%&gt;%</span></span>
<span id="cb61-877"><a href="#cb61-877" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(curve_id <span class="sc">==</span> id2)</span>
<span id="cb61-878"><a href="#cb61-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-879"><a href="#cb61-879" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(s1) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">nrow</span>(s2) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb61-880"><a href="#cb61-880" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Missing scalar stats in `dfS` for ids: "</span>, id1, <span class="st">" and/or "</span>, id2)</span>
<span id="cb61-881"><a href="#cb61-881" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb61-882"><a href="#cb61-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-883"><a href="#cb61-883" aria-hidden="true" tabindex="-1"></a>  <span class="co"># optional: pull T50 if curve_stats exists</span></span>
<span id="cb61-884"><a href="#cb61-884" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">exists</span>(<span class="st">"curve_stats"</span>, <span class="at">inherits =</span> <span class="cn">TRUE</span>)){</span>
<span id="cb61-885"><a href="#cb61-885" aria-hidden="true" tabindex="-1"></a>    t1 <span class="ot">&lt;-</span> curve_stats <span class="sc">%&gt;%</span></span>
<span id="cb61-886"><a href="#cb61-886" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="fu">as.character</span>(curve_id) <span class="sc">==</span> id1) <span class="sc">%&gt;%</span></span>
<span id="cb61-887"><a href="#cb61-887" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">pull</span>(T50)</span>
<span id="cb61-888"><a href="#cb61-888" aria-hidden="true" tabindex="-1"></a>    t2 <span class="ot">&lt;-</span> curve_stats <span class="sc">%&gt;%</span></span>
<span id="cb61-889"><a href="#cb61-889" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="fu">as.character</span>(curve_id) <span class="sc">==</span> id2) <span class="sc">%&gt;%</span></span>
<span id="cb61-890"><a href="#cb61-890" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">pull</span>(T50)</span>
<span id="cb61-891"><a href="#cb61-891" aria-hidden="true" tabindex="-1"></a>    <span class="co"># you can append t1/t2 to ann if you want (kept commented)</span></span>
<span id="cb61-892"><a href="#cb61-892" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb61-893"><a href="#cb61-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-894"><a href="#cb61-894" aria-hidden="true" tabindex="-1"></a>  <span class="co"># compute functional distance if requested and not supplied</span></span>
<span id="cb61-895"><a href="#cb61-895" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(t_grid) <span class="sc">&amp;&amp;</span> <span class="fu">is.null</span>(func_dist)){</span>
<span id="cb61-896"><a href="#cb61-896" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"interp_curve"</span>, <span class="at">inherits =</span> <span class="cn">TRUE</span>)){</span>
<span id="cb61-897"><a href="#cb61-897" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"`interp_curve()` not found. Define it before calling plot_two_curves()."</span>)</span>
<span id="cb61-898"><a href="#cb61-898" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb61-899"><a href="#cb61-899" aria-hidden="true" tabindex="-1"></a>    dt <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">diff</span>(t_grid))</span>
<span id="cb61-900"><a href="#cb61-900" aria-hidden="true" tabindex="-1"></a>    <span class="co"># IMPORTANT: consistent argument order: interp_curve(dat, t_grid, id)</span></span>
<span id="cb61-901"><a href="#cb61-901" aria-hidden="true" tabindex="-1"></a>    yA <span class="ot">&lt;-</span> <span class="fu">interp_curve</span>(dat, t_grid, id1)</span>
<span id="cb61-902"><a href="#cb61-902" aria-hidden="true" tabindex="-1"></a>    yB <span class="ot">&lt;-</span> <span class="fu">interp_curve</span>(dat, t_grid, id2)</span>
<span id="cb61-903"><a href="#cb61-903" aria-hidden="true" tabindex="-1"></a>    func_dist <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>((yA <span class="sc">-</span> yB)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> dt)</span>
<span id="cb61-904"><a href="#cb61-904" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb61-905"><a href="#cb61-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-906"><a href="#cb61-906" aria-hidden="true" tabindex="-1"></a>  ann <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb61-907"><a href="#cb61-907" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AUDPC  A="</span>, <span class="fu">round</span>(s1<span class="sc">$</span>AUDPC[<span class="dv">1</span>], <span class="dv">2</span>), <span class="st">"  B="</span>, <span class="fu">round</span>(s2<span class="sc">$</span>AUDPC[<span class="dv">1</span>], <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb61-908"><a href="#cb61-908" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Final   A="</span>, <span class="fu">round</span>(s1<span class="sc">$</span>final_sev[<span class="dv">1</span>], <span class="dv">2</span>), <span class="st">"  B="</span>, <span class="fu">round</span>(s2<span class="sc">$</span>final_sev[<span class="dv">1</span>], <span class="dv">2</span>),</span>
<span id="cb61-909"><a href="#cb61-909" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(func_dist)) <span class="fu">paste0</span>(<span class="st">"</span><span class="sc">\n</span><span class="st"> d_F="</span>, <span class="fu">signif</span>(func_dist, <span class="dv">3</span>)) <span class="cf">else</span> <span class="st">""</span></span>
<span id="cb61-910"><a href="#cb61-910" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-911"><a href="#cb61-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-912"><a href="#cb61-912" aria-hidden="true" tabindex="-1"></a>  y_top <span class="ot">&lt;-</span> <span class="fu">max</span>(plot_pair<span class="sc">$</span>y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="fl">1.2</span></span>
<span id="cb61-913"><a href="#cb61-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-914"><a href="#cb61-914" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(plot_pair, <span class="fu">aes</span>(DAE, y, <span class="at">color =</span> curve)) <span class="sc">+</span></span>
<span id="cb61-915"><a href="#cb61-915" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.75</span>, <span class="at">size =</span> <span class="fl">1.8</span>) <span class="sc">+</span></span>
<span id="cb61-916"><a href="#cb61-916" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb61-917"><a href="#cb61-917" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_grey</span>(<span class="at">start =</span> <span class="fl">0.15</span>, <span class="at">end =</span> <span class="fl">0.65</span>) <span class="sc">+</span></span>
<span id="cb61-918"><a href="#cb61-918" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"label"</span>,</span>
<span id="cb61-919"><a href="#cb61-919" aria-hidden="true" tabindex="-1"></a>             <span class="at">x =</span> <span class="fu">min</span>(plot_pair<span class="sc">$</span>DAE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> <span class="dv">2</span>,</span>
<span id="cb61-920"><a href="#cb61-920" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> y_top <span class="sc">-</span> <span class="fl">0.1</span>,</span>
<span id="cb61-921"><a href="#cb61-921" aria-hidden="true" tabindex="-1"></a>             <span class="at">label =</span> ann,</span>
<span id="cb61-922"><a href="#cb61-922" aria-hidden="true" tabindex="-1"></a>             <span class="at">hjust =</span> <span class="dv">0</span>,</span>
<span id="cb61-923"><a href="#cb61-923" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="fl">3.2</span>,</span>
<span id="cb61-924"><a href="#cb61-924" aria-hidden="true" tabindex="-1"></a>             <span class="at">label.size =</span> <span class="fl">0.25</span>,</span>
<span id="cb61-925"><a href="#cb61-925" aria-hidden="true" tabindex="-1"></a>             <span class="at">fill =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb61-926"><a href="#cb61-926" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb61-927"><a href="#cb61-927" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> panel_title,</span>
<span id="cb61-928"><a href="#cb61-928" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Days after emergence (DAE)"</span>,</span>
<span id="cb61-929"><a href="#cb61-929" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Disease severity (proportion)"</span>,</span>
<span id="cb61-930"><a href="#cb61-930" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">"Curve"</span></span>
<span id="cb61-931"><a href="#cb61-931" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb61-932"><a href="#cb61-932" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, y_top)) <span class="sc">+</span></span>
<span id="cb61-933"><a href="#cb61-933" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb61-934"><a href="#cb61-934" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb61-935"><a href="#cb61-935" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb61-936"><a href="#cb61-936" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb61-937"><a href="#cb61-937" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="dv">6</span>, <span class="dv">6</span>, <span class="dv">6</span>, <span class="dv">6</span>)</span>
<span id="cb61-938"><a href="#cb61-938" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-939"><a href="#cb61-939" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-940"><a href="#cb61-940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-941"><a href="#cb61-941" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-942"><a href="#cb61-942" aria-hidden="true" tabindex="-1"></a><span class="co"># Build 4 panels</span></span>
<span id="cb61-943"><a href="#cb61-943" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-944"><a href="#cb61-944" aria-hidden="true" tabindex="-1"></a>pD <span class="ot">&lt;-</span> <span class="fu">plot_two_curves</span>(dat, dfS, idA1, idA2,</span>
<span id="cb61-945"><a href="#cb61-945" aria-hidden="true" tabindex="-1"></a>                      <span class="at">panel_title =</span> <span class="st">"Similar AUPDC &amp; final Severity, trajectory-distinct"</span>,</span>
<span id="cb61-946"><a href="#cb61-946" aria-hidden="true" tabindex="-1"></a>                      <span class="at">t_grid =</span> t_grid)</span>
<span id="cb61-947"><a href="#cb61-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-948"><a href="#cb61-948" aria-hidden="true" tabindex="-1"></a>pA <span class="ot">&lt;-</span> <span class="fu">plot_two_curves</span>(dat, dfS, idB1, idB2,</span>
<span id="cb61-949"><a href="#cb61-949" aria-hidden="true" tabindex="-1"></a>                      <span class="at">panel_title =</span> <span class="st">"AUDPC discriminates epidemics"</span>,</span>
<span id="cb61-950"><a href="#cb61-950" aria-hidden="true" tabindex="-1"></a>                      <span class="at">t_grid =</span> t_grid,</span>
<span id="cb61-951"><a href="#cb61-951" aria-hidden="true" tabindex="-1"></a>                      <span class="at">func_dist =</span> best_B<span class="sc">$</span>func_dist)</span>
<span id="cb61-952"><a href="#cb61-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-953"><a href="#cb61-953" aria-hidden="true" tabindex="-1"></a>pB <span class="ot">&lt;-</span> <span class="fu">plot_two_curves</span>(dat, dfS, idC1, idC2,</span>
<span id="cb61-954"><a href="#cb61-954" aria-hidden="true" tabindex="-1"></a>                      <span class="at">panel_title =</span> <span class="st">"Same final severity, different AUDPC"</span>,</span>
<span id="cb61-955"><a href="#cb61-955" aria-hidden="true" tabindex="-1"></a>                      <span class="at">t_grid =</span> t_grid,</span>
<span id="cb61-956"><a href="#cb61-956" aria-hidden="true" tabindex="-1"></a>                      <span class="at">func_dist =</span> best_C<span class="sc">$</span>func_dist)</span>
<span id="cb61-957"><a href="#cb61-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-958"><a href="#cb61-958" aria-hidden="true" tabindex="-1"></a>pC <span class="ot">&lt;-</span> <span class="fu">plot_two_curves</span>(dat, dfS, idD1, idD2,</span>
<span id="cb61-959"><a href="#cb61-959" aria-hidden="true" tabindex="-1"></a>                      <span class="at">panel_title =</span> <span class="st">"Similar AUDPC, trajectory-distinct"</span>,</span>
<span id="cb61-960"><a href="#cb61-960" aria-hidden="true" tabindex="-1"></a>                      <span class="at">t_grid =</span> t_grid,</span>
<span id="cb61-961"><a href="#cb61-961" aria-hidden="true" tabindex="-1"></a>                      <span class="at">func_dist =</span> best_D<span class="sc">$</span>func_dist)</span>
<span id="cb61-962"><a href="#cb61-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-963"><a href="#cb61-963" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-964"><a href="#cb61-964" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine into 2x2 and tag A–D</span></span>
<span id="cb61-965"><a href="#cb61-965" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------</span></span>
<span id="cb61-966"><a href="#cb61-966" aria-hidden="true" tabindex="-1"></a>fig1_panel <span class="ot">&lt;-</span> (pA <span class="sc">|</span> pB) <span class="sc">/</span> (pC <span class="sc">|</span> pD) <span class="sc">+</span></span>
<span id="cb61-967"><a href="#cb61-967" aria-hidden="true" tabindex="-1"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(<span class="at">tag_levels =</span> <span class="st">"A"</span>) <span class="sc">+</span></span>
<span id="cb61-968"><a href="#cb61-968" aria-hidden="true" tabindex="-1"></a>  patchwork<span class="sc">::</span><span class="fu">plot_layout</span>(<span class="at">guides =</span> <span class="st">"collect"</span>) <span class="sc">&amp;</span></span>
<span id="cb61-969"><a href="#cb61-969" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb61-970"><a href="#cb61-970" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb61-971"><a href="#cb61-971" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.direction =</span> <span class="st">"horizontal"</span></span>
<span id="cb61-972"><a href="#cb61-972" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-973"><a href="#cb61-973" aria-hidden="true" tabindex="-1"></a>fig1_panel</span>
<span id="cb61-974"><a href="#cb61-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-975"><a href="#cb61-975" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">"Fig1.png"</span>, <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb61-976"><a href="#cb61-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-977"><a href="#cb61-977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-978"><a href="#cb61-978" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-979"><a href="#cb61-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-980"><a href="#cb61-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-981"><a href="#cb61-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-982"><a href="#cb61-982" aria-hidden="true" tabindex="-1"></a><span class="fu">## Traditional AUDPC analysis (mixed model + Tukey)</span></span>
<span id="cb61-983"><a href="#cb61-983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-984"><a href="#cb61-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-985"><a href="#cb61-985" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb61-986"><a href="#cb61-986" aria-hidden="true" tabindex="-1"></a>audpc_df <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Ambiente, Hibrido) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">AUDPC =</span> ..., <span class="at">.groups=</span><span class="st">"drop"</span>)</span>
<span id="cb61-987"><a href="#cb61-987" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-988"><a href="#cb61-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-989"><a href="#cb61-989" aria-hidden="true" tabindex="-1"></a>This is appropriate if (a) <span class="in">`Parcela`</span> is not a true replication factor, or (b) you intentionally aggregate within environment. If you do have plot-level replication and want plot-level inference, compute AUDPC by <span class="in">`Ambiente × Hibrido × Parcela`</span> and fit a corresponding mixed model.</span>
<span id="cb61-990"><a href="#cb61-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-991"><a href="#cb61-991" aria-hidden="true" tabindex="-1"></a><span class="fu">### Compute AUDPC and fit model</span></span>
<span id="cb61-992"><a href="#cb61-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-995"><a href="#cb61-995" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-996"><a href="#cb61-996" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: audpc-model</span></span>
<span id="cb61-997"><a href="#cb61-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-998"><a href="#cb61-998" aria-hidden="true" tabindex="-1"></a>audpc_df <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span></span>
<span id="cb61-999"><a href="#cb61-999" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Ambiente, Hibrido) <span class="sc">%&gt;%</span></span>
<span id="cb61-1000"><a href="#cb61-1000" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">AUDPC =</span> pracma<span class="sc">::</span><span class="fu">trapz</span>(DAE, y), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb61-1001"><a href="#cb61-1001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1002"><a href="#cb61-1002" aria-hidden="true" tabindex="-1"></a>audpc_df2 <span class="ot">&lt;-</span> audpc_df <span class="sc">%&gt;%</span></span>
<span id="cb61-1003"><a href="#cb61-1003" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb61-1004"><a href="#cb61-1004" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ambiente =</span> <span class="fu">factor</span>(Ambiente),</span>
<span id="cb61-1005"><a href="#cb61-1005" aria-hidden="true" tabindex="-1"></a>    <span class="at">Hibrido  =</span> <span class="fu">factor</span>(Hibrido),</span>
<span id="cb61-1006"><a href="#cb61-1006" aria-hidden="true" tabindex="-1"></a>    <span class="at">AUDPC    =</span> <span class="fu">as.numeric</span>(AUDPC)</span>
<span id="cb61-1007"><a href="#cb61-1007" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb61-1008"><a href="#cb61-1008" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(AUDPC))</span>
<span id="cb61-1009"><a href="#cb61-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1010"><a href="#cb61-1010" aria-hidden="true" tabindex="-1"></a><span class="co"># Mixed model: random intercept for Ambiente (as in your earlier block)</span></span>
<span id="cb61-1011"><a href="#cb61-1011" aria-hidden="true" tabindex="-1"></a>m_audpc <span class="ot">&lt;-</span> <span class="fu">lmer</span>(AUDPC <span class="sc">~</span> Hibrido <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> Ambiente), <span class="at">data =</span> audpc_df2)</span>
<span id="cb61-1012"><a href="#cb61-1012" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(m_audpc)</span>
<span id="cb61-1013"><a href="#cb61-1013" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-1014"><a href="#cb61-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1015"><a href="#cb61-1015" aria-hidden="true" tabindex="-1"></a><span class="fu">### Model checks (DHARMa)</span></span>
<span id="cb61-1016"><a href="#cb61-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1019"><a href="#cb61-1019" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-1020"><a href="#cb61-1020" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: audpc-diagnostics</span></span>
<span id="cb61-1021"><a href="#cb61-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1022"><a href="#cb61-1022" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb61-1023"><a href="#cb61-1023" aria-hidden="true" tabindex="-1"></a>res_a <span class="ot">&lt;-</span> <span class="fu">simulateResiduals</span>(m_audpc, <span class="at">n =</span> <span class="dv">2000</span>)</span>
<span id="cb61-1024"><a href="#cb61-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1025"><a href="#cb61-1025" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(res_a)</span>
<span id="cb61-1026"><a href="#cb61-1026" aria-hidden="true" tabindex="-1"></a><span class="fu">testUniformity</span>(res_a)</span>
<span id="cb61-1027"><a href="#cb61-1027" aria-hidden="true" tabindex="-1"></a><span class="fu">testDispersion</span>(res_a)</span>
<span id="cb61-1028"><a href="#cb61-1028" aria-hidden="true" tabindex="-1"></a><span class="fu">testOutliers</span>(res_a)</span>
<span id="cb61-1029"><a href="#cb61-1029" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-1030"><a href="#cb61-1030" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1031"><a href="#cb61-1031" aria-hidden="true" tabindex="-1"></a><span class="fu">### Hybrid means + Tukey letters</span></span>
<span id="cb61-1032"><a href="#cb61-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1035"><a href="#cb61-1035" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-1036"><a href="#cb61-1036" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: audpc-tukey</span></span>
<span id="cb61-1037"><a href="#cb61-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1038"><a href="#cb61-1038" aria-hidden="true" tabindex="-1"></a>emm_h <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(m_audpc, <span class="sc">~</span> Hibrido)</span>
<span id="cb61-1039"><a href="#cb61-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1040"><a href="#cb61-1040" aria-hidden="true" tabindex="-1"></a>cld_res <span class="ot">&lt;-</span> multcomp<span class="sc">::</span><span class="fu">cld</span>(</span>
<span id="cb61-1041"><a href="#cb61-1041" aria-hidden="true" tabindex="-1"></a>  emm_h,</span>
<span id="cb61-1042"><a href="#cb61-1042" aria-hidden="true" tabindex="-1"></a>  <span class="at">Letters =</span> letters,</span>
<span id="cb61-1043"><a href="#cb61-1043" aria-hidden="true" tabindex="-1"></a>  <span class="at">adjust  =</span> <span class="st">"tukey"</span></span>
<span id="cb61-1044"><a href="#cb61-1044" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-1045"><a href="#cb61-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1046"><a href="#cb61-1046" aria-hidden="true" tabindex="-1"></a>audpc_groups <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(cld_res) <span class="sc">%&gt;%</span></span>
<span id="cb61-1047"><a href="#cb61-1047" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb61-1048"><a href="#cb61-1048" aria-hidden="true" tabindex="-1"></a>    Hibrido,</span>
<span id="cb61-1049"><a href="#cb61-1049" aria-hidden="true" tabindex="-1"></a>    emmean,</span>
<span id="cb61-1050"><a href="#cb61-1050" aria-hidden="true" tabindex="-1"></a>    SE,</span>
<span id="cb61-1051"><a href="#cb61-1051" aria-hidden="true" tabindex="-1"></a>    df,</span>
<span id="cb61-1052"><a href="#cb61-1052" aria-hidden="true" tabindex="-1"></a>    lower.CL,</span>
<span id="cb61-1053"><a href="#cb61-1053" aria-hidden="true" tabindex="-1"></a>    upper.CL,</span>
<span id="cb61-1054"><a href="#cb61-1054" aria-hidden="true" tabindex="-1"></a>    <span class="at">.group =</span> stringr<span class="sc">::</span><span class="fu">str_squish</span>(.group)</span>
<span id="cb61-1055"><a href="#cb61-1055" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb61-1056"><a href="#cb61-1056" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(emmean)</span>
<span id="cb61-1057"><a href="#cb61-1057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1058"><a href="#cb61-1058" aria-hidden="true" tabindex="-1"></a>audpc_groups</span>
<span id="cb61-1059"><a href="#cb61-1059" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-1060"><a href="#cb61-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1061"><a href="#cb61-1061" aria-hidden="true" tabindex="-1"></a><span class="fu">### Merge Tukey groups with functional clusters</span></span>
<span id="cb61-1062"><a href="#cb61-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1065"><a href="#cb61-1065" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-1066"><a href="#cb61-1066" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: audpc-merge-functional</span></span>
<span id="cb61-1067"><a href="#cb61-1067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1068"><a href="#cb61-1068" aria-hidden="true" tabindex="-1"></a>final_compare <span class="ot">&lt;-</span> audpc_groups <span class="sc">%&gt;%</span></span>
<span id="cb61-1069"><a href="#cb61-1069" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb61-1070"><a href="#cb61-1070" aria-hidden="true" tabindex="-1"></a>    cluster_table2 <span class="sc">%&gt;%</span> <span class="fu">select</span>(Hibrido, cluster, phenotype),</span>
<span id="cb61-1071"><a href="#cb61-1071" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"Hibrido"</span></span>
<span id="cb61-1072"><a href="#cb61-1072" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb61-1073"><a href="#cb61-1073" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(emmean)</span>
<span id="cb61-1074"><a href="#cb61-1074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1075"><a href="#cb61-1075" aria-hidden="true" tabindex="-1"></a>final_compare</span>
<span id="cb61-1076"><a href="#cb61-1076" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-1077"><a href="#cb61-1077" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1078"><a href="#cb61-1078" aria-hidden="true" tabindex="-1"></a><span class="fu">### Plot: AUDPC means, CI, Tukey letters (colored by functional phenotype)</span></span>
<span id="cb61-1079"><a href="#cb61-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1082"><a href="#cb61-1082" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-1083"><a href="#cb61-1083" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: audpc-plot</span></span>
<span id="cb61-1084"><a href="#cb61-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1085"><a href="#cb61-1085" aria-hidden="true" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> final_compare <span class="sc">%&gt;%</span></span>
<span id="cb61-1086"><a href="#cb61-1086" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb61-1087"><a href="#cb61-1087" aria-hidden="true" tabindex="-1"></a>    <span class="at">hybrid_short =</span> <span class="fu">shorten_hybrid</span>(Hibrido),</span>
<span id="cb61-1088"><a href="#cb61-1088" aria-hidden="true" tabindex="-1"></a>    <span class="at">cluster =</span> <span class="fu">factor</span>(cluster)</span>
<span id="cb61-1089"><a href="#cb61-1089" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-1090"><a href="#cb61-1090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1091"><a href="#cb61-1091" aria-hidden="true" tabindex="-1"></a>cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#D55E00"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#009E73"</span>, <span class="st">"#CC79A7"</span>)[<span class="dv">1</span><span class="sc">:</span>k_clusters]</span>
<span id="cb61-1092"><a href="#cb61-1092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1093"><a href="#cb61-1093" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_df,</span>
<span id="cb61-1094"><a href="#cb61-1094" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">reorder</span>(hybrid_short, emmean),</span>
<span id="cb61-1095"><a href="#cb61-1095" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> emmean,</span>
<span id="cb61-1096"><a href="#cb61-1096" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> cluster)) <span class="sc">+</span></span>
<span id="cb61-1097"><a href="#cb61-1097" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb61-1098"><a href="#cb61-1098" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> cols) <span class="sc">+</span></span>
<span id="cb61-1099"><a href="#cb61-1099" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> lower.CL, <span class="at">xmax =</span> upper.CL), <span class="at">height =</span> <span class="fl">0.12</span>) <span class="sc">+</span></span>
<span id="cb61-1100"><a href="#cb61-1100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> .group), <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb61-1101"><a href="#cb61-1101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb61-1102"><a href="#cb61-1102" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"AUDPC"</span>,</span>
<span id="cb61-1103"><a href="#cb61-1103" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Hybrid"</span>,</span>
<span id="cb61-1104"><a href="#cb61-1104" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Functional phenotype"</span>,</span>
<span id="cb61-1105"><a href="#cb61-1105" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="cn">NULL</span></span>
<span id="cb61-1106"><a href="#cb61-1106" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb61-1107"><a href="#cb61-1107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb61-1108"><a href="#cb61-1108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="fu">min</span>(plot_df<span class="sc">$</span>lower.CL), <span class="fu">max</span>(plot_df<span class="sc">$</span>upper.CL) <span class="sc">*</span> <span class="fl">1.10</span>))</span>
<span id="cb61-1109"><a href="#cb61-1109" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-1110"><a href="#cb61-1110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1111"><a href="#cb61-1111" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb61-1112"><a href="#cb61-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1113"><a href="#cb61-1113" aria-hidden="true" tabindex="-1"></a><span class="fu">## Optional: run `compare_curves()` from `{r4pde}`</span></span>
<span id="cb61-1114"><a href="#cb61-1114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1115"><a href="#cb61-1115" aria-hidden="true" tabindex="-1"></a>This section reproduces your final call, assuming <span class="in">`{r4pde}`</span> is installed and your <span class="in">`dat`</span> object matches the required schema.</span>
<span id="cb61-1116"><a href="#cb61-1116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1119"><a href="#cb61-1119" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-1120"><a href="#cb61-1120" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: r4pde-compare-curves</span></span>
<span id="cb61-1121"><a href="#cb61-1121" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb61-1122"><a href="#cb61-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1123"><a href="#cb61-1123" aria-hidden="true" tabindex="-1"></a><span class="co">#pak::pkg_install("emdelponte/r4pde")</span></span>
<span id="cb61-1124"><a href="#cb61-1124" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(r4pde)</span>
<span id="cb61-1125"><a href="#cb61-1125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1126"><a href="#cb61-1126" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">compare_curves</span>(</span>
<span id="cb61-1127"><a href="#cb61-1127" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat,</span>
<span id="cb61-1128"><a href="#cb61-1128" aria-hidden="true" tabindex="-1"></a>  <span class="at">time =</span> <span class="st">"DAE"</span>,</span>
<span id="cb61-1129"><a href="#cb61-1129" aria-hidden="true" tabindex="-1"></a>  <span class="at">response =</span> <span class="st">"y"</span>,</span>
<span id="cb61-1130"><a href="#cb61-1130" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment =</span> <span class="st">"Hibrido"</span>,</span>
<span id="cb61-1131"><a href="#cb61-1131" aria-hidden="true" tabindex="-1"></a>  <span class="at">environment =</span> <span class="st">"Ambiente"</span>,</span>
<span id="cb61-1132"><a href="#cb61-1132" aria-hidden="true" tabindex="-1"></a>  <span class="at">test_factor =</span> <span class="st">"resistance"</span>,</span>
<span id="cb61-1133"><a href="#cb61-1133" aria-hidden="true" tabindex="-1"></a>  <span class="at">perm_unit =</span> <span class="st">"Hibrido"</span>,</span>
<span id="cb61-1134"><a href="#cb61-1134" aria-hidden="true" tabindex="-1"></a>  <span class="at">perm_strata =</span> <span class="st">"Ambiente"</span>,</span>
<span id="cb61-1135"><a href="#cb61-1135" aria-hidden="true" tabindex="-1"></a>  <span class="at">test_mode =</span> <span class="st">"global"</span>,</span>
<span id="cb61-1136"><a href="#cb61-1136" aria-hidden="true" tabindex="-1"></a>  <span class="at">bootstrap =</span> <span class="cn">TRUE</span>,</span>
<span id="cb61-1137"><a href="#cb61-1137" aria-hidden="true" tabindex="-1"></a>  <span class="at">boot_B =</span> <span class="dv">399</span></span>
<span id="cb61-1138"><a href="#cb61-1138" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-1139"><a href="#cb61-1139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1140"><a href="#cb61-1140" aria-hidden="true" tabindex="-1"></a>m1</span>
<span id="cb61-1141"><a href="#cb61-1141" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m1)</span>
<span id="cb61-1142"><a href="#cb61-1142" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_curves</span>(m1)</span>
<span id="cb61-1143"><a href="#cb61-1143" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_dendrogram</span>(m1)</span>
<span id="cb61-1144"><a href="#cb61-1144" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-1145"><a href="#cb61-1145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1146"><a href="#cb61-1146" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb61-1147"><a href="#cb61-1147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1148"><a href="#cb61-1148" aria-hidden="true" tabindex="-1"></a><span class="fu">## Session info</span></span>
<span id="cb61-1149"><a href="#cb61-1149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-1152"><a href="#cb61-1152" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb61-1153"><a href="#cb61-1153" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: session-info</span></span>
<span id="cb61-1154"><a href="#cb61-1154" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb61-1155"><a href="#cb61-1155" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>